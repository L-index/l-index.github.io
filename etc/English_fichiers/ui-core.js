module({"@IMQ":"@IMQ"},function(v){var h=function(e){return IMVU.NamedView.extend("UiView",{initialize:function(a){IMVU.NamedView.prototype.initialize.call(this,a);this.__serviceProvider=a.serviceProvider;this.__$parentElement=a.$parentElement;this.__$replaceElement=a.$replaceElement;this.__$prependElement=a.$prependElement},"delete":function(){this.remove()},addToDOM:function(){var a=this.__$parentElement||this.__$replaceElement||this.__$prependElement||void 0;if(!a)throw new ReferenceError("Please provide $parentElement or $replaceElement or $prependElement to attach presenter's element to the DOM.");
if(!a.length)throw a="$parentElement",this.__$replaceElement?a="$replaceElement":this.__$prependElement&&(a="$prependElement"),Error("Cannot attach element to the DOM, provided "+a+" does not exist.");this.__$parentElement?(this.preRender(this.__$parentElement,"append"),this.__$parentElement.append(this.$el)):this.__$replaceElement?(this.preRender(this.__$replaceElement,"replace"),this.__$replaceElement.replaceWith(this.$el)):this.__$prependElement&&(this.preRender(this.__$prependElement,"prepend"),
this.__$prependElement.prepend(this.$el));this.render()},preRender:function(a,b){},showPostRender:function(){}})}({}),m=function(e){var a=e.UiView,b=function(b){for(var c=this,l=function(a){this["__"+a]=this["__"+a]||b[a]}.bind(this);c&&c.constructor!==a;)_.each(c.dependencies,l),c=Object.getPrototypeOf(c)},c=a.extend("UiContext",{dependencies:["modelCache"],contentAreas:{},"static extend":function(a,b,c){b=b||{};if(_.has(b,"events"))throw new ReferenceError('Do not use the "events" object, please pass "trackedEvents" function that returns an array of objects.');
return IMVU.BaseClass.extend.apply(this,arguments)},initialize:function(d){b.call(this,d);a.prototype.initialize.call(this,d);this.__childContexts=[];this.__trackedModels=[];this.__useEventWhitelist=IMVU.optionalProperty(d.serviceProvider.services,"useEventWhitelist",!1);this.__recordShown=!this.__useEventWhitelist||this.__recordShown;this.__recordHidden=!this.__useEventWhitelist||this.__recordHidden;this.setParentUiContext(d.parentUiContext);if(this.uiAttributes&&!this.hasOwnProperty("uiAttributes"))throw Error("Do not define uiAttributes statically.");
this.on("shown",this.__onShown);this.on("hidden",this.__onHidden)},"delete":function(){this.__deleted||(this.__parentUiContext&&this.__parentUiContext.removeChildContext(this),_.each(this.__childContexts,function(a,b){a["delete"]()}.bind(this)),this.__childContexts=[],this.__deleted=!0,a.prototype["delete"].call(this),this.trigger("hidden"),this.undelegateEvents(),this.off())},setContent:function(a,b,l){var g=this.__getContentAreaSelector(a);if(!g)throw new TypeError("Content area does not exist: "+
a);a=this.$(g);if(b.prototype instanceof c)return this.createChildContext(b,_.extend(l||{},{$parentElement:a}));b instanceof Function?a.append(b(l)):a.append(b)},__getContentAreaSelector:function(a){for(var b=this,c=null;b&&!c;){if(b.hasOwnProperty("contentAreas")&&b.contentAreas[a]){c=b.contentAreas[a];break}b=Object.getPrototypeOf(b)}return c},getParentUiContext:function(){return this.__parentUiContext},setParentUiContext:function(a){this.__parentUiContext=a},isDeleted:function(){return!!this.__deleted},
addToDOM:function(){a.prototype.addToDOM.call(this);this.trigger("shown")},preRender:function(b,c){a.prototype.preRender.call(this,b,c);if(this.__parentUiContext&&!this.__parentUiContext.$el.is(b)&&!this.__parentUiContext.$el.has(b).length)throw Error("ChildContext's $parentElement or $replaceElement or $prependElement is outside of its parentUiContext's $el.");},hide:function(){this.$el.hide();this.trigger("hidden")},show:function(){this.$el.show();this.trigger("shown")},children:function(){return this.__childContexts},
createChildContext:function(a,b){b=b||{};b.parentUiContext=this;var c=this.__serviceProvider.create(a,b);this.__childContexts.push(c);return c},removeChildContext:function(a){this.__childContexts=_.without(this.__childContexts,a)},track:function(a,b){if(-1!==_.findIndex(this.__trackedModels,function(b){return b.model===a}))return a;this.__trackedModels.push({model:a,hints:b});this.__isShown&&(void 0===b?this.__modelCache.activate(a):this.__modelCache.activate(this,a,b));return a},untrack:function(a){var b=
_.findIndex(this.__trackedModels,function(b){return b.model===a});-1!==b&&(this.__trackedModels.splice(b,1),this.__modelCache.deactivate(a))},__getUiContext:function(a){if(_.isUndefined(this.uiContextName))throw Error("UiContext must define uiContextName");if("string"!==typeof this.uiContextName)throw Error("uiContextName ("+IMVU.repr(this.uiContextName)+") must be a string.");this.__validateName(this.uiContextName);return this.uiContextName+(a?"."+a:"")},__validateName:function(a){if(-1===a.search(/^[a-z|_|0-9]+$/))throw Error('UiContext invalid identifier: "'+
a+'".  Use only lowercase letters and underscores.');},__getUiApplication:function(){if(_.isUndefined(this.uiApplication))throw Error("Top-level UiContext must define uiApplication");return this.uiApplication},__getUiPlatform:function(){return _.isUndefined(this.uiPlatform)?"default":this.uiPlatform},__getUiAttributes:function(a){_.each(this.uiAttributes,function(b,c){_.isUndefined(a[c])&&(a[c]=b)});return a},trackedEvents:function(){return[]},isShown:function(){return this.__isShown},events:function(){var a=
{};_.each(this.trackedEvents(),function(b){var c=b.type;_.isUndefined(b.selector)||(c+=" "+b.selector);a[c]=function(a){if(!b.name)throw Error("trackedEvent needs a name: "+JSON.stringify(b));var c=$(a.currentTarget);if(c.hasClass("selected")||c.is(":selected")||c.is(":disabled"))return!1;var d=b.attributes||{};_.isFunction(d)&&(d=d(c));this.__validateName(b.name);d.name=b.name;d.selector=b.selector;this.__serviceProvider.get("eventBus").trigger(b.type+"_handled");this.__recordEvent(b.type,d);b.allowBubble||
a.stopPropagation();("string"===typeof b.handler?this[b.handler]:b.handler).call(this,a)}.bind(this)}.bind(this));return a},__urlId:function(a){return _.last(a.split("/"))},__parseRGBColor:function(a){a=a.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);delete a[0];for(var b=1;3>=b;++b)a[b]=parseInt(a[b],10).toString(16),a[b]=1===a[b].length?"0"+a[b]:a[b];return"#"+a.join("").toUpperCase()},IGNORED_EVENTS:"scroll mousemove mousein mouseenter mouseout mouseleave mousewheel touchmove keypress keydown keyup".split(" "),
EVENT_WHITELIST:["click","submit","shown","hidden"],__recordEvent:function(a,b,c){if(this.__isShown&&!_.contains(this.IGNORED_EVENTS,a)&&(b=b||{},c=c||"",b=this.__getUiAttributes(b),!this.__useEventWhitelist||b.record||_.contains(this.EVENT_WHITELIST,a))){if("string"!==typeof c)throw Error("subContext ("+IMVU.repr(c)+") must be a string.");_.isUndefined(this.__parentUiContext)?(b.name&&this.__validateName(b.name),delete b.record,this.__serviceProvider.get("uiEventReporter").recordEvent(this.__getUiApplication(),
this.__getUiPlatform(),this.__getUiContext(c),a,b)):this.__parentUiContext.__recordEvent(a,b,this.__getUiContext(c))}},__onShown:function(){this.$el.is(":visible")&&(_.isUndefined(this.__parentUiContext)||this.__parentUiContext.isShown())&&(this.__isShown||_.each(this.__trackedModels,function(a){this.__modelCache.activate(this,a.model,a.hints)}.bind(this)),this.__isShown=!0,this.__recordShown&&this.__recordEvent("shown"),this.__triggerChildContextsShown())},__onHidden:function(){if(this.$el.is(":visible"))throw Error('Tried to trigger a "hidden" event on a *visible* element.');
this.__isShown&&_.each(this.__trackedModels,function(a){this.__modelCache.deactivate(this,a.model)}.bind(this));this.__triggerChildContextsHidden();this.__recordHidden&&this.__recordEvent("hidden");this.__isShown=!1},__triggerChildContextsShown:function(){_.each(this.__childContexts,function(a){a.isShown&&!a.isShown()&&a.trigger("shown")})},__triggerChildContextsHidden:function(){_.each(this.__childContexts,function(a){a.isShown&&a.isShown()&&a.trigger("hidden")})},__triggerChildContexts:function(a){_.each(this.__childContexts,
function(b){b.trigger(a)})}});return c}({UiView:h}),q=function(){return Handlebars.template({compiler:[5,">= 2.0.0"],main:function(e,a,b,c){var d;b=this.escapeExpression;return'<header class="dialog-header">\n    <h3 class="dialog-title">'+b((d=a.title||e&&e.title,"function"===typeof d?d.call(e,{name:"title",hash:{},data:c}):d))+'</h3>\n    <a href="#" class="dialog-x"><span>&times;</span></a>\n</header>\n<section class="dialog-body"></section>'},useData:!0})}({}),q=function(e){return e.UiContext.extend("ModalDialog",
{uiContextName:"modal_dialog_generic",className:"modal-dialog-generic",dependencies:["window","Promise"],hasCloseButton:!0,initialize:function(a){e.UiContext.prototype.initialize.call(this,a);this.serviceProvider=a.serviceProvider;this.dialogManager=a.dialogManager;this.finished=new a.Promise(function(a){this.promiseResolver=a}.bind(this));a=this["delete"].bind(this);this.finished.then(a,a);this.$el.attr("data-ui-role","modal-dialog")},render:function(){this.$el.html(e.template({title:this.title||
""}));this.$(".dialog-x").on("click",this.__onClose.bind(this));this.$(".dialog-x").toggle(this.hasCloseButton);this.postRender();this.__focusPrimaryButton()},show:function(){e.UiContext.prototype.show.call(this);this.__focusPrimaryButton()},__onClose:function(a){a.preventDefault();this.__recordEvent("click",{name:"dialog_close"});this.hide();this.promiseResolver.reject()},__focusPrimaryButton:function(){var a=this.$("button.primary");1<a.length?a.blur():a.first().focus()}})}({UiContext:m,template:q}),
r=function(){return Handlebars.template({compiler:[5,">= 2.0.0"],main:function(e,a,b,c){var d;b=this.escapeExpression;return"<p>"+b((d=a.text||e&&e.text,"function"===typeof d?d.call(e,{name:"text",hash:{},data:c}):d))+'</p>\n           <footer class="dialog-footer">\n                  <button class="btn btn-primary primary" data-confirm="ok">'+b((d=a.ok||e&&e.ok,"function"===typeof d?d.call(e,{name:"ok",hash:{},data:c}):d))+"</button>\n              </footer>\n"},useData:!0})}({}),r=function(e){return e.ModalDialog.extend("AlertDialog",
{uiContextName:"alert_dialog",className:"alert-dialog",trackedEvents:function(){return[{type:"click",selector:'[data-confirm="ok"]',name:"confirm",handler:"__onConfirm"}]},initialize:function(a){this.title=a.title;this.text=a.text;this.ok=a.ok;e.ModalDialog.prototype.initialize.call(this,a);this.addToDOM()},postRender:function(){this.$el.find(".dialog-body").html(e.template({text:this.text,ok:this.ok}))},__onConfirm:function(){this.promiseResolver.accept();this.hide()}})}({ModalDialog:q,template:r}),
w=function(){return{_initSyncing:function(){this._hasData=this._successfulResponseReceived=!1;this._outstandingRequests=0;this._lastResponseError=!1;this._lastResponseErrorContents=void 0;this.on("successfulResponseReceived",function(){this._successfulResponseReceived=!0;this.trigger("populated")},this)},isPopulated:function(){return this._successfulResponseReceived},isSyncing:function(){return 0<this._outstandingRequests},isError:function(){return this._lastResponseError},getError:function(){return this._lastResponseErrorContents},
whenPopulated:function(e,a){if(this._successfulResponseReceived)e.call(a||this,this);else{var b=function(){e.call(a||this,this);this.off("populated",b)};this.on("populated",b)}},_onRequestSent:function(){this._outstandingRequests+=1;1===this._outstandingRequests&&this.trigger("syncing",!0)},_onResponseReceived:function(e,a){this._outstandingRequests-=1;0===this._outstandingRequests&&this.trigger("syncing",!1);e&&this.trigger("successfulResponseReceived");var b=!e;b!==this._lastResponseError&&(this._lastResponseErrorContents=
(this._lastResponseError=b)?a:void 0,this.trigger("error",b,this._lastResponseErrorContents))},_clearState:function(){var e=this._lastResponseError;this._successfulResponseReceived=this._lastResponseError=!1;this._lastResponseErrorContent=void 0;e&&this.trigger("error",!1,void 0)}}}({}),s=function(e){return{makeRequest:function(a,b,c,d,f,e){return a[b].apply(a,void 0===d?[c,f,e]:[c,d,f,e])},flatten:function(a){function b(a,d){var f={};_(d).each(function(d,g){_.isObject(d)&&Object.getPrototypeOf(d)===
Object.prototype?_(f).extend(b(a+g+".",d)):f[a+g]=d});return f}return b("",a)},unflatten:function(a){var b={};_(a).each(function(a,b,f){f=f.split(".");var e=f.pop();f.reduce(function(a,b){void 0===a[b]&&(a[b]={});return a[b]},a)[e]=b}.bind(null,b));return b},arrayUnique:function(a){for(var b={},c=[],d=a.length,f=0,e=0;e<d;e++){var g=a[e];1!==b[g]&&(b[g]=1,c[f++]=g)}return c}}}({}),p=function(e){var a=IMVU.NamedModel.prototype,b=IMVU.NamedModel.extend("RestModel",{dependencies:["rest","Promise","modelCache"],
initialize:function(b,d){a.initialize.apply(this,[b,d]);this.modelCache=d.modelCache;this._lastResponseError=this._successfulResponseReceived=!1;this._outstandingRequests=0;this.clear({silent:!0});this.set(e.RestUtil.flatten(b),{silent:!0});this.rest=IMVU.requireProperty(d,"rest");this.Promise=IMVU.requireProperty(d,"Promise");this._initSyncing()},methodMap:{create:"post",read:"get",update:"post","delete":"delete"},create:function(){throw Error("Do not create via RestModel.  Instead, use a GraphRoot or restModelFactory:createModel()");
},set:function(b){if(_.isObject(b)){var d=[].slice.call(arguments,0);d[0]=e.RestUtil.flatten(d[0]);return a.set.apply(this,d)}return a.set.apply(this,arguments)},sync:function(a,b,f){var l=IMVU.requireProperty(this.methodMap,a),g=f.url||this.url();a=f.data?f.data:"create"===a||"update"===a?b.toJSON():void 0;this._onRequestSent();e.RestUtil.makeRequest(this.rest,l,g,a,f,function(a,c,g,e){void 0===a?(b.id||(b.id=e),f.success(b,c,f)):(a.code=g.status,f.error&&f.error(a,g,f));b._onResponseReceived(void 0===
a,a)})},fetch:function(){this._clearState();a.fetch.apply(this,arguments)},patch:function(a,b){b=b||{};_(b).defaults({success:function(){},error:function(){}});var f={};_(a).each(function(a){f[a]=this.get(a)},this);var l=e.RestUtil.unflatten(f);this.sync("update",this,_(b).extend({data:l}))},save:function(b,d){return new this.Promise(function(f){d=d||{};d.data=b;var e=d.success,g=d.error;d.success=function(a,b,c){e&&e(a,b,c);f.resolve(a)};d.error=function(a,b,c){g&&g(a,b,c);f.reject(a)};a.save.call(this,
b,d)}.bind(this))},parse:function(a,b){if("undefined"===typeof a)return{};var f=this.relations;this.relations=a.relations;this.updates=a.updates;this.trigger("change:relations",f,this.relations);return e.RestUtil.flatten(a.data)},url:function(){return this.id||a.url.call(this)},toJSON:function(){var b=e.RestUtil.unflatten(a.toJSON.call(this));delete b.id;delete b.relations;return b},invalidate:function(){this.modelCache.invalidate(this.id)},release:function(){this.rest.invalidate(this.id);this.modelCache.release(this)},
destroy:function(b){return new this.Promise(function(d){b=b||{};b.wait=_.isUndefined(b.wait)?!0:b.wait;var f=b.success,e=b.error;b.success=function(a,b,c){f&&f(a,b,c);d.resolve()};b.error=function(a,b,c){e&&e(a,b,c);d.reject(a)};a.destroy.call(this,b)}.bind(this))},populated:function(){return new this.Promise(function(a){if(this.isError())a.reject({isError:!0,contents:this.getError()});else{var b=function(f,e){this.off("error",b);a.reject({isError:f,contents:e})}.bind(this);this.on("error",b);this.whenPopulated(function(){this.off("error",
b);a.accept(this)}.bind(this))}}.bind(this))}});_.extend(b.prototype,e.RestSyncingMixin);return b}({RestSyncingMixin:w,RestUtil:s}),F=function(e){var a=e.RestModel.prototype;return function(b){var c;if(!(c=b))throw new ReferenceError("Must specify type");b=c;return e.RestModel.extend("CollectionItemModel",{initialize:function(b,c){this.options=c;a.initialize.call(this,b,c)},data:function(){return this.options.modelCache.get(this.get("data"),b)},"delete":function(a){this.rest["delete"](this.get("id"),
a)}},{modelName:"CollectionItem"})}}({RestModel:p}),t=function(){return Handlebars.template({compiler:[5,">= 2.0.0"],main:function(e,a,b,c){var d;b=this.escapeExpression;return"<p>"+b((d=a.text||e&&e.text,"function"===typeof d?d.call(e,{name:"text",hash:{},data:c}):d))+'</p>\n<footer class="dialog-footer">\n    <button class="btn btn-secondary secondary" data-confirm="no">'+b((d=a.no||e&&e.no,"function"===typeof d?d.call(e,{name:"no",hash:{},data:c}):d))+'</button>\n    <button class="btn btn-primary primary" data-confirm="yes">'+
b((d=a.yes||e&&e.yes,"function"===typeof d?d.call(e,{name:"yes",hash:{},data:c}):d))+"</button>\n</footer>"},useData:!0})}({}),t=function(e){return e.ModalDialog.extend("ConfirmDialog",{uiContextName:"confirm_dialog",className:"confirm-dialog",trackedEvents:function(){return[{type:"click",selector:'[data-confirm="yes"]',name:"confirm",handler:"__onConfirm"},{type:"click",selector:'[data-confirm="no"]',name:"deny",handler:"__onDeny"}]},initialize:function(a){this.title=a.title;this.text=a.text;this.yes=
a.yes;this.no=a.no;e.ModalDialog.prototype.initialize.call(this,a);this.addToDOM()},postRender:function(){this.$el.find(".dialog-body").html(e.template({text:this.text,yes:this.yes,no:this.no}))},__onConfirm:function(){this.promiseResolver.accept();this.hide()},__onDeny:function(){this.promiseResolver.reject();this.hide()}})}({ModalDialog:q,template:t}),G=function(e){return e.UiContext.extend("DialogManager",{uiContextName:"dialog_manager",tagName:"section",className:"dialog-manager",initialize:function(a){e.UiContext.prototype.initialize.call(this,
a);this.$parentElement=a.$parentElement;this.serviceProvider=a.serviceProvider;this.$el.attr("data-ui-role","dialog-manager");this.addToDOM();this.__stack=[]},render:function(){this.$el.html('<div class="transparent-overlay">');this.$container=this.$(".transparent-overlay");this.$el.hide();$("body").append(this.$el)},showDialog:function(a,b){this.__isShown||this.show();var c=this.__createDialog(a,b||{});1<this.__stack.length&&this.__stack[this.__stack.length-2].hide();return c},replaceDialog:function(a,
b){var c=this.showDialog(a,b);if(1<this.__stack.length){var d=this.__stack[this.__stack.length-2];d.promiseResolver.reject();this.__stack=_.without(this.__stack,d)}return c},alert:function(a){return this.showDialog(e.AlertDialog,a)},confirm:function(a){return this.showDialog(e.ConfirmDialog,a)},closeAll:function(){for(var a=this.__stack.length-1;0<=a;a--){var b=this.__stack[a];b.hide();b.promiseResolver.reject()}this.hide();this.__stack=[]},show:function(){e.UiContext.prototype.show.call(this);$("html").addClass("dialog-over")},
hide:function(){this.$parentElement.append(this.$el);$("html").removeClass("dialog-over");e.UiContext.prototype.hide.call(this)},__createDialog:function(a,b){var c=this.createChildContext(a,_(b||{}).extend({$parentElement:this.$container,dialogManager:this}));this.__stack.push(c);c.on("hidden",this.__onDialogHidden.bind(this,c));return c},__onDialogHidden:function(a){_.last(this.__stack)===a&&this.__stack.pop();0===this.__stack.length?this.hide():_.last(this.__stack).show()},isShowingDialog:function(){return 0<
this.__stack.length},"delete":function(){_(this.__stack).each(function(a){a.off()});e.UiContext.prototype["delete"].call(this)},hasFocus:function(){return this.$el.find(document.activeElement).length}})}({UiContext:m,ModalDialog:q,AlertDialog:r,ConfirmDialog:t}),y=function(e){return e.UiContext.extend("ListPresenter",{tagName:"ul",uiContextName:"list_presenter",dependencies:["collection"],initialize:function(a){if(!this.itemFactory)throw Error("Please provide a factory which will be used to create list items.");
e.UiContext.prototype.initialize.call(this,a);this.args=a;this.collection=a.collection;this.__registry={};this.addToDOM();this.$itemContainer=this.$itemContainer||this.$el;this.collection.on("add",this.onAdd,this);this.collection.on("remove",this.onRemove,this);this.collection.on("reset",this.onReset,this);this.collection.on("sort",this.onSort,this);this.onReset()},"delete":function(){this.collection.off("add",this.onAdd,this);this.collection.off("remove",this.onRemove,this);this.collection.off("reset",
this.onReset,this);this.collection.off("sort",this.onSort,this);e.UiContext.prototype["delete"].call(this)},onAdd:function(a,b,c){b=this.createChildContext(this.itemFactory,_(this.args).extend({model:a,$parentElement:this.$itemContainer}));this.args.reverse&&this.$itemContainer.prepend(b.$el);this.__registry[a.cid]=b;b.on("all",function(a,b){"hidden"!==a&&("visible"!==a&&"shown"!==a)&&this.trigger.apply(this,_.map(arguments,function(a,b){return a}))},this)},onRemove:function(a,b,c){b=this.__registry[a.cid];
delete this.__registry[a.cid];b["delete"]()},onReset:function(a,b){var c=[],d=this.__detach(),f=_.clone(this.__registry);_(f).each(function(a,b){if(void 0===this.collection.get({cid:b}))this.onRemove(a.model)},this);this.collection.each(function(a){void 0===this.__registry[a.cid]&&(this.onAdd(a),c.push(a))},this);this.__arrangeAndReattach(d);_.each(c,function(a){this.__registry[a.cid].trigger("shown")}.bind(this))},getContextByModel:function(a){return this.__registry[a.cid]},__detach:function(){var a=
this.el.nextSibling,b=this.el.parentNode;if(b)return b.removeChild(this.el),{parentNode:b,siblingNode:a}},__arrangeAndReattach:function(a){this.collection.each(function(a){this.__registry[a.cid].$el&&(this.args.reverse?this.__registry[a.cid].$el.detach().prependTo(this.$itemContainer):this.__registry[a.cid].$el.detach().appendTo(this.$itemContainer))},this);a&&a.parentNode.insertBefore(this.el,a.siblingNode)},onSort:function(a,b){var c=this.__detach();this.__arrangeAndReattach(c)}})}({UiContext:m}),
H=function(e){var a=e.ListPresenter;return a.extend("EdgeCollectionPresenter",{uiContextName:"edge_collection_presenter",triggerNextPage:5,dependencies:["window","Promise"],initialize:function(b){this.__scroller=b.scroller?$(b.scroller):null;this.__window=b.window;this.__namespace="edgecollectionpresenter_"+b.collection.url.replace(/[\(\)\?\+\*\[\]]/g,"_");a.prototype.initialize.call(this,b)},"delete":function(){a.prototype["delete"].call(this);this.$el.off();this.collection.off(null,null,this);$(this.__scroller).off("scroll."+
this.__namespace)},render:function(){this.$el.addClass("loading");this.__scroller=this.__scroller||this.$el;this.collection.enumerated().then(function(){this.isDeleted()||(this.renderTemplate(),$(this.__scroller).on("scroll."+this.__namespace,this.__onScroll.bind(this)),this.$el.removeClass("loading"),this.collection.on("paged",this.__onPaged,this),this.collection.on("syncing",this.__onSync,this))}.bind(this))["catch"](function(){this.$el.removeClass("loading");this.onInitError()}.bind(this))},__onSync:function(a){!1===
a&&this.__ensureContainerFilled()},onInitError:function(){},renderTemplate:function(){throw Error("renderTemplate() should be implemented");},__ensureContainerFilled:function(){this.__maybePage()},__onScroll:function(){this.__maybePage()},__onPaged:function(){this.$el.removeClass("loading");this.__maybePage()},onPageError:function(a){this.$el.removeClass("loading")},__maybePage:function(){this.__shouldPage()&&this.collection.hasNextPage()&&(this.$el.addClass("loading"),this.__noVisibilityChecks=!0,
this.collection.getNextPage().then(function(){this.__noVisibilityChecks=!1;this.__onPaged()}.bind(this))["catch"](this.onPageError.bind(this)))},__childrenInDOM:function(){var a=_.map(_.filter(_.values(this.__registry),function(a){return a.$el}),function(a){return a.$el[0]});return this.$el.children().filter(a)},__readyToPage:function(){if(!this.__noVisibilityChecks)return this.isDeleted()||this.collection.isSyncing()||!this.$el.is(":visible")?!1:this.__childrenInDOM().length===this.collection.length},
__shouldPage:function(){if(!this.__readyToPage())return!1;var a;a=this.__scroller[0]===this.__window?this.__scroller.scrollTop()+this.__scroller.height():this.__scroller.offset().top+this.__scroller.height();var c=this.$el.children().eq(-this.triggerNextPage);return 0===c.length?!0:c.offset().top<=a},onAdd:function(b,c,d){a.prototype.onAdd.call(this,b,c,d);this.__ensureContainerFilled()},show:function(){a.prototype.show.call(this);this.__ensureContainerFilled()},onReset:function(b,c){this.collection.enumerated().then(function(){a.prototype.onReset.call(this,
b,c);this.__ensureContainerFilled()}.bind(this))},onSort:function(b,c){this.collection.enumerated().then(function(){a.prototype.onSort.call(this,b,c)}.bind(this))}})}({ListPresenter:y}),I=function(e){return e.UiContext.extend("EdgeRefPresenter",{edgePresenterFactory:void 0,nodePresenterFactory:void 0,initialize:function(a){e.UiContext.prototype.initialize.call(this,a);this.addToDOM();this.edgePresenterFactory&&(this.edgePresenter=this.createChildContext(this.edgePresenterFactory,{model:this.model.edge,
$parentElement:this.$el}));this.nodePresenterFactory&&(this.nodePresenter=this.createChildContext(this.nodePresenterFactory,{model:this.model.node,$parentElement:this.$el}))},"delete":function(){if(this.edgePresenter)this.edgePresenter["delete"]();if(this.nodePresenter)this.nodePresenter["delete"]();e.UiContext.prototype["delete"].apply(this,arguments)}})}({UiContext:m}),J=function(e){return IMVU.BaseClass.extend("GlobalErrorHandler",{dependencies:["root","window"],initialize:function(a){this.serviceProvider=
a.serviceProvider;this.root=a.root;a.window.onerror=this.onerror.bind(this)},onerror:function(a,b,c){this.serviceProvider.create(e.RestModel,{id:this.root+"/error_report/",message:a,url:b,line:c},{}).save();return!1}})}({RestModel:p}),u=function(e){var a=IMVU.NamedCollection.prototype;return IMVU.NamedCollection.extend("RestCollection",_.extend({dependencies:["rest","modelCache","Promise"],initialize:function(b,c){a.initialize.apply(this,arguments);if(!c.id)throw Error("RestCollection must have 'id' option.");
this.url=c.id;this.rest=IMVU.requireProperty(c,"rest");this.Promise=c.Promise;this.modelCache=IMVU.requireProperty(c,"modelCache");this.appendToSearchCollection=c.appendToSearchCollection;this._initSyncing()},model:e.RestModel,relations:{},_prepareModel:function(b,c){var d;if(b instanceof this.model)d=b;else if("string"===typeof b)d=this.modelCache.get(b,this.model);else throw Error("Must pass in a url or a model of type "+this.model.name);return a._prepareModel.call(this,d,c)},collectionName:void 0,
parse:function(a,c){return null===this.collectionName?a.data:a.data[this.collectionName]},add:function(b,c){c=c||{};_(c).extend({rest:this.rest,parse:!1,modelCache:this.modelCache});return a.add.call(this,b,c)},reset:function(b,c){c=c||{};_(c).extend({rest:this.rest,parse:!1,id:this.url,modelCache:this.modelCache});return!1===c.reset?this.add(b,c):a.reset.call(this,b,c)},hasNextPage:function(){return!!this.relations.next},getNextPage:function(a){if(!this.isSyncing()&&this.hasNextPage()){var c={url:this.relations.next,
reset:!1};a&&_.extend(c,a);return this.fetch({url:c.url,reset:c.reset,success:function(){this.trigger("paged")}.bind(this)})}},hasPreviousPage:function(){return!!this.relations.previous},getPreviousPage:function(a){if(!this.isSyncing()&&this.hasPreviousPage()){var c={url:this.relations.previous,reset:!1};a&&_.extend(c,a);return this.fetch({url:c.url,reset:c.reset,success:function(){this.trigger("paged")}.bind(this)})}},fetch:function(b){this._clearState();return a.fetch.apply(this,arguments)},forceFetchRefresh:function(){this.rest.invalidate(this.url);
this.fetch()},invalidate:function(){var a=[];this.each(function(c){this.rest.invalidate(c.id);a.push(c.id)}.bind(this));this.modelCache.invalidate(this.url);this.enumerated().then(function(){this.each(function(c){-1!==a.indexOf(c.id)&&c.fetch()})}.bind(this))},release:function(){this.each(function(a){a.release()}.bind(this));this.rest.invalidate(this.url);this.modelCache.release(this)},sync:function(a,c,d){var f=this.url;d&&d.url&&(f=d.url);if("read"!==a)throw Error("Sync with bad method: "+a);if(!f||
"string"!==typeof f)throw Error("URL must be specified as a string in RestCollection. Got: "+JSON.stringify(this.url));this._onRequestSent();return e.RestUtil.makeRequest(this.rest,"get",f,void 0,d,function(a,b,f){void 0===a?(c.relations=b.relations,"updates"in b&&(c.updates=b.updates),"total_count"in b.data&&(f=c.total_count,c.total_count=b.data.total_count,f!==c.total_count&&c.trigger("update",c)),d.success(c,b.data.items,d)):d.error&&d.error(c,f,d);c._onResponseReceived(void 0===a,a)})},populated:function(){return this.enumerated().then(function(){return this.Promise.every(this.map(function(a){return a.populated()}))}.bind(this)).then(function(){return this}.bind(this))},
enumerated:function(){return new this.Promise(function(a){if(this.isError())a.reject();else{var c=function(d,f){this.off("error",c);a.reject({isError:d,contents:f})}.bind(this);this.on("error",c);this.whenPopulated(function(){this.off("error",c);a.accept(this)}.bind(this))}}.bind(this))}},e.RestSyncingMixin))}({RestSyncingMixin:w,RestUtil:s,RestModel:p}),K=function(e){var a=e.RestModel.extend("NodeModel",{dependencies:["restModelFactory","Promise"],collectionFactories:{},initialize:function(a,b){e.RestModel.prototype.initialize.call(this,
a,b);this.restModelFactory=IMVU.requireProperty(b,"restModelFactory");this.Promise=b.Promise},getEdgeCollection:function(a,b,c){return this.searchEdgeCollection(a,void 0,b,c)},searchEdgeCollection:function(a,b,c,f){if(!this.relations[a])throw Error("'"+a+"' relation not defined on NodeModel: "+IMVU.repr(this.relations));c=c||this.collectionFactories[a]||d;return this.restModelFactory.searchCollection(this.relations[a],b,c,f)},getSummaryCollection:function(a,b){return this.searchEdgeCollection(a,{limit:0},
b)},getSingleEdge:function(b,c){if(!this.relations[b])throw Error("'"+b+"' relation not defined on NodeModel With relations: "+IMVU.repr(this.relations));c=c||a;return this.restModelFactory.readModel(this.relations[b],c)}}),b=e.RestModel.extend("EdgeModel",{dependencies:["restModelFactory"],initialize:function(a,b){e.RestModel.prototype.initialize.call(this,a,b);this.restModelFactory=IMVU.requireProperty(b,"restModelFactory")},deref:function(b){b=b||a;return this.restModelFactory.readModel(this.relations.ref,
b)},getType:function(){var a=decodeURIComponent(this.url()).split("/");return a[a.length-1].split("-")[0]}}),c=e.RestModel.extend("EdgeDerefModel",{edgeFactory:b,nodeFactory:a,dependencies:["restModelFactory","Promise"],initialize:function(a,b){e.RestModel.prototype.initialize.call(this,a,b);this.restModelFactory=b.restModelFactory;this.Promise=b.Promise;this.id=a.id;this.edge=this.restModelFactory.readModel(b.edgeUrl,this.edgeFactory,{nofetch:!0});this.edge.on("all",function(a){var b=_.toArray(arguments);
b[1]=this;this.trigger.apply(this,b);b[0]="edge:"+b[0];this.trigger.apply(this,b)},this);this.edge.populated().then(function(){this.node=this.edge.deref(this.nodeFactory);this.node.on("all",function(a){var b=_.toArray(arguments);b[1]=this;this.trigger.apply(this,b);b[0]="node:"+b[0];this.trigger.apply(this,b)},this)}.bind(this))},invalidate:function(){this.edge.invalidate()},fetch:function(){this.edge.fetch()},populated:function(){return this.edge.populated().then(function(){return this.node.populated()}.bind(this))},
isPopulated:function(){return this.edge.isPopulated()&&this.node&&this.node.isPopulated()},isError:function(){return this.edge.isError()||this.node&&this.node.isError()},isSyncing:function(){return this.edge.isSyncing()||this.node&&this.node.isSyncing()},toJSON:function(){return{edge:this.edge.toJSON(),node:this.node.toJSON()}}}),d=e.RestCollection.extend("EdgeCollection",{model:c,dependencies:["Promise","rest","modelCache"],initialize:function(a,b){this.serviceProvider=b.serviceProvider;this.Promise=
b.Promise;this.rest=b.rest;this.modelCache=b.modelCache;e.RestCollection.prototype.initialize.apply(this,arguments)},_prepareModel:function(a,b){var c=a instanceof this.model?a:null;c||(c=this.modelCache.get("deref:"+a,this.model,{},{edgeUrl:a}));return e.RestCollection.prototype._prepareModel.call(this,c,b)},create:function(a){return this.rest.post(this.url,a).then(function(a){return 201===a.xhr.status?(a=a.xhr.getResponseHeader("Location"),this.get(a)||this.add(a),this.Promise.resolve(this.get(a))):
200===a.xhr.status?this.Promise.resolve(a.response.data):this.Promise.reject()}.bind(this))},remove:function(a){var b=/^deref:/;"string"!==typeof a||b.exec(a)||(a="deref:"+a);return e.RestCollection.prototype.remove.call(this,a)},get:function(a){var b=/^deref:/;"string"!==typeof a||b.exec(a)||(a="deref:"+a);return e.RestCollection.prototype.get.call(this,a)},getMyEdge:function(){return this.relations.my_edge?this._prepareModel(this.relations.my_edge):null},invalidate:function(){var a=[];this.each(function(b){this.rest.invalidate(b.edge.id);
a.push(b.id)}.bind(this));this.modelCache.invalidate(this.url);this.enumerated().then(function(){this.each(function(b){-1!==a.indexOf(b.id)&&b.fetch()})}.bind(this))},release:function(){this.each(function(a){a.edge.release()}.bind(this));this.rest.invalidate(this.url);this.modelCache.release(this)}}),f=e.RestCollection.extend("NodeCollection",{model:a}),l=IMVU.BaseClass.extend("GraphRoot",{modelFactory:a,dependencies:["restModelFactory","root","Promise"],initialize:function(a){this.restModelFactory=
a.restModelFactory;this.root=a.root;this.Promise=a.Promise;this.__url=this.root+this.endpoint},create:function(a){return this.restModelFactory.createModel(this.__url,this.modelFactory,a)},search:function(a,b){b=b||f;return this.restModelFactory.searchCollection(this.__url,a,b)}});return{NodeModel:a,EdgeModel:b,EdgeDerefModel:c,EdgeCollection:d,NodeCollection:f,GraphRoot:l}}({RestModel:p,RestCollection:u}),z=function(e){return IMVU.BaseClass.extend("loginManager",{dependencies:["serviceProvider","eventBus",
"rest","root"],initialize:function(a){this.serviceProvider=a.serviceProvider;this.eventBus=a.eventBus;this.rest=a.rest;this.root=a.root;this.checking=!1;var b=this.root+"/login/me";this.eventBus.on("restError",function(a,d,f){this.checking||f===b||(this.checking=!0,403===d.status&&(this.rest.invalidate(b),this.rest.get(b).then(function(a){this.checking=!1}.bind(this),function(a){this.eventBus.trigger("logout");this.checking=!1}.bind(this))))},this)}})}({}),A=function(e){return IMVU.BaseClass.extend("ModelCache",
{dependencies:["rest","timer","window"],initialize:function(a){this.serviceProvider=a.serviceProvider;this.rest=a.rest;this.__timer=a.timer;this.__window=a.window;this.__instances={};this.__collections={};this.__active={};this.__invalidationPolicy={};this.setInvalidationPolicy(a.invalidationPolicyKey)},get:function(a,b,c,d,f){d=d||{};if(c&&"id"in c&&c.id!==a)throw Error("Cannot update id of a model "+JSON.stringify([a,c.id]));if(a in this.__collections)throw Error("The same URL cannot be both an instance and a collection: "+
a);a in this.__instances?_.isEmpty(c)||this.__instances[a]!==c&&this.__instances[a].set(c):(c=c||{},d=d||{},c=_.extend({id:a},c),b=this.serviceProvider.create(b,c,d),this.__instances[a]=b,b instanceof e.RestModel&&!0!==d.nofetch&&b.fetch(f));return this.__instances[a]},setMultiFetchParams:function(a,b){this.__multiFetchUrl=a;this.__multiFetchBatchSize=b},getMulti:function(a,b,c,d,f){if(null===a||"undefined"===typeof a||a.startsWith("undefined"))return!1;c=c||[];if(0===c.length)return!0;c=_.uniq(c);
d="undefined"!==typeof d?d:{};f=[];for(var e=0,g=c.length,k=0,h="";k<g;k++){"undefined"===typeof f[e]&&(f[e]=[]);h=c[k];if(!(h in this.__instances)){var n=this.serviceProvider.create(b,{id:h},d);this.__instances[h]=n;f[e].push(h)}f[e].length===this.__multiFetchBatchSize&&e++}if(0!==f.length&&0!==f[0]){if("chat"===a||"photo"===a){if("undefined"===typeof this.__multiFetchUrl||"undefined"===typeof this.__multiFetchBatchSize)throw Error("The multiFetch paramters for the url and batch size have not been set, check your implementation");
for(e=0;e<f.length;e++)0<f[e].length&&this.rest.post(this.__multiFetchUrl,{endpoints:f[e]})}else b={id:f.join(",")},a=a+"?"+$.param(b),this.rest.get(a);return!0}},setInvalidationPolicy:function(a){this.__invalidationPolicyKey="undefined"===typeof a?"default":a;switch(this.__invalidationPolicyKey){case "instant":case "default":this.__invalidationPolicy={realtime:!0};break;case "with_hinting":this.__invalidationPolicy={realtime:!1};break;default:return window.console.warn('ModelCache got bad invalidation policy, "'+
this.__invalidationPolicyKey+'", falling back to default.'),this.setInvalidationPolicy("default")}},getCollection:function(a,b,c,d){c=c||{};if(a in this.__instances)throw Error("The same URL cannot be both an instance and a collection: "+a);if(!(a in this.__collections)){c=_.extend({id:a},c);if(c.id!==a)throw Error("Inconsistent id/URL in ModelCache.getCollection(): id="+c.id+", url="+a);b=this.serviceProvider.create(b,[],c);this.__collections[a]=b;b instanceof e.RestCollection&&!0!==c.nofetch&&b.fetch(d)}return this.__collections[a]},
release:function(a){a=_.result(a,"url");if(!this.__active[a])if(a in this.__instances){if(this.__invalidator&&this.__instances[a].updates){var b=this.__instances[a].updates;this.__invalidator.unwatch(b.queue,b.mount,a)}delete this.__instances[a]}else if(a in this.__collections)this.__invalidator&&this.__collections[a].updates&&(b=this.__collections[a].updates,this.__invalidator.unwatch(b.queue,b.mount,a)),delete this.__collections[a];else throw"Unexpected: ModelCache has no model "+a;},_inCache:function(a){return a in
this.__instances||a in this.__collections},invalidate:function(a,b){b&&!1===b.invalidateRest||this.rest.invalidate(a);var c=this.__instances[a]||this.__collections[a];b&&!1===b.reset||void 0===c||(c.fetch(b),delete c.dirty,this.__active[a]&&(this.__active[a].lastFetch=this.__timer.getTime()))},queueInvalidate:function(a){if(this.__invalidationPolicy.realtime)return this.invalidate(a);var b=this.__instances[a]||this.__collections[a];if(void 0!==b)if(this.__active[a]){var b=this.__timer.getTime(),c=
1E3*this.getResolution(a),c=this.__active[a].lastFetch+c;b>=c?this.invalidate(a):void 0===this.__active[a].fetchTimeout&&(this.__active[a].fetchTimeout=this.__timer.setTimeout(function(){this.invalidate(a)}.bind(this),c-b))}else b.dirty=!0},authoritativeSetModel:function(a,b){if(!a)throw Error("Must have a url to authoritatively set model: "+IMVU.repr(b));void 0!==this.__instances[a]?this.__instances[a].set(b.attributes):this.__instances[a]=b},setInvalidator:function(a){this.__invalidator=a},activate:function(a,
b,c){void 0===b&&(b=a,a=void 0);var d=_.result(b,"url");this.__active[d]||(this.__active[d]={model:b,resolution:0,lastFetch:this.__timer.getTime(),simplerefs:0,refs:[]});void 0===a?this.__active[d].simplerefs++:this.__active[d].refs.push({context:a,hints:c||{}});this.__recalculateResolutionInterval(d);(this.__instances[d]||this.__collections[d]).dirty&&this.invalidate(d)},deactivate:function(a,b){var c=a,d=b;void 0===d&&(d=c,c=void 0);d=_.result(d,"url");if(this.__active[d]){var e=_.findIndex(this.__active[d].refs,
function(a){return a.context===c});0>e?this.__active[d].simplerefs--:this.__active[d].refs.splice(e,1);0>=this.__active[d].simplerefs+this.__active[d].refs.length?(this.__active[d].fetchTimeout&&this.__timer.clearTimeout(this.__active[d].fetchTimeout),delete this.__active[d]):this.__recalculateResolutionInterval(d)}},__recalculateResolutionInterval:function(a){if(this.__active[a])if(0<this.__active[a].simplerefs)this.__active[a].resolution=0;else{var b=this.__active[a].resolution;this.__active[a].resolution=
_.reduce(this.__active[a].refs,function(a,b){return Math.min(b.hints.resolution||0,a)},this.__active[a].refs[0].hints.resolution||0);void 0!==this.__active[a].fetchTimeout&&this.__active[a].resolution<b&&(this.__timer.clearTimeout(this.__active[a].fetchTimeout),this.queueInvalidate(a))}},getActive:function(){return _.map(this.__active,function(a){return a.model})},getResolution:function(a){return this.__active[a]?this.__active[a].resolution:null},refreshActive:function(){_.each(this.__collections,
function(a){a.dirty=!0});_.each(this.__instances,function(a){a.dirty=!0});_.each(this.__active,function(a){a=_.result(a.model,"url");this.invalidate(a)}.bind(this))}})}({RestModel:p,RestCollection:u}),L=function(e){return IMVU.BaseClass.extend("ModelInvalidator",_.extend({dependencies:["imqManager","rest","modelCache"],initialize:function(a){this.__imqManager=IMVU.requireProperty(a,"imqManager");this.rest=IMVU.requireProperty(a,"rest");this.__modelCache=IMVU.requireProperty(a,"modelCache");this.subscriptions=
{};this.needNotification=[];this.requestingNotification=!1;this.rest.setInvalidator(this);this.__modelCache.setInvalidator(this);this.__imqManager.connect().then(function(){this.__imqManager.state.on("change:status",function(){"connected"===this.__imqManager.state.get("status")&&this.__modelCache.refreshActive()}.bind(this))}.bind(this));this.__imqManager.subscribeMessage("/user/"+this.__imqManager.config.userId,"web_msg",function(a,c){this.listenTo(c,"message",function(a){if("private_invalidation"===
a.message.substr(0,20)){var b;try{b=JSON.parse(a.message.substring(21))}catch(c){return}switch(b.action){case "updated":_.each(b.invalidate,function(a){this.__modelCache.queueInvalidate(a)}.bind(this))}}}.bind(this))}.bind(this))},watch:function(a,b,c){_.isUndefined(this.subscriptions[a])&&(this.subscriptions[a]={});this.__addSubscription(a,b,c);_.isUndefined(this.subscriptions[a][b].mount)&&this.__imqManager.subscribeMessage(a,b,this.__onSubscribe.bind(this,a,b,c))},unwatch:function(a,b,c){a in this.subscriptions&&
b in this.subscriptions[a]&&(this.subscriptions[a][b].ids=c?_.without(this.subscriptions[a][b].ids,c):[],_.isEmpty(this.subscriptions[a][b].ids)&&(this.subscriptions[a][b].mount&&this.subscriptions[a][b].mount.off(),delete this.subscriptions[a][b]))},unwatchAll:function(){_.each(this.subscriptions,function(a,b){_.each(a,function(a,d){this.unwatch(b,d)}.bind(this))}.bind(this))},__addSubscription:function(a,b,c,d){"node"===b?_.isUndefined(this.subscriptions[a][b])?this.subscriptions[a][b]={id:c}:this.subscriptions[a][b].id=
c:_.isUndefined(this.subscriptions[a][b])?this.subscriptions[a][b]={ids:[c]}:(this.subscriptions[a][b].ids.push(c),this.subscriptions[a][b].ids=_.uniq(this.subscriptions[a][b].ids))},__onSubscribe:function(a,b,c,d,e){!d&&this.subscriptions[a][b]&&(e.on("message",this.__handleMessage.bind(this,a,b)),this.subscriptions[a][b].mount=e)},__handleMessage:function(a,b,c){var d=JSON.parse(c.message);if("node"===b)this.__modelCache.queueInvalidate(this.subscriptions[a][b].id);else switch(d.action){case "created":_.each(this.subscriptions[a][b].ids,
function(a){var b=this.__modelCache._inCache(a)?this.__modelCache.getCollection(a):null;-1===a.indexOf("?")||/\?summary\=1$/.exec(a)||/\?limit\=0$/.exec(a)?(this.rest.invalidate(a),b&&_.each(d.objects,function(c){b.total_count++;/\?summary\=1$/.exec(a)||/\?limit\=0$/.exec(a)?b.trigger("update",b):b.add(c)}.bind(this))):b&&b.appendToSearchCollection?(this.rest.invalidate(a),_.each(d.objects,function(a){b.total_count++;b.add(a)}.bind(this))):this.__modelCache.queueInvalidate(a)}.bind(this));break;case "updated":_.each(d.objects,
function(a){this.__modelCache.queueInvalidate(a)}.bind(this));break;case "deleted":_.each(this.subscriptions[a][b].ids,function(a){-1===a.indexOf("?")?(this.rest.invalidate(a),_.each(d.objects,function(b){if(this.__modelCache._inCache(a)){var c=this.__modelCache.getCollection(a),d=c.get(b);d&&c.total_count--;c.remove(b);this.rest.invalidate(b);d&&this.__modelCache.release(d)}}.bind(this))):this.__modelCache.queueInvalidate(a)}.bind(this));break;default:throw Error("Unrecognized message action: "+
d.action);}},refreshAll:function(){this.rest.invalidateAll();_.each(this.subscriptions,function(a){_.each(a,function(a,c){"node"!==c&&_.each(a.ids,function(a){this.__modelCache.invalidate(a,{invalidateRest:!1})}.bind(this))}.bind(this))}.bind(this));_.each(this.subscriptions,function(a){_.each(a,function(a,c){"node"===c&&this.__modelCache.invalidate(a.id,{invalidateRest:!1})}.bind(this))}.bind(this))}},Backbone.Events))}({}),B=function(e){return Backbone.Collection.extend({constructor:function(a,
b){function c(){this.reset(_.map(this.collection.models,d))}Backbone.Collection.prototype.constructor.call(this);this.collection=IMVU.requireProperty(b,"collection");var d=IMVU.requireProperty(b,"wrap");this.collection.on("reset",c,this);this.collection.on("add",function(a){this.add(d(a))},this);this.collection.on("remove",function(a,b,c){this.remove(this.at(c.index))},this);c.call(this);return this}})}({}),M=function(e){var a={"data-reactive-syncing":function(a,c,d){var e=$(c);a.on("syncing",function(a){e.toggleClass(d,
a)});e.toggleClass(d,a.isSyncing())},"data-reactive-error":function(a,c,d){var e=$(c);a.on("error",function(a,b){e.toggleClass(d,a);e.children(".error-message").text(a?b.message:"");e.children(".error-code").text(a?b.error:"")});a.isError()&&(e.toggleClass(d,!0),a=a.getError(),e.children(".error-message").text(a.message),e.children(".error-code").text(a.error))},"data-reactive-contents":function(a,c,d){var e=$(c);a.on("change:"+d,function(){e.text(a.get(d))});a.has(d)&&e.text(a.get(d))},"data-reactive-attrs":function(a,
c,d){var e=$(c);c=JSON.parse(d);_(c).each(function(c,d){a.on("change:"+c,function(){e.attr(d,a.get(c))});a.has(c)&&e.attr(d,a.get(c))})}};return e.UiContext.extend("ReactivePresenter",{render:function(b,c){var d=document.createElement("div");d.innerHTML=b;_(a).each(function(b,e){_(d.querySelectorAll("["+e+"]")).each(function(b){var d=b.getAttribute(e);a[e](c,b,d)})});$(d).children().remove().appendTo(this.el)}})}({UiContext:m}),C=function(e){return IMVU.BaseClass.extend("Rest",{dependencies:["XMLHttpRequest",
"Promise","eventBus"],TIMEOUT_MS:3E4,initialize:function(a){this.XMLHttpRequest=IMVU.requireProperty(a,"XMLHttpRequest");this.__requestQueue={};this.__responseCache={};this.__inFlight={};this.__applicationHeader=this.__invalidator=void 0;this.Promise=a.Promise;this.serviceProvider=a.serviceProvider;this.eventBus=a.eventBus;this.serviceProvider.has("emulateNetworkError")&&(this.__emulateNetworkError=this.serviceProvider.get("emulateNetworkError"))},getErrorEmulation:function(){return this.__emulateNetworkError?
_.map(this.__emulateNetworkError,function(a){var b=_.clone(a);a.queryMatch&&(b.queryMatch=_.clone(a.queryMatch));return b}.bind(this)):void 0},setErrorEmulation:function(a){this.__emulateNetworkError=a},clearErrorEmulation:function(){delete this.__emulateNetworkError},setInvalidator:function(a){this.__invalidator=a;_(this.__responseCache).each(function(a,c){this.__listenForInvalidation(c)}.bind(this))},invalidate:function(a){this.__inFlight[a]&&"GET"===this.__inFlight[a].method&&this.__restartInFlight(a,
void 0,void 0);delete this.__responseCache[a]},invalidateAll:function(){this.__responseCache={}},precache:function(a){_.each(a,function(a,c){this.__updateCache(c,a,{status:200})}.bind(this))},__listenForInvalidation:function(a){if(this.__invalidator){var b=this.__responseCache[a].response.updates;b&&(b.queue&&b.mount)&&this.__invalidator.watch(b.queue,b.mount,a)}},cancelAll:function(a){var b=this.ERROR_ABORT;this.__inFlight[a]&&this.__cancelInFlight(a,void 0,b);this.__requestQueue[a]&&(_.each(this.__requestQueue[a],
function(a){var d=new this.XMLHttpRequest;d.abort();a.onComplete(b,void 0,d)}.bind(this)),delete this.__requestQueue[a])},__restartInFlight:function(a,b,c){b=this.__inFlight[a].method;c=this.__inFlight[a].xhr;var d=this.__inFlight[a].body,e=this.__inFlight[a].options,l=this.__inFlight[a].onComplete;c.onabort=function(){};c.onreadystatechange=function(){};c.abort();this.__makeRequest(b,a,d,e,l)},__cancelInFlight:function(a,b,c){var d=this.__inFlight[a].xhr,e=this.__inFlight[a].onComplete;d.onabort=
function(){};d.abort();delete this.__inFlight[a];e(c,b,d)},__request:function(a,b,c,d,e){_.isFunction(d)&&(e=d,d={});var l=this.eventBus;return new this.Promise(function(g){function h(a,c,d,k){var n=E.getErrorEmulation();if(!a&&n){var m=_.findKey(n,function(a,b){var c=RegExp(a.pathMatch+"(\\?.*)*$"),c=k?k.match(c):void 0;if(a.hasOwnProperty("queryMatch"))return c&&c[1]?(c=c[1].replace(/\?/,"").split(/\&/),c=_.map(c,function(a){var b=a.indexOf("=");return-1===b?a:a.substr(0,b)}),c=_.intersection(c,
a.queryMatch),0!==c.length&&window.console.log("Error simulated because keys matched: ",c),c.length):!1;c&&window.console.log("Error simulated on URL match: ",c);return c});m&&(a=n[m],a={error:a.error,message:a.message},d={status:a.hasOwnProperty("error")?a.error:500,statusMessage:a.hasOwnProperty("message")?a.message:"Unknown system error"},window.console.log("Simulated error: ",a,d))}k=k||b;e&&e(a,c,d,k);a?(g.reject({error:a,xhr:d,url:k}),l.trigger("restError",a,d,k)):g.resolve({response:c,xhr:d,
url:k})}var E=this;if(this.__inCacheAndCacheable(a,b))h(void 0,this.__responseCache[b].response,this.__responseCache[b].xhr,b);else{var n=this;this.__queueRequest(b,a,function(e){n.__inCacheAndCacheable(a,b)?(h(void 0,n.__responseCache[b].response,n.__responseCache[b].xhr,b),e()):n.__makeRequest(a,b,c,d,function(){delete n.__inFlight[b];h.apply(void 0,arguments);e()})},h)}}.bind(this))},__inCacheAndCacheable:function(a,b){return"GET"===a&&b in this.__responseCache},__makeRequest:function(a,b,c,d,
e){function l(a){return function(){e(a,void 0,g)}}var g=new this.XMLHttpRequest;b=b.replace(/\/$/,"");var h=!1;this.__inFlight[b]={method:a,xhr:g,body:c,options:d,onComplete:e};d=d||{};var m=d.dataType||"json",n="json"===m?"application/json; charset=utf-8":"application/xml; charset=utf-8";g.open(a,b);g.timeout=this.TIMEOUT_MS;g.withCredentials=!1===d.withCredentials?!1:!0;d&&d.headers&&_.each(d.headers,function(a,b){b&&"ACCEPT"===b.toUpperCase()&&(h=!0);g.setRequestHeader(b,a)});h||g.setRequestHeader("Accept",
n);"GET"!==a&&g.setRequestHeader("Content-Type",n);if("POST"===a||"PUT"===a||"DELETE"===a)"xml"===m&&l("Do not spport non-GETs to xml")(),(a=this.serviceProvider.get("sauce"))&&g.setRequestHeader("X-imvu-sauce",a),this.__applicationHeader&&g.setRequestHeader("X-imvu-application",this.__applicationHeader);g.onabort=l(this.ERROR_ABORT);g.onerror=l(this.ERROR_NETWORK);g.ontimeout=l(this.ERROR_TIMEOUT);g.onreadystatechange=function(){if(4===g.readyState&&0!==g.status){var a;if(204===g.status)e(void 0,
"",g);else if("json"===m?a=JSON.parse(g.responseText):"xml"===m&&(a=g.responseXML),200<=g.status&&400>g.status){this.__updateCache(b,a,g);a="id"in a?a.id:b;var c=void 0!==this.__responseCache[a]?this.__responseCache[a]:{response:null,xhr:g};e(void 0,c.response,c.xhr,a)}else l(a)()}}.bind(this);g.send(void 0===c?null:JSON.stringify(c))},__updateCache:function(a,b,c){function d(b,c,d,h){b=b.replace(/\/$/,"");e.__responseCache[b]={response:c,xhr:d};e.__listenForInvalidation(b);a!==b&&h!==b&&e.serviceProvider.get("modelCache").invalidate(b,
{invalidateRest:!1})}var e=this;if("id"in b&&"denormalized"in b){var h=b.id.replace(/\/$/,"");_(b.denormalized).each(function(b,k){k=k.replace(/\/$/,"");d(k,b,c,h);a!==k&&h!==k&&e.__inFlight[k]&&"GET"===e.__inFlight[k].method&&e.__cancelInFlight(k,b)})}else d(a,b,c,a)},__queueRequest:function(a,b,c,d){a=a.replace(/\/$/,"");this.__requestQueue[a]=this.__requestQueue[a]||[];this.__requestQueue[a].push({method:b,request:c,onComplete:d});1===this.__requestQueue[a].length&&this.__pumpRequest(a)},__pumpRequest:function(a){a=
a.replace(/\/$/,"");0<this.__requestQueue[a].length&&this.__requestQueue[a][0].request(function(){this.__requestQueue[a].shift();this.__pumpRequest(a)}.bind(this))},setApplicationHeader:function(a){this.__applicationHeader=a},get:function(a,b,c){return this.__request("GET",a,void 0,b,c)},post:function(a,b,c,d){return this.__request("POST",a,b,c,d)},put:function(a,b,c,d){return this.__request("PUT",a,b,c,d)},"delete":function(a,b,c){return this.__request("DELETE",a,void 0,b,c)},ERROR_ABORT:{error:"AbortError",
message:"Connection aborted"},ERROR_NETWORK:{error:"NetworkError",message:"Network error"},ERROR_TIMEOUT:{error:"TimeoutError",message:"Network connection timed out"},ERROR_PARSE:{error:"ParseError",message:"Unable to parse response"}})}({}),D=function(e){return IMVU.BaseClass.extend("RestModelFactory",{dependencies:["modelCache","Promise","rest"],initialize:function(a){this.serviceProvider=IMVU.requireProperty(a,"serviceProvider");this.rest=IMVU.requireProperty(a,"rest");this.modelCache=IMVU.requireProperty(a,
"modelCache");this.Promise=a.Promise},simplePOST:function(a,b){return this.rest.post(a,b).then(function(a){return 200===a.xhr.status?this.Promise.resolve(a.response):this.Promise.reject({code:a.xhr.status,msg:"Invalid response code",response:a.response})}.bind(this))},createModel:function(a,b,c){if(!b)throw Error("ModelType should be defined.");return this.rest.post(a,c).then(function(a){var c=a.xhr.getResponseHeader("Location");return c?this.Promise.resolve(this.readModel(c,b)):this.Promise.reject(a)}.bind(this))},
readModel:function(a,b,c){if(!b)throw Error("ModelType should be defined.");c="undefined"!==typeof c?c:{};c=this.modelCache.get(a,b,{},c);if(Object.getPrototypeOf(c)!==b.prototype)throw Error("Requested ModelType '"+b.name+"' doesn't match previously requested '"+c.constructor.name+"' for url '"+a+"'.");return c},readCollection:function(a,b,c){return this.searchCollection(a,void 0,b,c)},searchCollection:function(a,b,c,d){if(!c)throw Error("CollectionType should be defined.");d="undefined"!==typeof d?
d:{};_.isEmpty(b)||(a+="?"+$.param(b));b=this.modelCache.getCollection(a,c,d);if(!(b instanceof c))throw Error("Requested CollectionType '"+c.name+"' doesn't match previously requested '"+b.constructor.name+"' for url '"+a+"'.");return b},multiGetQueue:[],multiGetSetMultiFetchParams:function(a,b){this.modelCache.setMultiFetchParams(a,b)},multiGetReset:function(a){this.multiGetQueue[a]=[]},__multiGetInitialize:function(a){"undefined"===typeof this.multiGetQueue[a]&&this.multiGetReset(a)},multiGetQueueElement:function(a,
b){this.__multiGetInitialize(a);var c=typeof b;"undefined"!==c&&("string"===c?this.multiGetQueue[a].push(b):"object"===c&&(this.multiGetQueue[a]=this.multiGetQueue[a].concat(b)))},multiGetRequest:function(a,b,c,d){return this.modelCache.getMulti(a,b,this.multiGetQueue[a],c,d)}})}({RestUtil:s}),N=function(e){return e.UiContext.extend("RestModelPresenter",{uiContextName:"rest_model_presenter_generic",dependencies:["model"],initialize:function(a){e.UiContext.prototype.initialize.call(this,a);this.addToDOM();
this.model.populated().then(function(){this.model.node.on("change",this.renderTemplate,this)}.bind(this))},render:function(){this.model.populated().then(function(){this.renderTemplate()}.bind(this))},renderTemplate:function(){throw Error("renderTemplate() should be implemented");}})}({UiContext:m}),O=function(e){return function(a,b,c){return e.RestCollection.extend("RestReferenceCollection",_.extend({collectionName:"items",model:a||function(){throw new ReferenceError("Must specify ReferenceModelType");
}(),parent:e.RestCollection,getDereferencedCollection:function(){var a=this.modelCache;return new e.ReactiveCollection([],{collection:this,wrap:function(c){return a.get(c.get("data"),b)}})}},c))}}({RestCollection:u,ReactiveCollection:B}),x=function(e){return IMVU.ServiceProvider.extend("ServiceProvider",{initialize:function(){IMVU.ServiceProvider.prototype.initialize.call(this);this.register("random",new IMVU.Random);this.register("timer",IMVU.Timer);this.register("Promise",new IMVU.PromiseFactory(IMVU.EventLoop,
{immediateCallbacks:!0,exposeErrors:!0}));this.register("XMLHttpRequest",IMVU.XMLHttpRequest)}})}({});v=function(e){return e.ServiceProvider.extend("ServiceProvider",{initialize:function(){e.ServiceProvider.prototype.initialize.call(this);this.register("window",window);this.register("sauce","");this.register("eventBus",_.clone(Backbone.Events));this.register("imq",e.IMQ);var a=this.get("window").localStorage;void 0!==a.getItem&&(a=a.getItem("emulateNetworkError"))&&this.register("emulateNetworkError",
JSON.parse(a));this.register("rest",this.create(e.Rest));this.register("modelCache",this.create(e.ModelCache));this.register("restModelFactory",this.create(e.RestModelFactory));this.register("defer",_.defer)}})}({Rest:C,ModelCache:A,RestModelFactory:D,LoginManager:z,IMQ:v["@IMQ"],ServiceProvider:x});x=function(e){var a=e.RestModel.extend("Batch",{add:function(a){var c=this.get("events"),d=c.length?c[c.length-1]:null;a.attributes.repeats&&d&&this.__isRepeat(a,d)?d.attributes.repeats++:c.push(a);this.trigger("change")},
__isRepeat:function(a,c){return a.name===c.name&&a.application===c.application&&a.context===c.context},length:function(){return this.get("events").length}});return IMVU.BaseClass.extend("UiEventReporter",{maxBatchSize:60,maxWaitTime:6E4,dependencies:["timer","Promise","window","random","root"],initialize:function(a){this.serviceProvider=a.serviceProvider;this.timer=a.timer;this.Promise=a.Promise;this.window=a.window;this.random=a.random;this.__serviceUrl=a.root+"/ui_event/";this.__sequenceId=0;a=
this.window.localStorage.getItem("UiEventReporter:savedEvents");this.__createBatch(a?JSON.parse(a):null);a&&(this.flush(),this.window.localStorage.removeItem("UiEventReporter:savedEvents"));this.window.onbeforeunload=function(){this.__batch.length()&&(this.__clearTimeout(),this.window.localStorage.setItem("UiEventReporter:savedEvents",JSON.stringify(this.__batch.toJSON())))}.bind(this)},recordEvent:function(a,c,d,e,h){if(""===d)throw Error("UI event context must be specified");h=h||{};var g=this.__getTime();
if(!this.__activityGroup||this.__activityGroup.time+300<g)this.__activityGroup={id:this.random.getString()};this.__activityGroup.time=g;h.activity_group_id=this.__activityGroup.id;this.__sequenceId++;this.__batch.add({name:e,application:a,platform:c,context:d,attributes:h,timestamp:g,sequence_id:this.__sequenceId})},flush:function(){return this.__sendBatch()},__getTime:function(){return this.timer.getTime()/1E3},__createBatch:function(b){b=b||{events:[]};this.__batch=this.serviceProvider.create(a,
b,{});this.__batch.id=this.__serviceUrl;this.__batch.on("change",this.__batchChanged,this)},__clearTimeout:function(){_.isUndefined(this.__sendTimeout)||this.timer.clearTimeout(this.__sendTimeout)},__sendBatch:function(a){return 0===this.__batch.length()?this.Promise.resolve():new this.Promise(function(a){this.__clearTimeout();var b=this.__batch;this.__createBatch();b.off("change",null,this);b.save({post_time:this.__getTime(),events:b.get("events")},{success:a.accept.bind(a),error:a.reject.bind(a)})}.bind(this))},
__batchChanged:function(){this.__batch.length()>=this.maxBatchSize?this.__sendBatch():(this.__clearTimeout(),this.__sendTimeout=this.timer.setTimeout(this.__sendBatch.bind(this),this.maxWaitTime))}})}({RestModel:p});h={AlertDialog:r,CollectionItem:F,ConfirmDialog:t,DialogManager:G,EdgeCollectionPresenter:H,EdgeRefPresenter:I,GlobalErrorHandler:J,GraphModels:K,ListPresenter:y,LoginManager:z,ModalDialog:q,ModelCache:A,ModelInvalidator:L,ReactiveCollection:B,ReactivePresenter:M,Rest:C,RestCollection:u,
RestModel:p,RestModelFactory:D,RestModelPresenter:N,RestReferenceCollection:O,RestSyncingMixin:w,RestUtil:s,ServiceProvider:v,UiContext:m,UiEventReporter:x,UiView:h};"use strict";h.NodeModel=h.GraphModels.NodeModel;h.EdgeModel=h.GraphModels.EdgeModel;h.EdgeDerefModel=h.GraphModels.EdgeDerefModel;h.EdgeCollection=h.GraphModels.EdgeCollection;h.NodeCollection=h.GraphModels.NodeCollection;h.GraphRoot=h.GraphModels.GraphRoot;return h});
