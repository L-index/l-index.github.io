module({"@NextUtil":"@NextUtil","@Dialogs":"@Dialogs","json!/common/js/JSON/Countries.json":"json!/asset/82bbf3f0be07c92d/common/js/JSON/Countries.json","@Model":"@Model","json!/common/js/JSON/Provinces.json":"json!/asset/1e80a06c565197b7/common/js/JSON/Provinces.json","@UiCore":"@UiCore","json!/common/js/JSON/States.json":"json!/asset/581385bf78983508/common/js/JSON/States.json","@Widgets":"@Widgets","css!/build/withme/Checkout.css":"css!/asset/15759f230a54fefd/build/withme/Checkout.css"},function(e){var t,i,a=(i=Handlebars.template,Handlebars.templates=Handlebars.templates||{},i({1:function(){return"checkout-bottom-container--vip-upsell"},3:function(e,t,i,a){var s;i=t.helperMissing;var n='\n            <div class="order-row order-subtotal">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Subtotal",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+=' <div class="order-row-credits credits-value"></div></div>\n            <div class="order-row vip-discount"><span class="icon icon-vip-crown"></span> 5% ',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"VIP Discount",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+' <div class="order-row-credits">-<span class="credits-value"></span></div></div>\n            '},5:function(e,t,i,a){var s;i=t.helperMissing;var n='\n        <div class="vip-upsell show-discount">\n            <div class="vip-discount">\n                <span class="icon icon-vip-crown"></span>\n                5% ';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"VIP Discount",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='\n            </div>\n            <div class="price-off">\n                -<span class="price-off-amount">0</span>\n                <span class="icon icon-tooltip-icon"></span>\n            </div>\n            <div class="vip-tooltip">\n                <div class="tooltip-header"></div>\n                <div class="tooltip-body">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_upsell_tooltip_copy",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+=' <a class="cta">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_upsell_tooltip_link",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</a> </div>\n            </div>\n        </div>\n        <div class="vip-upsell purchase-free">\n            <span class="icon icon-vip-crown"></span>\n            ',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_upsell_get_purchase_free",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+'\n            <span class="icon icon-vip-crown"></span>\n        </div>\n    '},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<div class="checkout-container">\n    <div class="cart-list-container">\n        <div class="cart-list"></div>\n    </div>\n    <div class="checkout-bottom-container ';return((s=t.if.call(e,e&&e.canSeeVipUpsell,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+='">\n        <div class="order-totals">\n            ',((s=t.if.call(e,e&&e.isVip,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+='\n            <div class="order-row order-total">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Total",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+=" (<span class='item-count'></span>) <div class=\"order-row-credits credits-value\"></div></div>\n        </div>\n    ",((s=t.if.call(e,e&&e.canSeeVipUpsell,{name:"if",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+'\n    </div>\n</div>\n\n<script type="text/template" class="dialog-footer-template">\n    <button class="btn btn-primary buy-now"></button>\n<\/script>\n'},useData:!0})),s=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<div class="back-button"></div>'},useData:!0})}(),n=(t={UiCore:e["@UiCore"]}.UiCore.NodeModel).extend("VirtualCartNode",{save:function(e,i){return t.prototype.save.call(this,{data:e},i)}}),r=function(t){var i={Dialogs:e["@Dialogs"]}.Dialogs.AlloyModalDialog;return i.extend("TooltipDialog",{uiContextName:"tooltip_dialog",className:"tooltip-dialog dialog-type-B text-close",trackedEvents:function(){return this.__customTrackedEvents},initialize:function(e){this.__customTrackedEvents=e.trackedEvents||[],i.prototype.initialize.call(this,e),this.title=e.title,this.__tooltipContent=e.tooltipContent,this.addToDOM()},postRender:function(){this.setContent("body",this.__tooltipContent)}})}(),o=(r=function(e){var t=e.UiCore.UiContext;return t.extend("Tooltip",{className:"tooltip",uiContextName:"tooltip",dependencies:["dialogManager","timer","tooltipLayer","window"],trackedEvents:function(){return[{type:"click",selector:"a",name:"link_click",handler:"__clickedLink",allowBubble:!0}].concat(this.__customTrackedEvents)},__installTooltipLayerEventHandlers:function(){this.__tooltipLayer.$el.on("mouseenter.tooltip",".tooltip",function(){this.__timer.clearTimeout(this.__targetTimeout),this.__timer.clearTimeout(this.__tooltipTimeout),this.$target.off("mouseleave.tooltip")}.bind(this)),this.__tooltipLayer.$el.on("mouseleave.tooltip",".tooltip",function(){this.__timer.clearTimeout(this.__tooltipTimeout),this.__tooltipTimeout=this.__timer.setTimeout(function(){this.setVisible(!1),this.__timer.clearTimeout(this.__tooltipTimeout),this.__tooltipTimeout=this.__timer.setTimeout(function(){this.__hide(),this.__installTargetMouseleave()}.bind(this),125)}.bind(this),250)}.bind(this))},__removeTooltipLayerEventHandlers:function(){this.__tooltipLayer.$el.off(".tooltip")},initialize:function(e){this.$tooltip=IMVU.requireProperty(e,"$replaceElement"),this.$target=IMVU.requireProperty(e,"$tooltipTarget"),this.tooltipTitle=IMVU.optionalProperty(e,"title",!1),this.__tooltipStyle=IMVU.optionalProperty(e,"tooltipStyle","default"),this.__customTrackedEvents=e.trackedEvents||[],t.prototype.initialize.call(this,e),this.$body=$("body"),this.$globalNav=$("nav.global-nav:visible"),"mobile"===this.__serviceProvider.get("platform")?this.$target.on("click.tooltip",function(e){e.stopPropagation(),this.__openTooltipDialog()}.bind(this)):this.$target.on("mouseenter.tooltip",function(){this.__timer.clearTimeout(this.__targetTimeout),this.__timer.clearTimeout(this.__tooltipTimeout),this.__timer.clearTimeout(this.__targetFadeinTimeout),this.__installTargetMouseleave(),this.__targetFadeinTimeout=this.__timer.setTimeout(function(){this.setVisible(!0),this.__show()}.bind(this),250)}.bind(this)),"snug"===this.__tooltipStyle&&this.$el.addClass("tooltip-snug"),this.$el.append(this.$tooltip),this.setParentUiContext(this.__tooltipLayer),this.__tooltipLayer.$el.append(this.$el)},setVisible:function(e){this.$el.toggleClass("tooltip-open",!!e)},__installTargetMouseleave:function(){this.$target.on("mouseleave.tooltip",function(){this.__timer.clearTimeout(this.__targetTimeout),this.__targetTimeout=this.__timer.setTimeout(function(){this.setVisible(!1),this.__timer.clearTimeout(this.__targetTimeout),this.__targetTimeout=this.__timer.setTimeout(function(){this.__hide()}.bind(this),125)}.bind(this),250)}.bind(this))},__show:function(){this.__installTooltipLayerEventHandlers(),this.__trackTooltip(),$(this.__window).on("scroll.tooltip",function(){this.__trackTooltip()}.bind(this)),this.$body.find(".transparent-overlay").on("scroll.tooltip",function(){this.__trackTooltip()}.bind(this))},__trackTooltip:function(){var e=this.$globalNav.height(),t=this.$target[0].getBoundingClientRect().top,i=this.$target[0].getBoundingClientRect().left,a=$(window).width()-(i+this.$target.outerWidth()/2),s=this.$el[0].offsetWidth;0<this.$target.parents(".dialog-manager").length&&(e=0),i=a>s?i+this.$target.width()/2:i+this.$target.width()/2-s,this.$el.css({"margin-top":Math.max(t,e),"margin-left":i})},__hide:function(){this.__removeTooltipLayerEventHandlers(),this.setVisible(!1)},__openTooltipDialog:function(){return this.__dialogManager.showDialog(e.TooltipDialog,{title:this.tooltipTitle||this.$target.text(),tooltipContent:this.$tooltip.html(),trackedEvents:this.__customTrackedEvents})},delete:function(){this.$el.removeAttr("style"),this.__timer.clearTimeout(this.__targetFadeinTimeout),this.__timer.clearTimeout(this.__targetTimeout),this.__timer.clearTimeout(this.__tooltipTimeout),this.$target.off(".tooltip"),this.__removeTooltipLayerEventHandlers(),$(this.__window).off("scroll.tooltip"),this.$body.find(".transparent-overlay").off("scroll.tooltip"),t.prototype.delete.call(this)},__clickedLink:function(){this.__hide()}})}({UiCore:e["@UiCore"],TooltipDialog:r}),function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<div class="upgrade-products">\n    <div class="products"></div>\n</div>\n<footer class="dialog-footer"></footer>'},useData:!0})}()),l=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<button class="btn btn-primary buy-now" disabled>';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"CHECKOUT",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</button>"},useData:!0})}(),d=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<div class="alert-message">\n';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"already_have_vip_subscription_text_before_link",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='\n<a href="https://help.imvu.com" target="_blank">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"already_have_vip_subscription_text_link",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</a>\n",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"already_have_vip_subscription_text_after_link",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"\n</div>"},useData:!0})}(),c=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s,n;i=t.helperMissing;var r=this.escapeExpression,o='\n            <div class="order-row order-total-row">\n                <div class="order-row-name">';return((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Total",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+" ("+r("function"==typeof(n=t.itemCount||e&&e.itemCount)?n.call(e,{name:"itemCount",hash:{},data:a}):n)+')</div>\n                <div class="order-row-amount">$<span class="order-total"></span></div>\n            </div>\n            '},3:function(e,t,i,a){var s;i=t.helperMissing;var n="\n        <div class=\"vip-block\">\n            <input id='vip-checkbox' class=\"vip checkbox\" tabindex='13' type=\"checkbox\"><label for='vip-checkbox'>";return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"I agree to the VIP",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</label> <a class="vip-terms-link vip-toc-link tooltip-target">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Terms and Conditions",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</a>\n            <div class="vip-toc-tooltip">\n                <div class="tooltip-header">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_dialog_title",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</div>\n                <div class="tooltip-body">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_dialog_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</div>\n            </div>\n        </div>\n        "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s,n;i=t.helperMissing;var r=this.escapeExpression,o='<div class="content-container">\n    <div class="error-block">\n        <ul>\n            <li class="error-message invalid-product">';return((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_invalid_product",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='</li>\n            <li class="error-message vip-checkbox-missing">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_vip_checkbox_unchecked",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='</li>\n        </ul>\n    </div>\n    <div class="padded-content-container">\n        <div class="order-block">\n            <legend class="system-info-header">\n                ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Cart",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='\n            </legend>\n            <div class="order-list-placeholder"></div>\n            ',((s=t.if.call(e,e&&e.showTotal,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(o+=s),o+="\n        </div>\n        ",((s=t.if.call(e,e&&e.hasVip,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(o+=s),o+='\n        <div class="payment-block">\n            <legend class="system-info-header">\n                ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Payment Method",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='\n            </legend>\n            <div class="savedcard-container"></div>\n            <div class="action-row add-credit-card"><div class="icon-payment-cc icon"></div> ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Check Out With New Credit Card",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+=' <div class="right-arrow"></div></div>\n            <div class="action-row paypal-checkout"><svg class="paypal-icon" width="25" height="25" viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg"><g fill="none"><path d="M3.15 18.146H1.227a.267.267 0 0 0-.264.227L.187 23.33a.16.16 0 0 0 .16.186h.916a.267.267 0 0 0 .264-.227l.21-1.338A.267.267 0 0 1 2 21.726h.608c1.265 0 1.996-.617 2.186-1.837.086-.536.004-.955-.245-1.25-.274-.322-.758-.493-1.4-.493zm.22 1.81c-.104.694-.63.694-1.14.694h-.29l.203-1.295a.16.16 0 0 1 .158-.136h.134c.347 0 .674 0 .844.198.1.12.13.295.093.54zm5.522-.022h-.92a.16.16 0 0 0-.16.136l-.04.26-.064-.095c-.2-.29-.643-.388-1.086-.388-1.017 0-1.885.775-2.054 1.86-.088.544.037 1.06.343 1.423.28.333.682.47 1.16.47.82 0 1.273-.53 1.273-.53l-.04.258a.16.16 0 0 0 .157.187h.828a.267.267 0 0 0 .264-.227l.497-3.168a.16.16 0 0 0-.158-.186zM7.61 21.736a1.027 1.027 0 0 1-1.04.883c-.266 0-.48-.087-.616-.25-.136-.162-.188-.393-.145-.65.082-.525.506-.89 1.03-.89.26 0 .474.086.614.25.14.167.195.4.155.656zm6.18-1.802h-.923a.267.267 0 0 0-.22.118l-1.276 1.89-.54-1.816a.268.268 0 0 0-.256-.192h-.91a.16.16 0 0 0-.15.213l1.018 3.007-.958 1.36a.16.16 0 0 0 .13.254h.924c.088 0 .17-.043.22-.116l3.074-4.465a.16.16 0 0 0-.13-.253z" fill="#253B80"/><path d="M16.852 18.146H14.93a.267.267 0 0 0-.263.227l-.777 4.956a.16.16 0 0 0 .158.185h.986c.09 0 .17-.067.184-.16l.22-1.404a.267.267 0 0 1 .264-.225h.608c1.266 0 1.996-.617 2.187-1.837.086-.535.003-.954-.246-1.248-.27-.323-.755-.494-1.4-.494zm.22 1.81c-.103.694-.63.694-1.14.694h-.29l.204-1.295a.16.16 0 0 1 .158-.136h.133c.347 0 .674 0 .843.198.1.12.132.295.093.54zm5.522-.022h-.92a.16.16 0 0 0-.157.136l-.04.26-.066-.095c-.198-.29-.642-.388-1.085-.388-1.017 0-1.885.775-2.054 1.86-.086.544.038 1.06.344 1.423.28.333.68.47 1.158.47.82 0 1.274-.53 1.274-.53l-.04.258a.16.16 0 0 0 .157.187h.83a.267.267 0 0 0 .262-.227l.498-3.168a.16.16 0 0 0-.16-.186zm-1.282 1.802a1.027 1.027 0 0 1-1.038.883c-.267 0-.48-.087-.618-.25-.136-.162-.187-.393-.144-.65.083-.525.507-.89 1.03-.89.262 0 .474.086.614.25.14.167.196.4.156.656zm2.366-3.454l-.788 5.047a.16.16 0 0 0 .158.185h.792a.267.267 0 0 0 .264-.227l.778-4.956a.16.16 0 0 0-.158-.186h-.888a.16.16 0 0 0-.158.136z" fill="#179BD7"/><path d="M10.47 15.845l.285-1.806-.633-.016H7.098L9.2.702a.172.172 0 0 1 .17-.146h5.1c1.69 0 2.86.353 3.47 1.048.285.326.467.667.555 1.042.092.393.094.863.004 1.437l-.008.04v.37l.286.16c.24.13.432.275.58.442.244.28.402.633.47 1.053.068.432.045.947-.068 1.53-.13.67-.342 1.25-.626 1.73-.262.44-.596.803-.992 1.085a4.024 4.024 0 0 1-1.336.603 6.662 6.662 0 0 1-1.67.193h-.396c-.284 0-.56.1-.776.284-.217.187-.36.443-.404.722l-.03.163-.502 3.18-.023.118c-.006.037-.016.055-.032.068a.084.084 0 0 1-.052.02h-2.45z" fill="#253B80"/><path d="M19.048 4.167a8.915 8.915 0 0 1-.052.3c-.673 3.45-2.973 4.643-5.91 4.643H11.59c-.36 0-.662.26-.718.615l-.765 4.857-.217 1.376a.383.383 0 0 0 .377.443h2.653a.638.638 0 0 0 .63-.537l.027-.135.5-3.17.03-.174a.638.638 0 0 1 .63-.54h.398c2.57 0 4.582-1.042 5.17-4.062.246-1.26.12-2.315-.53-3.055a2.536 2.536 0 0 0-.727-.56z" fill="#179BD7"/><path d="M18.345 3.886a5.303 5.303 0 0 0-.654-.145 8.307 8.307 0 0 0-1.318-.095h-3.995a.634.634 0 0 0-.63.54l-.85 5.383-.025.157a.726.726 0 0 1 .718-.615h1.496c2.937 0 5.237-1.193 5.91-4.644.02-.102.037-.202.052-.3a3.584 3.584 0 0 0-.703-.28z" fill="#222D65"/><path d="M11.747 4.184a.635.635 0 0 1 .63-.538h3.995c.474 0 .916.03 1.32.096a5.303 5.303 0 0 1 .804.192c.198.065.382.143.552.233.2-1.276 0-2.144-.69-2.93C17.596.37 16.223 0 14.468 0H9.37a.73.73 0 0 0-.72.616l-2.123 13.46a.438.438 0 0 0 .432.506h3.147l.79-5.014.85-5.384z" fill="#253B80"/></g></svg> ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Check Out With PayPal",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+=' <div class="right-arrow"></div></div>\n            <div class="info-row">\n                ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"original_store_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+=' <br><a class="core-store-link" href="/store/index/?platform='+r("function"==typeof(n=t.platformId||e&&e.platformId)?n.call(e,{name:"platformId",hash:{},data:a}):n)+'" target="_blank">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"original_store_link_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='</a>\n            </div>\n        </div>\n    </div>\n</div>\n<script type="text/template" class="dialog-footer-template">\n    <button class="btn btn-primary buy-now">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"BUY",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+=' <span class="item-count"></span> ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ITEM FOR",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+' $<span class="order-total"></span></button>\n<\/script>\n'},useData:!0})}(),h=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s,n;i=this.escapeExpression;var r='\n    <div class="order-row">\n        <div class="order-item">\n            ';return((s=t.if.call(e,e&&e.image,{name:"if",hash:{},fn:this.program(2,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+'\n            <div class="item-info">\n                <div class="item-name">'+i("function"==typeof(n=t.name||e&&e.name)?n.call(e,{name:"name",hash:{},data:a}):n)+'</div>\n                <div class="product-price">$'+i("function"==typeof(n=t.price||e&&e.price)?n.call(e,{name:"price",hash:{},data:a}):n)+"</div>\n            </div>\n        </div>\n    </div>\n"},2:function(e,t,i,a){var s;return'\n            <div class="image-container"><img src="'+(0,this.escapeExpression)("function"==typeof(s=t.image||e&&e.image)?s.call(e,{name:"image",hash:{},data:a}):s)+'"></div>\n            '},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;return(s=t.each.call(e,e&&e.cart,{name:"each",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s?s:""},useData:!0})}(),p=(h=function(e){var t=e.UiCore.UiContext;return t.extend("OrderList",{className:"order-list",uiContextName:"orderlist",initialize:function(e){t.prototype.initialize.call(this,e),this.__cart=IMVU.requireProperty(e,"cart"),this.addToDOM()},render:function(){_.each(this.__cart,function(e){e.price=parseFloat(e.price).toFixed(2),e.image&&-1===e.image.indexOf("/")&&(e.image="/common/withme/img/store/"+e.image)}),this.$el.html(e.template({cart:this.__cart}))}})}({UiCore:e["@UiCore"],template:h}),function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<div class="dropdown-label is-truncated"><span>&nbsp;</span></div>\n<div class="dropdown-option-list-container">\n    <div class="dropdown-scroll-up"></div>\n    <div class="dropdown-scroll-down"></div>\n    <ul class="dropdown-option-list">\n        <li class="dropdown-option is-truncated" data-value="" tabindex="-1"></li>\n    </ul>\n</div>\n'},useData:!0})}()),g=(p=function(e){function t(e){e=$(e.target).closest(".dropdown"),$(".dropdown").not(e).each(function(e,t){$(t).data("dropdown-instance").__hide()})}var i=e.UiCore.UiContext,a=e.NextUtil.Keys;return i.extend("Dropdown",{globalSetup:function(){document.addEventListener("click",t,!0),document.addEventListener("touchend",t,!0)},globalTearDown:function(){document.removeEventListener("click",t,!0),document.removeEventListener("touchend",t,!0)},uiContextName:"dropdown",className:"dropdown disable-text-selection",ITEM_HEIGHT:40,AUTO_SCROLL_BY:2,dependencies:["window","timer"],trackedEvents:function(){return[{type:"click",selector:".dropdown-label",name:"dropdown_label_click",handler:"toggleOpen"},{type:"click",selector:".dropdown-option",name:"dropdown_option_click",handler:"clickOption"},{type:"keydown",selector:"",name:"dropdown_keydown",handler:this.__onKeydown.bind(this,[])},{type:"mousemove",selector:".dropdown-option",name:"dropdown_option_mouseenter",handler:this.__onMousemove.bind(this,{x:0,y:0})},{type:"mouseenter",selector:".dropdown-label",name:"dropdown_label_mouseenter",handler:"__onMouseenterLabel"},{type:"mouseenter",selector:".dropdown-scroll-up",name:"dropdown_scroll_up_mouseenter",handler:"__onScrollUpMouseenter"},{type:"mouseleave",selector:".dropdown-scroll-up",name:"dropdown_scroll_up_mouseleave",handler:"__onScrollUpMouseleave"},{type:"mouseenter",selector:".dropdown-scroll-down",name:"dropdown_scroll_down_mouseenter",handler:"__onScrollDownMouseenter"},{type:"mouseleave",selector:".dropdown-scroll-down",name:"dropdown_scroll_down_mouseleave",handler:"__onScrollDownMouseleave"}]},__onMousemove:function(e,t){e.x==t.screenX&&e.y==t.screenY||(e.x=t.screenX,e.y=t.screenY,this.$el.focus(),this.setActiveElement($(t.target)))},__onBlur:function(e){this.$el.removeClass("is-open")},__onMouseenterLabel:function(e){this.$(".is-selected").removeClass("is-selected")},initialize:function(e){if(this.$select=IMVU.requireProperty(e,"$replaceElement"),!this.$select.is("select"))throw Error("$replaceElement must be a <select> element. got: "+this.$select[0].tagName);if(this.$select.closest("label").length)throw Error("do not wrap custom dropdowns with <label> tags; it disrupts event handling");i.prototype.initialize.call(this,e),this.window=e.window,this.timer=e.timer,this.boundingBox=e.boundingBox||this.getDefaultBoundingBox(),this.document=e.document||document,this.__keyArray=[],(this.dismissOnScroll=e.dismissOnScroll)&&$(e.dismissOnScroll).on("scroll.dropdown",function(){this.__hide()}.bind(this)),$(".dropdown-layer").length||$("body").append('<div class="dropdown-layer"/>'),this.$dropdownLayer=$(".dropdown-layer"),e.dimNoValue&&this.$el.addClass("dim-no-value"),this.$el.data("dropdown-instance",this),this.addToDOM()},delete:function(){this.__keyValueArray&&this.timer.clearTimeout(this.__keyValueArray),this.dismissOnScroll&&$(this.dismissOnScroll).off("scroll.dropdown"),$(this.window).off("resize.dropdown"),i.prototype.delete.call(this)},__onHidden:function(){this.$el.is(":visible")&&this.remove(),i.prototype.__onHidden.apply(this,arguments)},getDefaultBoundingBox:function(){var e=this.$el.position().top-5*this.ITEM_HEIGHT,t=e+11*this.ITEM_HEIGHT;return 0>e&&(e=0),t>$(this.window).height()&&(t=$(this.window).height()),{x:0,y:e,w:$(this.window).width(),h:t-e}},render:function(){this.$placeholder=$("<div/>"),this.$el.html(e.template),this.$label=this.$(".dropdown-label"),this.$optionList=this.$(".dropdown-option-list"),this.$optionListContainer=this.$(".dropdown-option-list-container");var t=this.$optionList.find(".dropdown-option");this.$select.addClass("is-enhanced"),this.refreshLabel(this.$select.find(":selected")),t.remove(),this.$select.children().each(function(e,i){var a=t.clone(!0);a.text($(i).text()),a.attr("data-text",$(i).text().toLowerCase()),a.attr("data-value",$(i).val()),this.$optionList.append(a)}.bind(this)),this.$el.addClass(this.$select[0].className).removeClass("dropdown-template").addClass("dropdown"),this.$label.append(this.$select),this.$el.attr("tabindex",this.$select.attr("tabindex")||"0"),this.$select.attr("tabindex",-1),this.$optionList.on("scroll",this.__onScroll.bind(this)),this.$select.on("change",this.__changedOption.bind(this)),this.$el.addClass("is-ready")},__fullHeight:function(){return this.$select.children().length*this.ITEM_HEIGHT},__getSelectedIndex:function(){return this.$select[0].selectedIndex},__getTopEdgeInViewport:function(e){return e.offset().top-$(this.document).scrollTop()},__getComputedInfo:function(){var e=this.__getTopEdgeInViewport(this.$el),t=this.__fullHeight(),i=this.__getSelectedIndex()*this.ITEM_HEIGHT,a=this.getDefaultBoundingBox().y,s=this.getDefaultBoundingBox().y+this.getDefaultBoundingBox().h,n=e-i,r=n+t,o=0;return n<a&&(n=a),r>s&&(o=r-s,r=s,n>a&&(n-=Math.min(n-a,o))),{projectedTopDiff:n-e,computedHeight:r-n,selectedTop:i,maxTop:a,maxBottom:s,fullHeight:t}},__refreshScrollers:function(){var e=this.$optionList[0].scrollHeight-this.$optionList.innerHeight(),t=0<this.$optionList.scrollTop();e=Math.round(this.$optionList.scrollTop())<e;this.$el.toggleClass("can-scroll-up",t).toggleClass("can-scroll-down",e)},isOpen:function(){return this.$el.hasClass("is-open")},__hide:function(){this.isOpen()&&($(this.window).off("resize.dropdown"),this.$el.removeClass("is-open"),this.$placeholder.before(this.$el).detach(),this.$el.removeAttr("style"))},__show:function(){if(!this.isOpen()){$(this.window).on("resize.dropdown",t);var e=this.$el.offset(),i=this.$el.width(),a=this.$el.height(),s=this.$el.css("margin-left"),n=this.$el.css("margin-right"),r=this.$el.css("margin-top"),o=this.$el.css("margin-bottom"),l=this.$el.css("float");this.$placeholder.css({width:i,height:a,"margin-left":s,"margin-right":n,"margin-top":r,"margin-bottom":o,float:l}),this.$el.addClass("is-open").css({top:this.__getTopEdgeInViewport(this.$el),left:e.left,width:i,height:a,"margin-left":0,"margin-right":0,"margin-top":0,"margin-bottom":0}),this.$el=this.$el.before(this.$placeholder).detach(),this.$dropdownLayer.append(this.$el)}},toggleOpen:function(e){return this.isOpen()?this.__hide():(this.__show(),e=this.__getComputedInfo(),this.$optionListContainer.css({top:e.projectedTopDiff,height:e.computedHeight}),this.$el.focus(),e=e.selectedTop+e.projectedTopDiff,this.$optionList.scrollTop(e),this.__lastScrollTop=e,this.setActiveElement(this.$(".dropdown-option").eq(this.__getSelectedIndex())),this.__refreshScrollers()),!1},refreshLabel:function(e){this.$label.find("> span").text(e.text()).toggleClass("no-value",""===e.val())},clickOption:function(e){this.__hide(),this.$select.val($(e.target).attr("data-value")),this.$select.trigger("change"),t(e)},selectByValue:function(e){this.$(".is-selected").removeClass("is-selected"),this.$('.dropdown-option[data-value="'+e+'"]').addClass("is-selected"),this.$("select").val(e),e=this.$("select").find(":selected"),this.refreshLabel(e)},val:function(){return this.$("select").val()},__changedOption:function(e){e=$(e.target).find(":selected"),this.refreshLabel(e)},__maybeScrollOptionIntoView:function(e,t){if(e[0]){var i=this.$el.hasClass("can-scroll-up"),a=this.$el.hasClass("can-scroll-down"),s=this.$optionList,n=s.height(),r=s.offset().top,o=r+n,l=e.outerHeight(),d=e.offset().top,c=d+l,h=d-r+s.scrollTop(),_=n/2-l/2*3;d<r+(i?l:0)?(t&&(h-=_),s.scrollTop(h-(i?this.ITEM_HEIGHT:0))):c>o-(a?l:0)&&(t&&(h+=_),s.scrollTop(h-(n-l)+(a?l:0)))}},__open:function(t){return this.isOpen()&&this.$select.val(this.$optionList.find(".is-selected").attr("data-value")).change(),this.toggleOpen(t),t=this.$optionList.children().eq(this.$select[0].selectedIndex),e.NextUtil.DomHelper.radioClass(t,"is-selected"),t},__moveSelection:function(t){return 0>(t=this.$optionList.children().index(this.$optionList.find(".is-selected"))+t)?t=0:t>this.$select.children().length-1&&(t=this.$select.children().length-1),t=this.$optionList.children().eq(t),e.NextUtil.DomHelper.radioClass(t,"is-selected"),t},setActiveElement:function(t){this.__activeElement=t,e.NextUtil.DomHelper.radioClass(t,"is-selected")},__onKeydown:function(i,s){if(!this.isOpen()&&a.is(s,"VK_ENTER")||!this.isOpen()&&a.is(s,"VK_DOWN"))t(this.$el),this.__open(s);else{var n=this.__activeElement&&this.__activeElement.parent()[0]===this.$optionList[0]?this.__activeElement:this.$(".dropdown-option").first();if(a.is(s,"VK_DOWN"))this.__maybeScrollOptionIntoView(n.next()),n.next()[0]&&this.setActiveElement(n.next());else if(a.is(s,"VK_UP"))this.__maybeScrollOptionIntoView(n.prev()),n.prev()[0]&&this.setActiveElement(n.prev());else if(a.is(s,"VK_ENTER"))this.__hide(),this.$select.val(this.__activeElement.attr("data-value")),this.$select.trigger("change"),t(s);else if(a.is(s,"VK_ESC"))t(this.$el);else{var r=a.getAlphaNumericChar(s);if(!1!==r){var o=n[0];this.__keyValueArray&&this.timer.clearTimeout(this.__keyValueArray),i.push(r);var l=i.join("").toLowerCase();for(this.__keyValueArray=this.timer.setTimeout(function(){i.length=0}.bind(this),1e3);o.nextSibling;)if(o=o.nextSibling,(r=$(o)).attr("data-text")[0]&&e.NextUtil.string.startsWith(r.attr("data-text"),l))return this.isOpen()||this.toggleOpen(s),this.setActiveElement(r),void this.__maybeScrollOptionIntoView(r,r[0]!=n[0].nextSibling&&r[0]!=n[0].prevSibling);for(o=this.$(".dropdown-option")[0];o&&o!=n[0];){if((r=$(o)).attr("data-text")[0]&&e.NextUtil.string.startsWith(r.attr("data-text"),l)){this.isOpen()||this.toggleOpen(s),this.setActiveElement(r),this.__maybeScrollOptionIntoView(r,r[0]!=n[0].nextSibling&&r[0]!=n[0].prevSibling);break}o=o.nextSibling}}}}},__onScroll:function(e){e=this.$optionList.scrollTop(),this.__refreshScrollers(),this.__lastScrollTop=e},__doScrollUp:function(e,t){var i=this.__getComputedInfo(),a=void 0===t?this.AUTO_SCROLL_BY:t;if(this.$optionListContainer.offset().top+this.$optionListContainer.height()+a<i.maxBottom){var s=this.$optionListContainer.height()+a;s>i.fullHeight&&(s=i.fullHeight),this.$optionListContainer.css({height:s}),this.$optionList[0].scrollTop-=a,this.__refreshScrollers(this.$dropdown)}else void 0===t&&(this.$optionList[0].scrollTop-=this.AUTO_SCROLL_BY)},__onScrollUpMouseenter:function(e){this.timer.clearInterval(this.__autoScrollInterval),this.__autoScrollIntervalCounter=0,this.__autoScrollInterval=this.timer.setInterval(function(){this.__doScrollUp(e)}.bind(this),1)},__onScrollUpMouseleave:function(e){this.timer.clearInterval(this.__autoScrollInterval)},__doScrollDown:function(e,t){var i=this.__getComputedInfo(),a=void 0===t?this.AUTO_SCROLL_BY:t;if((n=this.$optionListContainer.offset().top-a)>i.maxTop){var s=this.$optionListContainer.height()+a,n=this.$optionListContainer.position().top-a;s>i.fullHeight?s=i.fullHeight:this.$optionListContainer.css({top:n}),this.$optionListContainer.css({height:s}),this.$optionList[0].scrollTop+=a,this.__refreshScrollers(this.$dropdown)}else void 0===t&&(this.$optionList[0].scrollTop+=this.AUTO_SCROLL_BY)},__onScrollDownMouseenter:function(e){this.timer.clearInterval(this.__autoScrollDownInterval),this.__autoScrollDownIntervalCounter=0,this.__autoScrollDownInterval=this.timer.setInterval(function(){this.__doScrollDown(e)}.bind(this),1)},__onScrollDownMouseleave:function(e){this.timer.clearInterval(this.__autoScrollDownInterval)}})}({UiCore:e["@UiCore"],template:p,NextUtil:e["@NextUtil"]}),function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e){var t=this.escapeExpression;return'\n                        <option value="'+t("function"==typeof e?e.apply(e):e)+'">'+t("function"==typeof e?e.apply(e):e)+"</option>\n                        "},3:function(){return' checked="checked" '},5:function(e,t,i,a){var s;return'\n                    <option value="'+(t=this.escapeExpression)("function"==typeof(s=null==a||!1===a?a:a.key)?s.apply(e):s)+'">'+t("function"==typeof e?e.apply(e):e)+"</option>\n                    "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<div class="content-container">\n    <div class="error-block">\n        <ul>\n            <li class="error-message field-missing">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_field_missing",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</li>\n            <li class="error-message cardnumber-invalid">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_card_number_invalid",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</li>\n            <li class="error-message exp-date-expired">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_exp_date_expired",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</li>\n            <li class="error-message security-code-invalid">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_security_code_invalid",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</li>\n            <li class="error-message zip-invalid">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_zip_invalid",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</li>\n            <li class="error-message postal-invalid">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_postal_invalid",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</li>\n            <li class="error-message vip-checkbox-missing">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_vip_checkbox_unchecked",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</li>\n            <li class="error-message cardname-invalid">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"error_invalid_cc_name",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</li>\n        </ul>\n    </div>\n    <div class="payment-block">\n        <legend class="system-info-header">\n            ',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Payment Method",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='\n        </legend>\n\n        <div class="input-row card-number-container">\n            <div class="input-label">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Credit Card Number",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</div>\n            <input class=\'cardnumber\' tabindex=\'1\' required maxlength=\'20\' placeholder=\'XXXX-XXXX-XXXX-XXXX\'> \n            <div class="cardimages-container">\n                <div class="cardimage mastercard icon icon-cc-mastercard"></div> \n                <div class="cardimage visa icon icon-cc-visa"></div> \n                <div class="cardimage americanexpress icon icon-cc-amex"></div> \n                <div class="cardimage discover icon icon-cc-discover"></div> \n                <div class="cardimage jcb icon icon-cc-jcb"></div>\n            </div>\n        </div>\n        <div class="input-row">\n            <div class="half-row">\n                <div class="exp-date input-container">\n                    <div class="input-label">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Expiration",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</div>\n                    <div class='exp-date-container input-container'>\n                        <select class='exp-month' tabindex='2' required >\n                        <option selected value=\"\">",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Month",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</option>\n                        ",((s=t.each.call(e,e&&e.monthRange,{name:"each",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+="\n                        </select>\n                    </div>\n                    <div class='exp-date-container input-container'>\n                        <select class='exp-year' tabindex='3' required >\n                        <option selected value=\"\">",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Year",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</option>\n                        ",((s=t.each.call(e,e&&e.yearRange,{name:"each",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+="\n                        </select>\n                    </div>\n                </div>\n            </div>\n            <div class='input-container'>\n                <div class=\"input-label\">",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Security",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</div>\n                <div class="security-code-row">\n                    <input class=\'security-code\' tabindex=\'4\' required maxlength=\'4\' placeholder="CSC">\n                    <div class="icon icon-tooltip-icon security-code-help-link"></div>\n                    <div class="security-code-tooltip">\n                        <div class="tooltip-header">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"security_code_help_title",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</div>\n                        <div class="tooltip-body">\n                            <div class="icon icon-payment-csc"></div>\n                            <div>',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"security_code_help_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="input-row">\n            <input id=\'save-for-later-checkbox\' class="save-for-later checkbox" tabindex=\'13\' type="checkbox" \n            ',((s=t.if.call(e,e&&e.saveCard,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+=" ><label for='save-for-later-checkbox'>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Save For Later",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</label>\n        </div>\n    </div>\n    <div class="billing-address-block">\n        <legend class="system-info-header">\n            ',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Billing Information",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="\n        </legend>\n        <div class=\"input-row\">\n            <input class='name-on-card' maxlength='50' tabindex='5' required placeholder='",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Name on Card",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="'>\n        </div>\n        <div class=\"input-row\">\n            <input class='address' maxlength='50' tabindex='6' required placeholder='",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Address",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="'>\n        </div>\n        <div class=\"input-row\">\n            <input class='city' maxlength='20' tabindex='7' required placeholder='",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"City",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="'>\n            <div class='us-fields state-province-container input-container'>\n                <select class='state' tabindex='8' >\n                    <option selected value=\"\">",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"State",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</option>\n                    ",((s=t.each.call(e,e&&e.states,{name:"each",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+="\n                </select>\n            </div>\n            <div class='non-us-fields ca-province state-province-container input-container'>\n                <select class='province' tabindex='10'>\n                    <option selected value=\"\">",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Province",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</option>\n                    ",((s=t.each.call(e,e&&e.provinces,{name:"each",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+="\n                </select>\n            </div>\n            <input class='us-fields zip' maxlength='5' tabindex='9' placeholder='",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Zipcode",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="'>\n            <input class='non-us-fields postal' maxlength='12' tabindex='11' placeholder='",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Postal Code",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="'>\n            <div class='country-container input-container us'>\n                <select class='country' tabindex='12' required>\n                    <option value=''>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Country",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</option>\n                    ",((s=t.each.call(e,e&&e.countries,{name:"each",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+='\n                </select>\n            </div>\n        </div>\n    </div>\n</div>    \n\n<footer class="dialog-footer">\n    <button class="btn btn-primary continue-checkout">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Continue to Checkout",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</button>\n</footer>\n"},useData:!0})}()),u=function(e){var t=[{name:"americanexpress",pattern:/^3[47]/},{name:"jcb",pattern:/^35(2[89]|[3-8][0-9])/},{name:"visa",pattern:/^4/},{name:"mastercard",pattern:/^5[1-5]/},{name:"discover",pattern:/^(6011|622(12[6-9]|1[3-9][0-9]|[2-8][0-9]{2}|9[0-1][0-9]|92[0-5]|64[4-9])|65)/}];return{getType:function(e){for(var i=0;i<t.length;i++){var a=t[i];if(e.match(a.pattern))return a.name}return null},passesChecksum:function(e){for(var t=0,i=!1,a=e.length-1;0<=a;a--){var s=e.charAt(a);s=parseInt(s,10);i&&(9<(s*=2)&&(s-=9)),t+=s,i=!i}return 0==t%10}}}(),m=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<div class="back-button"></div>'},useData:!0})}(),v=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<div class="content-container">\n    <div class="content-container-content">\n        <legend class="system-info-header">\n            ';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Payment Method",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='\n        </legend>\n        <div class="info-block">\n            <div class="billing-info"></div>\n        </div>\n        <legend class="system-info-header">\n            ',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Cart",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='\n        </legend>\n        <div class="order-block">\n            <div class="order-list"></div>\n        </div>\n    </div>\n</div>\n\n<script type="text/template" class="dialog-footer-template">\n    <button class="btn btn-primary buy-now">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"BUY",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+=' <span class="item-count"></span> ',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ITEM FOR",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+' $<span class="order-total"></span></button>\n<\/script>'},useData:!0})}(),f=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s,n,r='\n<div class="info-line address">'+(i=this.escapeExpression)("function"==typeof(n=t.address||e&&e.address)?n.call(e,{name:"address",hash:{},data:a}):n)+'</div>\n<div class="info-line">'+i("function"==typeof(n=t.city||e&&e.city)?n.call(e,{name:"city",hash:{},data:a}):n)+", ";return((s=t.if.call(e,e&&e.state,{name:"if",hash:{},fn:this.program(2,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+=" ",((s=t.if.call(e,e&&e.postal_code,{name:"if",hash:{},fn:this.program(4,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+i("function"==typeof(n=t.country||e&&e.country)?n.call(e,{name:"country",hash:{},data:a}):n)+"</div>\n"},2:function(e,t,i,a){var s;return" "+(0,this.escapeExpression)("function"==typeof(s=t.state||e&&e.state)?s.call(e,{name:"state",hash:{},data:a}):s)+" "},4:function(e,t,i,a){var s;return" "+(0,this.escapeExpression)("function"==typeof(s=t.postal_code||e&&e.postal_code)?s.call(e,{name:"postal_code",hash:{},data:a}):s)+", "},6:function(e,t,i,a){var s,n;i=this.escapeExpression;var r=t.helperMissing,o='\n<div class="info-line card-type">'+i("function"==typeof(n=t.card_type||e&&e.card_type)?n.call(e,{name:"card_type",hash:{},data:a}):n)+" ";return((s=(n=t["i18n-g"]||e&&e["i18n-g"]||r).call(e,"ending in",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+" -"+i("function"==typeof(n=t.last_four_digits||e&&e.last_four_digits)?n.call(e,{name:"last_four_digits",hash:{},data:a}):n)+"</div>\n"},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s,n;return i='<div class="info-line name-on-card">'+(i=this.escapeExpression)("function"==typeof(n=t.name||e&&e.name)?n.call(e,{name:"name",hash:{},data:a}):n)+"</div>\n",((s=t.if.call(e,e&&e.address,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n",((s=t.if.call(e,e&&e.last_four_digits,{name:"if",hash:{},fn:this.program(6,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i},useData:!0})}(),b=function(e){var t=e.UiCore.UiContext;return t.extend("BillingInfo",{className:"billing-info",uiContextName:"billing_info",dependencies:["globalStringManager"],initialize:function(i){t.prototype.initialize.call(this,i),this.__billingInfo=IMVU.requireProperty(i,"billingInfo"),this.__CCValidator=e.CCValidator,this.addToDOM()},render:function(){var t="",i="";this.__billingInfo.credit_card&&(t=this.__CCValidator.getType(this.__billingInfo.credit_card),i=this.__billingInfo.credit_card.substring(this.__billingInfo.credit_card.length-4)),this.$el.html(e.template({name:this.__billingInfo.name,address:this.__billingInfo.address,city:this.__billingInfo.city,state:this.__billingInfo.state,postal_code:this.__billingInfo.postal_code,country:this.__billingInfo.country,card_type:this.__globalStringManager.get("card_type_"+(t||"other")),last_four_digits:i}))}})}({UiCore:e["@UiCore"],template:f,CCValidator:u}),y=(f=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n="<div class='alert-message'>";return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_pending_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+=" <a target='_blank' href='/next/settings/order'>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_pending_link_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</a>.</div>\n<div class='alert-message'>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_pending_after_link_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</div>\n"},useData:!0})}(),function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n="<div class='alert-message'>";return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_unknown_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+=" <a target='_blank' href='/next/settings/order'>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_unknown_link_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</a>.</div>\n<div class='alert-message'>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_unknown_after_link_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</div>\n"},useData:!0})}()),C=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s,n;i=t.helperMissing;var r=this.escapeExpression,o='<div class="content-container">\n    <div class="info-block message">\n        <div class="title">';return((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"order_thankyou",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='</div>\n        <div class="text">'+r("function"==typeof(n=t.status_message||e&&e.status_message)?n.call(e,{name:"status_message",hash:{},data:a}):n)+'</div>\n    </div>\n    <legend class="system-info-header">\n        ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"BILLED TO",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='\n    </legend>\n    <div class="info-block">\n        <div class="billing-info"></div>\n    </div>\n    <legend class="system-info-header">\n        ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"YOUR ORDER",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='\n    </legend>\n    <div class="order-block">\n        <div class="order-list"></div>\n    </div>\n    <div class="info-block">\n        <div>',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Order",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+=" #"+r("function"==typeof(n=t.order_id||e&&e.order_id)?n.call(e,{name:"order_id",hash:{},data:a}):n)+"</div>\n        <div>",((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Purchase date",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+=": "+r("function"==typeof(n=t.order_date||e&&e.order_date)?n.call(e,{name:"order_date",hash:{},data:a}):n)+'</div>\n        <div class="order-total">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"TOTAL",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+" $"+r("function"==typeof(n=t.order_total||e&&e.order_total)?n.call(e,{name:"order_total",hash:{},data:a}):n)+"</div>\n    </div>\n</div>"},useData:!0})}(),k=(C=function(e){var t=e.Dialogs.AlloyAlertDialog;return t.extend("PaymentSuccessDialog",{uiContextName:"payment_success_dialog",className:"payment-success-dialog dialog-type-B",dependencies:"billingInfo globalStringManager loginManager orderResponse originalCart timestampHelper".split(" "),__recordShown:!0,initialize:function(i){this.__stringManager=i.globalStringManager,this.__billingInfo=i.billingInfo,this.__orderResponse=i.orderResponse,this.__originalCart=i.originalCart,i.title=this.__stringManager.get("payment_success_title"),i.ok=this.__stringManager.get("payment_success_button"),this.__CCValidator=e.CCValidator,t.prototype.initialize.call(this,i),this.$el.removeClass("can-dismiss"),this.__loginManager.getCurrentUser().invalidate()},postRender:function(){t.prototype.postRender.call(this),this.__orderResponse.populated().then(function(){this.__cart=this.__filterCart();var t=this.__timestampHelper.orderDate(this.__orderResponse.get("order_date"));this.$(".id-body-contents").html(e.template({order_date:t,order_id:this.__orderResponse.get("order_id"),order_total:this.__orderTotal.toFixed(2),status_message:this.__stringManager.get("order_status_message",{product:this.__getProduct()})})),this.createChildContext(e.BillingInfo,{$replaceElement:this.$(".billing-info"),billingInfo:this.__billingInfo}),this.createChildContext(e.OrderList,{$replaceElement:this.$(".order-list"),cart:this.__originalCart}),this.$(".content-container").scrollbar()}.bind(this))},__filterCart:function(){var e=[];return this.__orderTotal=0,_.each(this.__originalCart,function(t){var i={};i.price=t.price,i.name=t.name,e.push(i),this.__orderTotal+=parseFloat(i.price)}.bind(this)),e},__getProduct:function(){var e=!1,t=!1;return _.each(this.__orderResponse.get("cart"),function(i){-1<i.product_name.toLowerCase().indexOf("credit")&&(t=!0),-1<i.product_name.toLowerCase().indexOf("vip")&&(e=!0)}.bind(this)),e&&t?this.__stringManager.get("Credits")+this.__stringManager.get("and")+this.__stringManager.get("VIP"):e&&!t?this.__stringManager.get("VIP"):!e&&t?this.__stringManager.get("Credits"):void 0}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],template:C,CCValidator:u,OrderList:h,BillingInfo:b}),function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n="<div class='alert-message'>";return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_processing_error_text_1",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</div>\n<div class='alert-message'>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_processing_error_text_2",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</div>\n<div class='alert-message'>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"payment_processing_error_text_3",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+" <a target='_blank' href='https://help.imvu.com'>www.imvu.com/help</a>.</div>\n"},useData:!0})}());f=function(e){var t=e.Dialogs.AlloyModalDialog;return t.extend("PaymentBaseDialog",{uiContextName:"payment_base_dialog",className:"payment-base-dialog dialog-type-B",dependencies:"dialogManager globalStartupModel globalStringManager leanplum loginManager prefsManager restModelFactory window".split(" "),initialize:function(e){t.prototype.initialize.call(this,e),this.__context=IMVU.optionalProperty(e,"context",null),this.__orderPostUrl=this.__globalStartupModel.get("accountOrdersUrl"),this.__loginManager.isLoggedIn()||(this.__window.onbeforeunload=null,this.__window.location.href=this.__siteRoot),this.__orderSuccess=!1},delete:function(){this.__closePaypalWindow(),this.promiseResolver&&this.promiseResolver.resolve(this.__orderSuccess),t.prototype.delete.call(this)},__destroy:function(){this.hide(),this.delete()},__filterCart:function(){var e=[];return _.each(this.__cart,function(t){var i={};i.price=t.price,i.sku=t.sku,i.pid=t.pid,i.type=t.type,e.push(i)}.bind(this)),e},__setProcessing:function(e){this.$(".buy-now").prop("disabled",e),this.$(".add-credit-card").prop("disabled",e),this.$(".paypal-checkout").prop("disabled",e),this.$el.toggleClass("loading",e),this.$(".payment-input").prop("disabled",e),this.$(".dialog-x").prop("disabled",e)},__openPaypalWindow:function(){this.__closePaypalWindow(),this.__paypalWindow=this.__window.open("/paypal/loading/","_blank")},__closePaypalWindow:function(){this.__paypalWindow&&(this.__paypalWindow.close(),this.__paypalWindow=null)},__displayPaypalOrderUpdate:function(){if(this.stopListening(this.__paypalOrderResponse),this.__closePaypalWindow(),!this.__orderStatus)switch(this.__orderStatus=this.__paypalOrderResponse.get("status"),this.__orderStatus){case"attempted":case"abandoned":break;case"external review":case"review":this.__displayPendingOrderDialog();break;case"validating":case"waiting for payment":case"being delivered":case"approved":case"paid":case"delivered":this.__displayPaypalSuccessDialog();break;case"rejected":case"failed cc check":case"blocked":this.__displayProcessingErrorDialog();break;default:this.__displayUnknownOrderDialog()}},__submitOrder:function(t){this.__restModelFactory.createModel(this.__orderPostUrl,e.UiCore.NodeModel,t).then(function(e){this.__setProcessing(!1),t.paypal_payment?"review"!==e.get("status")&&e.get("paypal_url")?this.__paypalWindow&&!this.__paypalWindow.closed&&(this.__paypalOrderResponse=e,this.__paypalWindow.location.href="https://www.paypal.com/cgi-bin/webscr?cmd=_express-checkout&useraction=commit&token="+e.get("paypal_url"),this.listenTo(this.__paypalOrderResponse,"change",this.__displayPaypalOrderUpdate)):(this.__leanplum.recordEvent("payment_error",{error:"paypal_error",type:t.cart[0].type,sku:t.cart[0].sku,price:t.cart[0].price,pid:t.cart[0].pid}),this.__displayProcessingErrorDialog(),this.__closePaypalWindow()):(this.__displayPaymentSuccessDialog(t,e),t.cc_payment&&this.__prefsManager.populated().then(function(){var e=this.__prefsManager.getBool("next.payment.creditcard.save_card.disable"),i=!t.cc_payment.save_card;i!==e&&this.__prefsManager.setBool("next.payment.creditcard.save_card.disable",i)}.bind(this)))}.bind(this)).catch(function(e){switch(this.__setProcessing(!1),this.__closePaypalWindow(),e.error&&"Not authorized for request"===e.error.message&&(this.__leanplum.recordEvent("payment_error",{error:"not authorized",type:t.cart[0].type,sku:t.cart[0].sku,price:t.cart[0].price,pid:t.cart[0].pid}),this.__window.onbeforeunload=null,this.__window.location.href=this.__siteRoot),this.__errorType="Unknown",e.error&&e.error.error&&(this.__errorType=e.error.error,this.__errorMessage=e.error.message),this.__leanplum.recordEvent("payment_error",{error:this.__errorType,type:t.cart[0].type,sku:t.cart[0].sku,price:t.cart[0].price,pid:t.cart[0].pid}),this.__errorType){case"ACCOUNT_ORDER_PENDING":t.paypal_payment?this.__displayProcessingErrorDialog():this.__displayPendingOrderDialog();break;case"ACCOUNT_ORDER_PRICE_DISCREPANCY":case"ACCOUNT_ORDER_INVALID_STORE_PRODUCT":case"ACCOUNT_ORDER_EMPTY_CART":this.__displayInvalidPriceDialog();break;case"ACCOUNT_ORDER_FAILURE":case"ACCOUNT_ORDER_INVALID_COUNTRY_CODE":case"INBOUND VALIDATION-001":case"ACCOUNT_ORDER_INVALID_CARD_NUMBER":this.__displayFailedOrderDialog();break;case"ACCOUNT_ORDER_BLOCKED":case"ACCOUNT_ORDER_PAYPAL_SUBMIT_PAYMENT":case"ACCOUNT_ORDER_PAYPAL_PAYMENT_INFO":this.__displayProcessingErrorDialog();break;default:this.__displayUnknownOrderDialog()}}.bind(this))},__displayPaypalSuccessDialog:function(){this.__displayPaymentSuccessDialog({paypal_payment:!0},this.__paypalOrderResponse)},__displayPaymentSuccessDialog:function(t,i){var a;return this.__leanplum.recordEvent("payment_success",{type:t.cart[0].type,sku:t.cart[0].sku,price:t.cart[0].price,pid:t.cart[0].pid}),this.__orderSuccess=!0,t.cc_payment?a=t.cc_payment:t.paypal_payment?a={name:"Paypal"}:t.saved_cc_payment&&(a={card_type:this.__selectedCard.get("card_type"),name:this.__selectedCard.get("name"),last_four_digits:this.__selectedCard.get("card_last_digits")}),this.__dialogManager.showDialog(e.PaymentSuccessDialog,{billingInfo:a,orderResponse:i,originalCart:this.__cart}).finished.then(function(e){this.__checkForVerifiedEmailAndExit()}.bind(this)).catch(function(e){this.__checkForVerifiedEmailAndExit()}.bind(this))},__checkForVerifiedEmailAndExit:function(){this.__loginManager.getCurrentUser().populated().then(function(e){e.get("is_email_verified")?this.__destroy():this.__displayEmailVerificationDialog()}.bind(this))},__displayEmailVerificationDialog:function(){return this.__dialogManager.alert({title:this.__globalStringManager.get("verify_email_dialog_title"),text:this.__globalStringManager.get("verify_email_dialog_text")}).finished.then(function(e){this.__destroy()}.bind(this)).catch(function(e){this.__destroy()}.bind(this))},__displayInvalidPriceDialog:function(){return this.__dialogManager.alert({title:this.__globalStringManager.get("payment_invalid_price_title"),text:this.__globalStringManager.get("payment_invalid_price_text"),ok:this.__globalStringManager.get("payment_invalid_price_button")}).finished.then(function(e){this.__destroy()}.bind(this)).catch(function(e){this.__destroy()}.bind(this))},__displayFailedOrderDialog:function(){return this.__dialogManager.alert({title:this.__globalStringManager.get("payment_failed_title"),text:this.__globalStringManager.get("payment_failed_text"),ok:this.__globalStringManager.get("payment_failed_button")}).finished},__displayUnknownOrderDialog:function(){return this.__dialogManager.alert({title:this.__globalStringManager.get("payment_unknown_title"),html:e.UnknownOrderDialog({}),ok:this.__globalStringManager.get("payment_unknown_button")}).finished.then(function(e){this.__destroy()}.bind(this)).catch(function(e){this.__destroy()}.bind(this))},__displayProcessingErrorDialog:function(){return this.__dialogManager.alert({title:this.__globalStringManager.get("payment_processing_error_title"),html:e.ProcessingErrorDialog({}),ok:this.__globalStringManager.get("payment_processing_error_button")}).finished.then(function(e){this.__destroy()}.bind(this)).catch(function(e){this.__destroy()}.bind(this))},__displayPendingOrderDialog:function(){return this.__dialogManager.alert({title:this.__globalStringManager.get("payment_pending_title"),html:e.PendingOrderDialog({}),ok:this.__globalStringManager.get("payment_pending_button")}).finished.then(function(e){this.__destroy()}.bind(this)).catch(function(e){this.__destroy()}.bind(this))}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],PaymentSuccessDialog:C,PendingOrderDialog:f,ProcessingErrorDialog:k,UnknownOrderDialog:y}),v=function(e){var t=e.PaymentBaseDialog;return t.extend("CreditCardPaymentReviewDialog",{uiContextName:"credit_card_payment_review_dialog",className:"credit-card-payment-review-dialog dialog-type-B",dependencies:"globalStartupModel globalStringManager dialogManager channel billingInfo cart orderTotal itemCount restModelFactory".split(" "),trackedEvents:function(){return[{type:"click",selector:".buy-now",name:"buy_now",handler:this.__creditCardCheckout},{type:"click",selector:".back-button",name:"back_button",handler:this.__goBack}]},initialize:function(e){t.prototype.initialize.call(this,e),this.$el.removeClass("can-dismiss"),this.title=this.__globalStringManager.get("credit_card_review_title"),this.addToDOM()},postRender:function(){"desktop"===this.serviceProvider.get("platform")&&this.$(".dialog-header").prepend(e.backButtonTemplate({})),this.setContent("body",e.template),this.setContent("footer",this.$(".dialog-footer-template").text()),this.createChildContext(e.BillingInfo,{$replaceElement:this.$(".billing-info"),billingInfo:this.__billingInfo}),this.createChildContext(e.OrderList,{$replaceElement:this.$(".order-list"),cart:this.__cart}),this.$(".order-total").text(this.__orderTotal.toFixed(2)),this.$(".item-count").text(this.__itemCount),this.$(".content-container").scrollbar()},__creditCardCheckout:function(){this.__setProcessing(!0);var e={cart:this.__filterCart(),channel:this.__channel,payment_method:"cc_payment",cc_payment:this.__billingInfo};this.__submitOrder(e)},__goBack:function(){this.hide(),this.promiseResolver.reject()}})}({UiCore:e["@UiCore"],PaymentBaseDialog:f,template:v,CCValidator:u,OrderList:h,BillingInfo:b,backButtonTemplate:m}),b=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n="<div class='alert-message'><img src='/catalog/web_images/veri_code.gif'></div>\n\n<div class='alert-message'>";return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"security_code_help_text",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</div>\n"},useData:!0})}(),g=function(e){var t=e.Dialogs.AlloyModalDialog;return t.extend("AddCreditCardDialog",{uiContextName:"add_credit_card_dialog",className:"add-credit-card-dialog dialog-type-B",dependencies:"channel cart dialogManager featureAccessManager globalStringManager itemCount leanplum loginManager orderTotal prefsManager timer window".split(" "),trackedEvents:function(){return[{type:"click",selector:".continue-checkout",name:"continue_checkout",handler:this.__continueCheckout},{type:"keyup",selector:".cardnumber",name:"changing_cardnumber",handler:this.__isBlankCardNumber},{type:"blur",selector:".cardnumber",name:"changed_cardnumber",handler:this.__validateCardNumber},{type:"change",selector:".exp-month",name:"change_exp_month_select",handler:this.__validateExpMonth},{type:"change",selector:".exp-year",name:"change_exp_year_select",handler:this.__validateExpYear},{type:"keyup",selector:".security-code",name:"changing_security_code",handler:this.__isBlankSecurityCode},{type:"blur",selector:".security-code",name:"changed_security_code",handler:this.__validateSecurityCode},{type:"keyup",selector:".name-on-card",name:"changing_name",handler:this.__isBlankNameOnCard},{type:"blur",selector:".name-on-card",name:"changed_name",handler:this.__validateNameOnCard},{type:"keyup",selector:".address",name:"changing_address",handler:this.__isBlankAddress},{type:"blur",selector:".address",name:"changed_address",handler:this.__validateAddress},{type:"keyup",selector:".city",name:"change_city",handler:this.__isBlankCity},{type:"blur",selector:".city",name:"change_city",handler:this.__validateCity},{type:"change",selector:".state",name:"change_state_select",handler:this.__validateState},{type:"keyup",selector:".zip",name:"changing_zip",handler:this.__isBlankZip},{type:"blur",selector:".zip",name:"changed_zip",handler:this.__validateZip},{type:"change",selector:".province",name:"change_province_select",handler:this.__validateProvince},{type:"keyup",selector:".postal",name:"changing_postal",handler:this.__isBlankPostal},{type:"blur",selector:".postal",name:"changed_postal",handler:this.__validatePostal},{type:"change",selector:".country",name:"change_country_select",handler:this.__validateCountry},{type:"click",selector:".back-button",name:"back_button",handler:this.__goBack}]},initialize:function(i){t.prototype.initialize.call(this,i),this.shouldFocusOnPrimaryButton=!1,i.loginManager.isLoggedIn()||(this.__window.onbeforeunload=null,this.__window.location.href=this.__siteRoot),this.title=this.__globalStringManager.get("Add New Credit Card"),this.__monthRange="01 02 03 04 05 06 07 08 09 10 11 12".split(" "),this.__getYearRange(),this.__states=e.StateMap,this.__provinces=e.ProvinceMap,this.__countries=e.CountryMap,this.__CCValidator=e.CCValidator,this.__missingFields=[],this.addToDOM()},delete:function(){t.prototype.delete.call(this),this.__tooltip&&this.__tooltip.delete()},__destroy:function(){this.hide(),this.delete()},postRender:function(){"desktop"===this.serviceProvider.get("platform")&&this.$(".dialog-header").prepend(e.backButtonTemplate({})),this.__prefsManager.populated().then(function(){this.setContent("body",e.template,{monthRange:this.__monthRange,yearRange:this.__yearRange,states:this.__states,provinces:this.__provinces,countries:this.__countries,saveCard:!this.__prefsManager.getBool("next.payment.creditcard.save_card.disable")}),this.$(".non-us-fields").hide(),this.$('.country option[value="US"]').prop("selected",!0),this.createChildContext(e.Dropdown,{$replaceElement:this.$(".exp-month")}),this.createChildContext(e.Dropdown,{$replaceElement:this.$(".exp-year")}),this.createChildContext(e.Dropdown,{$replaceElement:this.$(".state")}),this.createChildContext(e.Dropdown,{$replaceElement:this.$(".province")}),this.createChildContext(e.Dropdown,{$replaceElement:this.$(".country")}),this.$(".content-container").scrollbar(),this.__tooltip=this.serviceProvider.create(e.Tooltip,{$replaceElement:this.$(".security-code-tooltip"),$tooltipTarget:this.$(".security-code-help-link")})}.bind(this))},__getYearRange:function(){this.__yearRange=[];for(var e=this.__timer.getDate().getFullYear(),t=0;20>t;t++)this.__yearRange.push(t+e)},__validateInputs:function(){this.__validateCardNumber(),this.__validateSecurityCode(),this.__validateExpMonth(),this.__validateExpYear(),this.__validateNameOnCard(),this.__validateCardName(),this.__validateAddress(),this.__validateCity(),this.__validateCountry(),"US"===this.$(".country select").val()?(this.__validateZip(),this.__validateState()):"CA"===this.$(".country select").val()&&(this.__validatePostal(),this.__validateProvince())},__errorIfBlank:function(e,t){var i=t?""===this.$("."+e+" select").val():""===this.$("."+e).val().trim();return this.__updateMissingFields(e,i),i},__updateMissingFields:function(e,t){this.$("."+e).toggleClass("payment-error",t);var i=this.__missingFields.indexOf(e);t&&0>i?this.__missingFields.push(e):!t&&-1<i&&this.__missingFields.splice(i,1),this.$(".field-missing").toggleClass("error-visible",0!==this.__missingFields.length)},__isBlankCardNumber:function(e){-1<this.__missingFields.indexOf("cardnumber")&&this.__errorIfBlank("cardnumber"),this.__displayCardIcon(this.$(".cardnumber").val()),this.__updateErrorStatus()},__validateCardNumber:function(){if(this.__errorIfBlank("cardnumber"))this.$(".cardnumber-invalid").removeClass("error-visible");else{this.__leanplum.recordEvent("add_cc_cc_change");var e=this.$(".cardnumber").val().replace(/[ \-]/g,"");e.match(/^\d{13,16}$/)&&this.__CCValidator.passesChecksum(e)?(this.$(".cardnumber-invalid").removeClass("error-visible"),this.$(".cardnumber").removeClass("payment-error")):(this.$(".cardnumber-invalid").addClass("error-visible"),this.$(".cardnumber").addClass("payment-error"))}this.__updateErrorStatus()},__validateCardName:function(){var e=this.$(".name-on-card").val().trim(),t=e.trim().split(/\s+/).length;/\d/.test(e)||2>t?(this.$(".cardname-invalid").addClass("error-visible"),this.$(".name-on-card").addClass("payment-error")):(this.$(".cardname-invalid").removeClass("error-visible"),this.$(".name-on-card").removeClass("payment-error")),this.__updateErrorStatus()},__displayCardIcon:function(e){(e=this.__CCValidator.getType(e))?(this.$(".cardimage").addClass("card-number-present"),this.$(".cardimage."+e).addClass("card-type-active")):(this.$(".cardimage").removeClass("card-number-present"),this.$(".cardimage").removeClass("card-type-active")),this.__updateErrorStatus()},__isBlankSecurityCode:function(){-1<this.__missingFields.indexOf("security-code")&&this.__errorIfBlank("security-code"),this.__updateErrorStatus()},__validateSecurityCode:function(){this.__errorIfBlank("security-code")?this.$(".security-code-invalid").removeClass("error-visible"):(this.__leanplum.recordEvent("add_cc_security_code_change"),this.$(".security-code").val().trim().match(/^\d\d\d\d?$/)?(this.$(".security-code-invalid").removeClass("error-visible"),this.$(".security-code").removeClass("payment-error")):(this.$(".security-code-invalid").addClass("error-visible"),this.$(".security-code").addClass("payment-error"))),this.__updateErrorStatus()},__validateExpMonth:function(){this.__errorIfBlank("exp-month",!0)||(this.__leanplum.recordEvent("add_cc_exp_month_change"),this.__validateExpDate()),this.__updateErrorStatus()},__validateExpYear:function(){this.__errorIfBlank("exp-year",!0)||(this.__leanplum.recordEvent("add_cc_exp_year_change"),this.__validateExpDate()),this.__updateErrorStatus()},__validateExpDate:function(){var e=parseInt(this.$(".exp-year select").val(),10),t=parseInt(this.$(".exp-month select").val(),10);if(0<e&&0<t){var i=(a=this.__timer.getDate()).getFullYear(),a=a.getMonth()+1;i>e||i===e&&a>t?(this.$(".exp-date-expired").addClass("error-visible"),this.$(".exp-month").addClass("payment-error"),this.$(".exp-year").addClass("payment-error")):(this.$(".exp-date-expired").removeClass("error-visible"),this.$(".exp-month").removeClass("payment-error"),this.$(".exp-year").removeClass("payment-error"))}else this.$(".exp-date-expired").removeClass("error-visible");this.__updateErrorStatus()},__isBlankNameOnCard:function(){-1<this.__missingFields.indexOf("name-on-card")&&this.__errorIfBlank("name-on-card"),this.__updateErrorStatus()},__validateNameOnCard:function(){this.__errorIfBlank("name-on-card"),this.__updateErrorStatus()},__isBlankAddress:function(){-1<this.__missingFields.indexOf("address")&&this.__errorIfBlank("address"),this.__updateErrorStatus()},__validateAddress:function(){this.__errorIfBlank("address"),this.__leanplum.recordEvent("add_cc_address_change"),this.__updateErrorStatus()},__isBlankCity:function(){-1<this.__missingFields.indexOf("city")&&this.__errorIfBlank("city"),this.__updateErrorStatus()},__validateCity:function(){this.__errorIfBlank("city"),this.__updateErrorStatus()},__validateState:function(){this.__errorIfBlank("state",!0),this.__leanplum.recordEvent("add_cc_state_change"),this.__updateErrorStatus()},__validateProvince:function(){this.__errorIfBlank("province",!0),this.__leanplum.recordEvent("add_cc_province_change"),this.__updateErrorStatus()},__isBlankZip:function(){-1<this.__missingFields.indexOf("zip")&&this.__errorIfBlank("zip"),this.__updateErrorStatus()},__validateZip:function(){this.__errorIfBlank("zip")?this.$(".zip-invalid").removeClass("error-visible"):(this.__leanplum.recordEvent("add_cc_zip_change"),this.$(".zip").val().trim().match(/^\d\d\d\d\d$/)?(this.$(".zip-invalid").removeClass("error-visible"),this.$(".zip").removeClass("payment-error")):(this.$(".zip-invalid").addClass("error-visible"),this.$(".zip").addClass("payment-error"))),this.__updateErrorStatus()},__isBlankPostal:function(){"CA"===this.$(".country select").val()&&-1<this.__missingFields.indexOf("postal")&&this.__errorIfBlank("postal"),this.__updateErrorStatus()},__validatePostal:function(){"CA"===this.$(".country select").val()&&(this.__leanplum.recordEvent("add_cc_postal_change"),this.__errorIfBlank("postal")?this.$(".postal-invalid").removeClass("error-visible"):this.$(".postal").val().trim().match(/^[A-Za-z]\d[A-Za-z]\s*\d[A-Za-z]\d$/)?(this.$(".postal-invalid").removeClass("error-visible"),this.$(".postal").removeClass("payment-error")):(this.$(".postal-invalid").addClass("error-visible"),this.$(".postal").addClass("payment-error"))),this.__updateErrorStatus()},__validateCountry:function(){this.__leanplum.recordEvent("add_cc_country_change"),this.$(".zip-invalid").removeClass("error-visible"),this.$(".postal-invalid").removeClass("error-visible"),this.__updateMissingFields("zip",!1),this.__updateMissingFields("state",!1),this.__updateMissingFields("postal",!1),this.__updateMissingFields("province",!1),this.__errorIfBlank("country",!0),"US"===this.$(".country select").val()?(this.$(".us-fields").show(),this.$(".non-us-fields").hide(),this.$(".country-container").addClass("us"),this.$(".postal").val(""),this.$('.ca-province option[value=""]').prop("selected",!0)):(this.$(".country-container").removeClass("us"),this.$(".us-fields").hide(),this.$(".zip").val(""),this.$('.state option[value=""]').prop("selected",!0),this.$(".non-us-fields").show(),"CA"===this.$(".country select").val()?(this.$(".ca-province").show(),this.$(".country-container").addClass("canada"),this.$(".postal").removeClass("intl")):(this.$(".postal").addClass("intl"),this.$(".ca-province").hide(),this.$('.ca-province option[value=""]').prop("selected",!0),this.$(".country-container").removeClass("canada"))),this.__updateErrorStatus()},__updateErrorStatus:function(){this.$(".error-block").toggleClass("has-error",0<this.$(".error-visible").length)},__continueCheckout:function(){this.__validateInputs(),0<this.$(".payment-error").length?this.$(".dialog-body").scrollTop(0):this.__dialogManager.showDialog(e.CreditCardPaymentReviewDialog,{billingInfo:this.__getBillingInfo(),channel:this.__channel,cart:this.__cart,orderTotal:this.__orderTotal,itemCount:this.__itemCount}).finished.then(function(e){this.promiseResolver.accept(),this.__destroy()}.bind(this)).catch(function(e){}.bind(this))},__getBillingInfo:function(){var e=this.$(".country select").val(),t=this.$(".state select").val(),i=this.$(".zip").val().trim();return"CA"===e?(t=this.$(".province select").val(),i=this.$(".postal").val().trim()):"US"!==e&&(t="",i=this.$(".postal").val().trim()),{name:this.$(".name-on-card").val().trim(),address:this.$(".address").val().trim(),city:this.$(".city").val().trim(),state:t,postal_code:i,country:e,credit_card:this.$(".cardnumber").val().replace(/[ \-]/g,""),exp_month:this.$(".exp-month select").val(),exp_year:this.$(".exp-year select").val(),cvc:this.$(".security-code").val().trim(),save_card:this.$("#save-for-later-checkbox").prop("checked")}},__goBack:function(){this.hide(),this.promiseResolver.reject()}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],template:g,SecurityCodeHelpDialog:b,CountryMap:e["json!/common/js/JSON/Countries.json"],StateMap:e["json!/common/js/JSON/States.json"],ProvinceMap:e["json!/common/js/JSON/Provinces.json"],Dropdown:p,CCValidator:u,Tooltip:r,CreditCardPaymentReviewDialog:v,backButtonTemplate:m}),u=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s,n,r=this.escapeExpression;return i=t.helperMissing,r='<div class="card-row">\n    <div class="card-wrap">\n        <div class="card-info">\n            <div class="number">XXXX-XXXX-XXXX-'+r("function"==typeof(n=t.cardNumber||e&&e.cardNumber)?n.call(e,{name:"cardNumber",hash:{},data:a}):n)+'</div>\n            <div><span class="type">'+r("function"==typeof(n=t.type||e&&e.type)?n.call(e,{name:"type",hash:{},data:a}):n)+'</span></div>\n        </div>\n        <div class="primary">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Primary",{name:"i18n-g",hash:{},data:a}))||0===s)&&(r+=s),r+='</div>\n        <div class="context">\n            <span class="icon icon-action-more context-menu-button"></span>\n        </div>\n    </div>\n    <div class="primary">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Primary",{name:"i18n-g",hash:{},data:a}))||0===s)&&(r+=s),r+"</div>\n</div>"},useData:!0})}(),m=function(t){var i={UiCore:e["@UiCore"]}.UiCore.UiContext;return i.extend("ContextMenu",{uiContextName:"context_menu",tagName:"ul",className:"context-menu",trackedEvents:function(){return[{type:"click",selector:"li",name:"context_menu_item",handler:"__chooseMenuItem",attributes:function(e){return{which:e.attr("data-menu-item")}}}]},initialize:function(e){i.prototype.initialize.call(this,e),this.__items=IMVU.requireProperty(e,"items"),this.location=IMVU.requireProperty(e,"location"),this.__closeOnScroll=void 0===e.closeOnScroll||e.closeOnScroll,this.addToDOM()},render:function(){_.each(this.__items,function(e){var t=$("<li />");t.attr("data-menu-item",e.name).text(e.text).addClass(e.classNames).toggleClass("divider",!!e.divider),this.$el.append(t)}.bind(this))},__chooseMenuItem:function(e){var t=$(e.currentTarget).data("menu-item"),i=_.find(this.__items,function(e){return e.name===t}).handler;i&&i.call(this,e),this.trigger("item-chosen")},shouldCloseOnScroll:function(){return!this.__closeOnScroll}})}(),u=function(e){var t=e.UiCore.UiContext;return t.extend("SavedCreditCardListItem",{className:"saved-credit-card-list-item",uiContextName:"saved_credit_card_list_item",tagName:"li",dependencies:"context contextMenuManager dialogManager globalStringManager rest selectedCard".split(" "),trackedEvents:function(){return[{type:"click",name:"select_card",handler:this.__selectCard},{type:"click",name:"show_context_menu",selector:".context-menu-button",handler:this.__showContextMenu}]},initialize:function(e){t.prototype.initialize.call(this,e),this.addToDOM(),this.listenTo(this.model,"select",this.__selectCard)},render:function(){this.model.populated().then(function(){var t=this.model.get("card_type")?this.model.get("card_type"):"other";this.__cardTypeString=this.__globalStringManager.get("card_type_"+t),this.$el.html(e.template({cardNumber:this.model.get("card_last_digits"),type:this.__cardTypeString})),this.model.get("is_primary")&&this.$el.addClass("is-primary"),null!==this.__selectedCard&&this.model.get("is_primary")&&this.__selectCard()}.bind(this))},__showContextMenu:function(t){var i=this.model.get("is_primary")?[{name:"delete_card",text:this.__globalStringManager.get("Delete"),handler:this.__deleteCard.bind(this)}]:[{name:"make_primary",text:this.__globalStringManager.get("Make Primary"),handler:this.__makePrimary.bind(this)},{name:"delete_card",text:this.__globalStringManager.get("Delete"),handler:this.__deleteCard.bind(this)}];this.__contextMenuManager.showMenu(t,e.ContextMenu,{items:i,displayOptions:{above:!1,right:!1}})},__selectCard:function(){e.NextUtil.DomHelper.radioClass(this.$el,"selected-card"),null!==this.__selectedCard&&(this.__selectedCard.set({id:parseInt(this.model.id.match(/\d+/)[0].replace("saved_card-","")),card_type:this.__cardTypeString,name:this.model.get("name"),card_last_digits:this.model.get("card_last_digits")}),this.__selectedCard.trigger("selected"))},__makePrimary:function(){this.$el.hasClass("is-primary")||this.model.save({default:!0}).then(function(){this.$el.addClass("is-primary")}.bind(this))},__deleteCard:function(){this.__dialogManager.confirm({title:this.__globalStringManager.get("Delete Payment Method"),text:this.__globalStringManager.get("Are you sure you want to delete this payment method?"),yes:this.__globalStringManager.get("Delete"),no:this.__globalStringManager.get("Cancel")}).finished.then(function(){this.__selectedCard&&null!==this.__selectedCard.get("id")&&this.__selectedCard.get("id")===parseInt(this.model.id.match(/\d+/)[0].replace("saved_card-",""))&&(this.__selectedCard=new IMVU.NamedModel({id:null}),this.__context.trigger("selected_card_deleted")),this.__rest.delete(this.model.id),this.__context.trigger("card_deleted"),this.delete()}.bind(this))}})}({UiCore:e["@UiCore"],NextUtil:e["@NextUtil"],template:u,ContextMenu:m}),u=function(e){var t=e.UiCore.ListPresenter;return t.extend("SavedCreditCardList",{className:"saved-credit-card-list",uiContextName:"saved_credit_card_list",tagName:"ul",itemFactory:e.SavedCreditCardListItem,dependencies:["globalStringManager"],initialize:function(e){t.prototype.initialize.call(this,e),this.__showEmptyText=IMVU.optionalProperty(e,"showEmptyText",!1)},__emptyText:function(){if(this.$el.addClass("is-empty"),this.__showEmptyText)return{standard:this.__globalStringManager.get("No Saved Card"),concise:this.__globalStringManager.get("No Saved Card")}}})}({UiCore:e["@UiCore"],SavedCreditCardListItem:u}),h=function(e){var t=e.PaymentBaseDialog;return t.extend("PaymentDialog",{uiContextName:"payment_dialog",className:"payment-dialog dialog-type-B",dependencies:"cart dialogManager globalStringManager globalStartupModel googleAnalytics leanplum platform restModelFactory".split(" "),trackedEvents:function(){return[{type:"change",selector:".vip",name:"vip_checkbox_changed",handler:"__validateVipCheckbox"},{type:"click",selector:".core-store-link",name:"go_to_core_store",handler:"__goToCoreStore",allowBubble:!0},{type:"click",selector:".add-credit-card",name:"add_credit_card",handler:"__addCreditCard"},{type:"click",selector:".paypal-checkout",name:"paypal_checkout",handler:"__paypalCheckout"},{type:"click",selector:".buy-now",name:"buy_now",handler:"__creditCardCheckout"}]},initialize:function(e){t.prototype.initialize.call(this,e),this.title=this.__globalStringManager.get("payment_dialog_title"),this.shouldFocusOnPrimaryButton=!1,this.__channel=IMVU.optionalProperty(e,"channel","unknown"),this.__platformId=(this.__isMobile="mobile"===this.__platform)?10:9,this.__selectedCard=new IMVU.NamedModel({id:null}),this.listenTo(this.__selectedCard,"selected",this.__toggleCheckoutButton.bind(this,!0)),this.listenTo(this,"selected_card_deleted",this.__toggleCheckoutButton.bind(this,!1)),this.addToDOM()},postRender:function(){this.__validateCart(),this.setContent("body",e.template,{hasVip:this.__hasVip,platformId:this.__platformId,itemCount:this.__cart.length,showTotal:1<this.__cart.length}),this.setContent("footer",this.$(".dialog-footer-template").text()),this.__invalidProduct?(this.$(".buy-now").prop("disabled",!0),this.$(".invalid-product").addClass("error-visible")):this.createChildContext(e.OrderList,{$replaceElement:this.$(".order-list-placeholder"),cart:this.__cart}),this.__toggleCheckoutButton(!1),this.__savedCreditCards=this.track(this.__restModelFactory.readCollection(this.__globalStartupModel.get("savedCreditCardUrl"),e.UiCore.NodeCollection)),this.listenTo(this.__savedCreditCards,"reset",this.__loadSavedCard),this.__loadSavedCard(),this.$(".order-total").text(this.__orderTotal.toFixed(2)),this.$(".item-count").text(this.__itemCount),this.__hasVip&&this.createChildContext(e.Tooltip,{$replaceElement:this.$(".vip-toc-tooltip"),$tooltipTarget:this.$(".vip-toc-link")}),this.$(".content-container").scrollbar()},__toggleCheckoutButton:function(e){this.$(".buy-now").prop("disabled",!e)},__validateCart:function(){return this.__itemCount=this.__orderTotal=0,this.__invalidProduct=this.__hasVip=!1,0===this.__cart.length&&(this.__invalidProduct=!0),_.each(this.__cart,function(e){!e.name||!e.sku||!e.price||0>e.price?this.__invalidProduct=!0:0<e.sku.indexOf(".vip.")&&(this.__hasVip=!0),this.__itemCount++,this.__orderTotal+=e.price,e.price=e.price.toFixed(2)}.bind(this)),!this.__invalidProduct},__validateVipCheckbox:function(){this.$(".vip").prop("checked")?(this.$(".vip-checkbox-missing").removeClass("error-visible"),this.$(".vip-block label").removeClass("payment-error")):(this.$(".vip-checkbox-missing").addClass("error-visible"),this.$(".vip-block label").addClass("payment-error")),this.__updateErrorStatus()},__updateErrorStatus:function(){this.$(".error-block").toggleClass("has-error",0<this.$(".error-visible").length)},__scrollTop:function(){this.$(".content-container").scrollTop(0)},__creditCardCheckout:function(){this.__hasVip&&this.__validateVipCheckbox(),0<this.$(".payment-error").length?this.__scrollTop():(this.__leanplum.recordEvent("dollar_store_buy_start",{type:this.__cart[0].type,sku:this.__cart[0].sku,price:this.__cart[0].price,pid:this.__cart[0].pid}),this.__googleAnalytics.recordDollarStore("buy",this.__cart[0].sku),this.__setProcessing(!0),this.__submitOrder(this.__createSavedCreditCardOrder()))},__createSavedCreditCardOrder:function(){return{cart:this.__filterCart(),channel:this.__channel,payment_method:"saved_cc_payment",saved_cc_payment:{id:this.__selectedCard.get("id")}}},__paypalCheckout:function(){this.__hasVip&&this.__validateVipCheckbox(),0<this.$(".payment-error").length?this.__scrollTop():(this.__setProcessing(!0),this.__openPaypalWindow(),this.__submitOrder({cart:this.__filterCart(),channel:this.__channel,payment_method:"paypal_payment",paypal_payment:{}}))},__goToCoreStore:function(){},__loadSavedCard:function(){this.__savedCreditCards.populated().then(function(){this.$(".savedcard-container").html("");var t=_.filter(this.__savedCreditCards.models,function(e){return"co"!==e.attributes.system}.bind(this));t=new IMVU.NamedCollection(t);this.__savedCard=this.createChildContext(e.SavedCreditCardList,{$parentElement:this.$(".savedcard-container"),collection:t,context:this,selectedCard:this.__selectedCard});var i=!1;_.each(t.models,function(e){e.get("is_primary")&&(i=!0)}),!i&&0<t.models.length&&t.models[0].trigger("select")}.bind(this))},__addCreditCard:function(){if(this.__hasVip&&this.__validateVipCheckbox(),!(0<this.$(".payment-error").length))return this.__dialogManager.showDialog(e.AddCreditCardDialog,{channel:this.__channel,cart:this.__cart,orderTotal:this.__orderTotal,itemCount:this.__itemCount}).finished.then(function(e){this.promiseResolver.accept(),this.__destroy()}.bind(this)).catch(function(e){}.bind(this));this.__scrollTop()}})}({UiCore:e["@UiCore"],PaymentBaseDialog:f,AddCreditCardDialog:g,Dropdown:p,OrderList:h,SavedCreditCardList:u,Tooltip:r,template:c}),c={getTimeFormat:function(e,t){var i=Math.floor(e/3600),a=Math.floor(e/60)-60*i,s=e%60;t&&(s=s.toFixed(t));var n=10>s?"0":"";return i?i+":"+(10>a?"0":"")+a+":"+n+s:a+":"+n+s},formatCredits:function(e){return e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")},zeroPad:function(e,t){return(Array(t).join("0")+e).substr(-t,t)},formatMini:function(e){for(var t=[{base:1e3,letter:"K"},{base:1e6,letter:"M"},{base:1e9,letter:"B"}],i=t.length-1;0<=i;i--){var a=t[i],s=a.base;if(e>=s)return(t=Math.floor(e/s))+((e=Math.floor((e-s*t)/(s/10)))?"."+e:"")+a.letter}return""+e}},l=function(e){var t=e.UiCore.UiContext;return t.extend("CheckoutButton",{uiContextName:"checkout_button",className:"inline-purchase-checkout-button",dependencies:["globalStringManager","dialogManager","loginManager"],trackedEvents:function(){return[{type:"click",selector:".buy-now",name:"store_checkout",handler:this.__storeCheckout}]},initialize:function(i){t.prototype.initialize.call(this,i),this.__stringManager=i.globalStringManager,this.__formatNumber=e.FormatNumber,this.dialogManager=i.dialogManager,this.__selectedCredit=IMVU.optionalProperty(i,"selectedCredit",new IMVU.NamedModel({price:0})),this.__selectedVip=IMVU.optionalProperty(i,"selectedVip",new IMVU.NamedModel({price:0})),this.__context=IMVU.optionalProperty(i,"context",null),this.listenTo(this.__selectedCredit,"change",this.__updateCheckoutButton),this.listenTo(this.__selectedVip,"change",this.__updateCheckoutButton),this.addToDOM(),this.__myself=this.track(i.loginManager.getCurrentUser()),this.__updateCheckoutButton()},render:function(){this.$el.html(e.template())},__updateCheckoutButton:function(){var e;this.__getNumber()?(this.$("button.buy-now").prop("disabled",!1),e=1===this.__getNumber()?this.__stringManager.get("checkout_dialog_buy_now_message_singular",{totalCredits:"$"+this.__formatNumber.formatCredits(this.__getTotalPrice())}):this.__stringManager.get("checkout_dialog_buy_now_message_plural",{howMany:this.__getNumber(),totalCredits:"$"+this.__formatNumber.formatCredits(this.__getTotalPrice())}),this.$("button.buy-now").text(e)):(this.$("button.buy-now").prop("disabled",!0),this.$("button.buy-now").text(this.__stringManager.get("CHECKOUT")))},__getNumber:function(){var e=0;return 0<this.__selectedCredit.get("price")&&e++,0<this.__selectedVip.get("price")&&e++,e},__getTotalPrice:function(){return(this.__selectedCredit.get("price")+this.__selectedVip.get("price")).toFixed(2)},__storeCheckout:function(){this.$("button.buy-now").prop("disabled",!0),this.__myself.populated().then(function(t){if(t.get("is_on_hold"))return this.dialogManager.showDialog(e.Dialogs.AlloyAlertDialog,{title:this.__stringManager.get("payment_failed_account_holdon_title"),text:this.__stringManager.get("payment_failed_account_holdon_text"),ok:this.__stringManager.get("payment_failed_account_holdon_button")}).finished.then(function(){this.__context&&this.__context.destroy()}.bind(this));0<this.__selectedVip.get("price")&&this.__myself.get("is_vip")?this.__myself.getEdgeCollection("vip_subscriptions").populated().then(function(t){for(var i=!1,a=0;a<t.models.length;a++){var s=t.models[a].node;s.get("date_stopped")||s.relations.buyer!==this.__myself.id||s.relations.recipient!==this.__myself.id||(i=!0)}if(i)return this.dialogManager.showDialog(e.Dialogs.AlloyAlertDialog,{title:this.__stringManager.get("already_have_vip_subscription_title"),html:e.AlreadyHaveVipDialog({}),ok:this.__stringManager.get("already_have_vip_subscription_button")}).finished.then(function(){this.__context&&this.__context.destroy()}.bind(this));this.__checkout()}.bind(this)):this.__checkout()}.bind(this))},__checkout:function(){var t=[];return _.each([this.__selectedCredit,this.__selectedVip],function(e){e.get("price")&&t.push({pid:e.get("pid"),sku:e.get("sku"),name:e.get("name"),original_price:e.get("original_price"),price:e.get("price"),type:e.get("type"),frequency_code:e.get("frequency_code"),image:e.get("image")})}),this.dialogManager.showDialog(e.PaymentDialog,{cart:t,channel:"next-inline",context:this.__context}).finished.then(function(){this.__context&&(this.__context.purchaseComplete=!0,this.__context.destroy())}.bind(this)).catch(function(){this.__context&&this.__context.includeBuyCredits&&this.__context.trigger("refresh_items",!0),this.$("button.buy-now").prop("disabled",!1)}.bind(this))}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],template:l,AlreadyHaveVipDialog:d,FormatNumber:c,PaymentDialog:h}),d=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<a class="back-button">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Back",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</a>"},useData:!0})}(),h=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s;return'\n    <legend class="system-info-header">'+(0,this.escapeExpression)("function"==typeof(s=t.titleText||e&&e.titleText)?s.call(e,{name:"titleText",hash:{},data:a}):s)+"</legend>\n"},3:function(e,t,i,a){var s;i=t.helperMissing;var n='\n    <div class="vip-description">\n        <div class="crown-icon">\n            <svg class="image" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 80 80" class="color-gold" fill-rule="evenodd"><path d="M58 17.272a2.218 2.218 0 0 0-4.434 0c0 .594.234 1.128.612 1.524l-6.216 6.108a.422.422 0 0 1-.681-.129l-6.033-13.698a2.212 2.212 0 0 0 1.017-1.86 2.218 2.218 0 0 0-4.437 0c0 .78.405 1.464 1.017 1.86l-6.033 13.698a.422.422 0 0 1-.681.129l-6.267-6.156c.351-.393.57-.906.57-1.476a2.218 2.218 0 0 0-4.434 0 2.21 2.21 0 0 0 1.992 2.196c.351 2.916 1.941 16.161 1.98 16.212.549 1.272 6.633 2.274 14.076 2.274 7.44 0 13.524-1.002 14.073-2.274.039-.051 1.632-13.326 1.98-16.224A2.208 2.208 0 0 0 58 17.272M24.71 70.81h-3.836L10.633 46h4.786l7.426 18.933L30.235 46h4.68L24.71 70.81zm14.674-.177V46h4.329v24.633h-4.329zm20.13-7.917h-4.892v7.918h-4.328V46h9.712c5.772 0 9.36 3.272 9.36 8.305 0 5.525-4.433 8.41-9.852 8.41zm.14-12.774h-5.032v8.868h5.033c3.272 0 5.313-1.83 5.313-4.4v-.07c0-2.885-2.076-4.398-5.313-4.398z"/></svg>\n        </div>\n        <div class="title">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_description_title",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</div>\n        <div class="sentence">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_description_sentence",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</div>\n        ",((s=t.if.call(e,e&&e.showLearnLink,{name:"if",hash:{},fn:this.program(4,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+"\n    </div>\n"},4:function(e,t,i,a){var s;i=t.helperMissing;var n='\n            <div class="learn-link-outer">\n                <div class="learn-link-inner">\n                    ';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_description_learn_link",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"\n                </div>\n            </div>\n        "},6:function(e,t,i,a){var s;i=t.helperMissing;var n='\n    <legend class="system-info-header">\n        ';return((s=t.if.call(e,e&&e.isInCreditDialog,{name:"if",hash:{},fn:this.program(7,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+="\n        ",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"UPGRADES",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"\n    </legend>\n"},7:function(e,t,i,a){var s;i=t.helperMissing;var n="\n            ";return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"RECOMMENDED",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"\n        "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;return i="",((s=t.if.call(e,e&&e.titleShow,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n",((s=t.if.call(e,e&&e.clubSubscriptionShow,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n",((s=t.unless.call(e,e&&e.titleShow,{name:"unless",hash:{},fn:this.program(6,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+"\n"},useData:!0})}(),p=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s;i=t.helperMissing;var n='\n    <div class="promo-banner sale">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"SALE",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+'<div class="triangle"></div></div>\n'},3:function(e,t,i,a){var s;i=t.helperMissing;var n='\n    <div class="promo-banner most-popular">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"MOST POPULAR",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+'<div class="triangle"></div></div>\n'},5:function(e,t,i,a){var s;i=t.helperMissing;var n='\n    <div class="promo-banner best-value">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"BEST VALUE",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+'<div class="triangle"></div></div>\n'},7:function(e,t,i,a){var s,n;i=this.escapeExpression;var r=t.helperMissing,o='\n    <div class="item-info">\n        <div class="image-container"><span class="helper"></span><img></div>\n    </div>\n    <div class="item-price">\n        <div class="subscription-title">'+i("function"==typeof(n=t.description||e&&e.description)?n.call(e,{name:"description",hash:{},data:a}):n)+'</div>\n        <div class="prices">\n            <div class="show-price">\n            ';return((s=t.if.call(e,e&&e.has_discount,{name:"if",hash:{},fn:this.program(8,a),inverse:this.noop,data:a}))||0===s)&&(o+=s),o+="\n            $"+i("function"==typeof(n=t.price||e&&e.price)?n.call(e,{name:"price",hash:{},data:a}):n)+'\n            </div>\n            <div class="show-active">\n                ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||r).call(e,"ACTIVE",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+"\n            </div>\n        </div>\n    </div>\n"},8:function(e,t,i,a){var s;return'\n                <span class="original-price">$'+(0,this.escapeExpression)("function"==typeof(s=t.original_price||e&&e.original_price)?s.call(e,{name:"original_price",hash:{},data:a}):s)+"</span>\n            "},10:function(e,t,i,a){var s,n;i=this.escapeExpression;var r=t.helperMissing,o='\n    <div class="item-info">\n        <div class="image-container"><img></div>\n        '+i("function"==typeof(n=t.itemLabels||e&&e.itemLabels)?n.call(e,{name:"itemLabels",hash:{},data:a}):n)+'\n        <div class="check-mark check-mark-hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 25 25">\n                <path fill="#404040" fill-rule="evenodd" d="M11.082 15.579l-3.536-3.536-1.414 1.414 4.243 4.243.707.707 8.485-8.485-1.414-1.415-7.071 7.072zM12.5 22.5c-5.523 0-10-4.477-10-10s4.477-10 10-10 10 4.477 10 10-4.477 10-10 10z"/>\n            </svg>\n        </div>\n    </div>\n    <div class="item-price">\n        <div class="show-price">\n        ';return((s=t.if.call(e,e&&e.has_discount,{name:"if",hash:{},fn:this.program(11,a),inverse:this.noop,data:a}))||0===s)&&(o+=s),o+="\n        $"+i("function"==typeof(n=t.price||e&&e.price)?n.call(e,{name:"price",hash:{},data:a}):n)+'\n        </div>\n        <div class="show-active">\n            ',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||r).call(e,"ACTIVE",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+"\n        </div>\n    </div>\n"},11:function(e,t,i,a){var s;return'\n            <span class="original-price">$'+(0,this.escapeExpression)("function"==typeof(s=t.original_price||e&&e.original_price)?s.call(e,{name:"original_price",hash:{},data:a}):s)+"</span>\n        "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;return i='<div class="wrapper">  \n\n',((s=t.if.call(e,e&&e.is_sale,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n\n",((s=t.if.call(e,e&&e.is_popular,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n\n",((s=t.if.call(e,e&&e.is_best,{name:"if",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n\n",((s=t.if.call(e,e&&e.showRows,{name:"if",hash:{},fn:this.program(7,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n\n",((s=t.unless.call(e,e&&e.showRows,{name:"unless",hash:{},fn:this.program(10,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+"\n</div>\n"},useData:!0})}(),p=function(e){var t=e.UiCore.UiContext;return t.extend("BuyUpgradeListItem",{uiContextName:"buy_upgrade_list_item",tagName:"article",className:"buy-upgrade-list-item",dependencies:"globalStringManager imageManager loginManager model googleAnalytics window".split(" "),trackedEvents:function(){return[{type:"click",name:"choose_upgrade_item",handler:"__onClickItem"}]},initialize:function(e){this.__width=void 0===e.width?"":e.width,""!==this.__width&&(this.__width="width-"+this.__width),this.__selectedVip=IMVU.requireProperty(e,"selectedVip"),this.__style=IMVU.optionalProperty(e,"style",""),this.__model=e.model,this.__globalStringManager=e.globalStringManager,this.__imageManager=e.imageManager,this.__isInStore=IMVU.optionalProperty(e,"isInStore",!1),this.__context=IMVU.optionalProperty(e,"context",null),this.__isResponsive=IMVU.optionalProperty(e,"isResponsive",!1),t.prototype.initialize.call(this,e),this.__itemLabels=void 0===e.itemLabels?"SUBSCRIPTION":e.itemLabels,this.__itemLabels=this.__globalStringManager.get(this.__itemLabels),this.__scheme=void 0===e.scheme?"":e.scheme,this.__width=void 0===e.width?"":e.width,this.__platform=this.__serviceProvider.get("platform"),this.__myself=this.__loginManager.getCurrentUser(),this.__isActive=!1,this.$el.toggleClass("is-responsive-tile-list-item",this.__isResponsive),this.addToDOM()},render:function(){t.prototype.render.call(this),this.__myself.populated().then(function(){return this.__model.populated()}.bind(this)).then(function(){this.__hasDiscount=this.__model.get("original_price")>this.__model.get("independent_purchase_price");var t=!1;switch("in-dialog"!==this.__style||"mobile"!==this.__platform||this.__isResponsive||(t=!0,this.__scheme="rows"),this.$el.html(e.template({has_discount:this.__hasDiscount,original_price:this.__model.get("original_price").toFixed(2),price:this.__model.get("independent_purchase_price").toFixed(2),is_sale:this.__hasDiscount,is_best:!this.__hasDiscount&&this.__model.get("best"),is_popular:!this.__hasDiscount&&!this.__model.get("best")&&this.__model.get("popular"),showRows:t,description:this.__globalStringManager.get("vip_sbuscription_freq_"+this.__model.get("frequency_code")),itemLabels:this.__itemLabels})),this.__imageManager.load(this.$(".image-container > img"),this.__getImageSrc(this.__model.get("image"))),(this.__hasDiscount||this.__model.get("best")||this.__model.get("popular"))&&this.$el.addClass("has-promo"),this.__myself.get("is_vip")&&this.$el.addClass("clickblocked"),this.__setChecked(!1),"width140"!==this.__width||this.__isResponsive||(this.$el.addClass("width140"),this.$el.addClass("height180"),this.$(".item-info").addClass("width140"),this.$(".item-info").addClass("height140")),this.__modelFrequency="",this.__model.get("frequency_code")){case this.constructor.VIP_MONTHLY:this.__modelFrequency="monthly";break;case this.constructor.VIP_QUARTERLY:this.__modelFrequency="quarterly";break;case this.constructor.VIP_YEARLY:this.__modelFrequency="yearly"}this.__checkForActiveSubscription(),this.listenTo(this.__myself,"change:vip_expires",this.__checkForActiveSubscription)}.bind(this))},__checkForActiveSubscription:function(){this.__myself.get("is_vip")?(this.__vipSubscriptions||(this.__vipSubscriptions=this.__myself.getEdgeCollection("vip_subscriptions")),this.__vipSubscriptions.populated().then(function(e){this.__vipNode=null,this.__isActive=!1,this.__subscriptionFrequency="";for(var t=0;t<e.models.length;t++){var i=e.models[t].node;i.get("date_stopped")||i.relations.buyer!==this.__myself.id||i.relations.recipient!==this.__myself.id||i.get("frequency")!==this.__modelFrequency||(this.__vipNode=i,this.__isActive=!0)}this.$el.toggleClass("active",this.__isActive),this.$el.removeClass("clickblocked"),this.__vipNode&&this.listenTo(this.__vipNode,"change:date_stopped",this.__subscriptionCancelled)}.bind(this))):(this.$el.removeClass("active"),this.$el.removeClass("clickblocked"))},__subscriptionCancelled:function(){this.stopListening(this.__vipNode),this.__vipNode=null,this.__isActive=!1,this.$el.removeClass("active"),this.$el.removeClass("clickblocked")},__getImageSrc:function(e){return"/common/withme/img/store/"+e},__setChecked:function(e){if(this.$el.toggleClass("selected-item",e),"white_charcoal"===this.__scheme){this.$el.siblings().find(".check-mark").addClass("check-mark-hidden"),this.$el.siblings().removeClass("selected-item"),this.$el.siblings().find(".item-price").removeClass("item-price-charcoal"),this.$el.siblings().find(".item-price").addClass("item-price-white");var t=this.$(".item-price");!0===e?(this.$(".check-mark").removeClass("check-mark-hidden"),t.hasClass("item-price-white")&&t.removeClass("item-price-white"),t.addClass("item-price-charcoal")):(this.$(".check-mark").addClass("check-mark-hidden"),t.hasClass("item-price-charcoal")&&t.removeClass("item-price-charcoal"),t.addClass("item-price-white"))}},__onClickItem:function(){this.__isActive||this.$el.hasClass("clickblocked")||"vip"!==this.__model.get("type")||(this.__isInStore?(this.__selectedVip.set({name:this.__model.get("title"),price:this.__model.get("independent_purchase_price"),original_price:this.__model.get("original_price"),sku:this.__model.get("sku"),pid:this.__model.get("pid"),frequency_code:this.__model.get("frequency_code"),type:this.__model.get("type"),image:this.__model.get("image")}),this.__googleAnalytics.recordDollarStore("view",this.__model.get("sku")),this.__selectedVip.trigger("click")):(this.$el.toggleClass("selected-item"),this.$el.hasClass("selected-item")?(this.__setChecked(!0),e.NextUtil.DomHelper.radioClass(this.$el,"selected-item"),this.__selectedVip.set({name:this.__model.get("title"),price:this.__model.get("independent_purchase_price"),original_price:this.__model.get("original_price"),sku:this.__model.get("sku"),pid:this.__model.get("pid"),frequency_code:this.__model.get("frequency_code"),type:this.__model.get("type"),image:this.__model.get("image")}),this.__context&&this.__context.trigger("add_vip_item",!0)):(this.__setChecked(!1),this.__selectedVip.set({price:0}),this.__context&&this.__context.trigger("add_vip_item",!1))))}},{VIP_MONTHLY:2,VIP_QUARTERLY:4,VIP_YEARLY:5})}({UiCore:e["@UiCore"],NextUtil:e["@NextUtil"],template:p}),p=function(e){var t=e.UiCore.ListPresenter;return t.extend("BuyUpgradeList",{uiContextName:"buy_upgrade_list",className:"buy-upgrade-list",tagName:"section",dependencies:["featureAccessManager","globalStringManager","modeManager"],trackedEvents:function(){return[{type:"click",selector:".learn-link-inner",name:"vip_description_learn_link",handler:"__onClickLearnLink"}]},itemFactory:e.BuyUpgradeListItem,initialize:function(i){t.prototype.initialize.call(this,i),this.__width=void 0===i.width?"":i.width,this.__style=IMVU.optionalProperty(i,"style",""),this.__isResponsive=IMVU.optionalProperty(i,"isResponsive",!1),this.__titleShow=-1===["in-dialog","in-credit-dialog"].indexOf(this.__style)||void 0!==i.titleText,this.__titleText=void 0===i.titleText?"UPGRADE TO VIP":i.titleText,this.__titleText=this.__globalStringManager.get(this.__titleText),this.__clubSubscriptionShow=(-1===["in-dialog","in-credit-dialog"].indexOf(this.__style)||!0===i.clubSubscriptionShow)&&!1!==i.clubSubscriptionShow,this.__showLearnLink=this.__featureAccessManager.canSeeVipUpsell(),this.__scheme=void 0===i.scheme?"":i.scheme,this.__bottomPadding=!0===i.bottomPadding,this.$el.toggleClass("is-responsive-tile-list",this.__isResponsive),this.$el.toggleClass("two-columns",400>this.$el.width()),this.$el.prepend(e.template({width:this.__width,titleShow:this.__titleShow,titleText:this.__titleText,clubSubscriptionShow:this.__clubSubscriptionShow,showLearnLink:this.__showLearnLink,itemLabels:i.itemLabels,isInCreditDialog:"in-credit-dialog"===this.__style,scheme:this.__scheme})),this.__bottomPadding&&this.$el.addClass("bottom-padding")},__onClickLearnLink:function(e){this.__modeManager.openMode({mode:{id:"store"},submode:{id:"vip"}})}})}({UiCore:e["@UiCore"],BuyUpgradeListItem:p,template:h}),o=function(e){var t=e.Dialogs.AlloyModalDialog;return t.extend("BuyUpgradeDialog",{uiContextName:"buyupgrade_dialog",className:"buyupgrade-dialog dialog-type-B",dependencies:"dialogManager featureAccessManager globalStartupModel globalStringManager Promise restModelFactory".split(" "),trackedEvents:function(){return[{type:"click",selector:".buy-upgrade-now",name:"buy_upgrade",handler:this.__buyUpgradeNow},{type:"click",selector:".back-button",name:"go_back",handler:this.__goBack}]},initialize:function(i){t.prototype.initialize.call(this,i),this.purchaseComplete=!1,this.Promise=i.Promise,this.serviceProvider=i.serviceProvider,this.dialogManager=i.dialogManager,this.__stringManager=i.globalStringManager,this.restModelFactory=i.restModelFactory,this.__platform=this.__serviceProvider.get("platform"),this.__formatNumber=e.FormatNumber,this.__storeCatalogUrl=i.globalStartupModel.get("storeCatalogUrl"),this.__storeCatalog=this.restModelFactory.readModel(this.__storeCatalogUrl,e.UiCore.NodeModel),this.title=this.__stringManager.get("buyupgrade_title"),this.__selectedProduct=new IMVU.NamedModel,this.addToDOM()},destroy:function(){this.promiseResolver&&this.promiseResolver.resolve(this.purchaseComplete),this.hide(),this.delete()},postRender:function(){this.setContent("body",e.template),this.createChildContext(e.CheckoutButton,{$parentElement:this.$(".dialog-footer"),selectedVip:this.__selectedProduct,globalStringManager:this.__stringManager,context:this}),this.__storeCatalog.populated().then(function(e){return e.getEdgeCollection("items").populated()}.bind(this)).then(function(t){var i=new IMVU.NamedCollection;_.each(t.models,function(e){"vip"===(e=e.edge).get("type")&&i.add(e)}.bind(this)),("mobile"!==this.__platform||this.__featureAccessManager.canSeeResponsiveList())&&this.$(".dialog-body").addClass("list-like-submode"),this.createChildContext(e.BuyUpgradeList,{$parentElement:this.$(".products"),collection:i,selectedVip:this.__selectedProduct,clubSubscriptionShow:!0,itemLabels:"MEMBERSHIP",scheme:"white_charcoal",width:"width140",style:"in-dialog",isResponsive:!!this.__featureAccessManager.canSeeResponsiveList()}),this.$(".upgrade-products").scrollbar()}.bind(this))},__goBack:function(){this.destroy()}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],Model:e["@Model"],template:o,backButtonTemplate:d,FormatNumber:c,BuyUpgradeList:p,CheckoutButton:l}),d=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<div class="available-credits credits-value"></div>\n'},useData:!0})}(),h=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;return'<span class="credits-value">'+(0,this.escapeExpression)("function"==typeof(s=t.totalCredits||e&&e.totalCredits)?s.call(e,{name:"totalCredits",hash:{},data:a}):s)+"</span>"},useData:!0})}(),g=function(e){return{render:function(t,i){if(t.html(e.template(i)),t.find(".product-select").prop("checked",i.checked),i.preview_image){var a=i.preview_image;i.imageHeight&&i.imageWidth&&(a=IMVU.URI.build(a,{width:i.imageWidth,height:i.imageHeight})),t.find("img").attr({src:a})}i.creator&&(t.addClass("has-creator"),t.find(".creator-name").text(i.creator.display_name))}}}({template:function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(){return"\n    <div class='also-tried-on'>YOU ALSO TRIED ON</div>\n"},3:function(){return'<button class="btn ap ap-badge"></button>'},5:function(e,t,i,a){var s;return"\n        <div class='name'>"+(0,this.escapeExpression)("function"==typeof(s=t.name||e&&e.name)?s.call(e,{name:"name",hash:{},data:a}):s)+"</div>\n    "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s,n;i=this.escapeExpression;var r="";return((s=t.if.call(e,e&&e.also_tried_on,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+="\n<input id='cart-item-"+i("function"==typeof(n=t.product_id||e&&e.product_id)?n.call(e,{name:"product_id",hash:{},data:a}):n)+"' class='checkbox product-select' "+i("function"==typeof(n=t.checked||e&&e.checked)?n.call(e,{name:"checked",hash:{},data:a}):n)+" type='checkbox'>\n<label class='product-info' for='cart-item-"+i("function"==typeof(n=t.product_id||e&&e.product_id)?n.call(e,{name:"product_id",hash:{},data:a}):n)+"'>\n    <div class='cart-image'>\n        <img>\n        ",((s=t.if.call(e,e&&e.isAp,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+="\n    </div>\n    ",((s=t.if.call(e,e&&e.name,{name:"if",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+"\n    <div class='creator'></div>\n    <div class='price-credits'>"+i("function"==typeof(n=t.price||e&&e.price)?n.call(e,{name:"price",hash:{},data:a}):n)+"</div>\n</label>\n"},useData:!0})}()}),g=function(e){var t=e.UiCore.UiContext;return t.extend("CartListItem",{tagName:"li",className:"cart-list-item",uiContextName:"item",dependencies:["globalStringManager","loginManager","Promise"],trackedEvents:function(){return[{type:"click",selector:".product-select",name:"change_product_select",handler:this.__changeProductSelect.bind(this)}]},initialize:function(i){t.prototype.initialize.call(this,i),this.loginManager=i.loginManager,this.__myself=i.loginManager.getCurrentUser(),this.imageHeight=i.imageHeight?i.imageHeight:null,this.imageWidth=i.imageWidth?i.imageWidth:null,this.__formatNumber=e.FormatNumber,this.__priceResolver=null,this.__pricePromise=new this.__Promise(function(e){this.__priceResolver=e}.bind(this)),this.addToDOM()},render:function(){this.model.populated().then(function(){var t=this.__getDetails();e.CartListItemUi.render(this.$el,t),this.model.getSingleEdge("creator").populated().then(function(t){this.__displayName=this.createChildContext(e.Widgets.DisplayName,{$parentElement:this.$(".creator"),user:t,size:"tiny",color:"dark",showVipBadge:!1,ignoreClicks:!0,prefix:this.__globalStringManager.get("By")})}.bind(this))}.bind(this))},__getDetails:function(){return this.__getPrice(),this.__pricePromise.then(function(e){return{name:this.model.get("product_name"),price:this.__formatNumber.formatCredits(Number(e)),checked:this.model.get("is_selected"),product_id:this.model.get("product_id"),also_tried_on:this.model.get("also_tried_on"),isAp:"AP"===this.model.get("rating"),preview_image:this.model.get("preview_image"),imageWidth:this.imageWidth,imageHeight:this.imageHeight}}.bind(this)).result},__getPrice:function(){var t=this.model.get("product_price");if(this.model.get("is_bundle")){var i=this.model.getEdgeCollection("subproducts",e.Model.ProductEdgeCollection);i.populated().then(function(){i.map(function(e){e.node.get("is_owned")&&80!=e.node.get("product_id")&&191!=e.node.get("product_id")&&(t-=e.node.get("product_price"))}.bind(this)),this.__priceResolver.accept(t)}.bind(this))}else this.__priceResolver.accept(t)},__changeProductSelect:function(e){this.model.set("is_selected",!!$(e.target).prop("checked"))}})}({UiCore:e["@UiCore"],Widgets:e["@Widgets"],Model:e["@Model"],CartListItemUi:g,FormatNumber:c}),g=function(e){var t=e.UiCore.ListPresenter;return t.extend("CartList",{uiContextName:"cart_list",className:"cart-list",initialize:function(i){i.imageWidth=80,i.imageHeight=80,this.itemFactory=i.itemFactory||e.CartListItem,t.prototype.initialize.call(this,i)}})}({UiCore:e["@UiCore"],CartListItem:g}),u=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s,n;i=t.helperMissing;var r=this.escapeExpression,o='\n            <div class="needs-credit ';return((s=t.if.call(e,e&&e.largeAmount,{name:"if",hash:{},fn:this.program(2,a),inverse:this.noop,data:a}))||0===s)&&(o+=s),o+='">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"You need",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+="<span>"+r("function"==typeof(n=t.amount||e&&e.amount)?n.call(e,{name:"amount",hash:{},data:a}):n)+" ",((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Credits",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+="</span>",((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"complete_purchase",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+"</div>\n        "},2:function(){return" large-amount "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;return i='<div class="products-container">\n    <div class="products">\n        ',((s=t.if.call(e,e&&e.showAmount,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+'\n    </div>\n    <div class="ppc-redeem-placeholder"></div>\n</div>\n<footer class="dialog-footer">\n</footer>\n'},useData:!0})}(),m=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<a class="back-button">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Back to Cart",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</a>"},useData:!0})}(),f=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<legend class="redeem-title system-info-header">\n    ';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_redeem_title",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='\n    <span class="ppc-redeem-tooltip-target icon icon-tooltip-icon"></span>\n</legend>\n<div class="redeem-wrapper">\n    <div class="redeem-field">\n        <input type="text" class="ppc-code full-width" maxlength="16" placeholder="',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_redeem_input_placeholder",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='">\n        <div class="input-error"></div>\n    </div>\n    <div class="redeem-button">\n        <button class="ppc-redeem-btn btn disabled full-width">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_redeem_button",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</button>\n    </div>\n</div>\n<div class="ppc-redeem-tooltip">\n    <div class="tooltip-header">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_tooltip_header",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</div>\n    <div class="tooltip-body">\n        <div class="icon icon-ppc-tooltip"></div>\n        <div>',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_tooltip_body_line_1",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</div>\n        <div>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_tooltip_body_line_2",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='</div>\n    </div>\n</div>\n\n<div class="vip-tooltip-body hidden">\n    ',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_description_title",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="\n    <ul>\n        <li>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_description_item_1",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</li>\n        <li>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_description_item_2",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</li>\n        <li>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_description_item_3",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+="</li>\n        <li>",((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"vip_description_item_4",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</li>\n    </ul>\n</div>"},useData:!0})}(),v=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s;i=t.helperMissing;var n='\n<div class="redemption-gifts">\n    <legend class="system-info-header">\n        ';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_redemption_choice_dialog_bonus",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='\n    </legend>\n    <div class="bonus-items-list">\n    ',((s=t.each.call(e,e&&e.bonusItems,{name:"each",hash:{},fn:this.program(2,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+"\n    </div>\n</div>\n"},2:function(e,t,i,a){var s,n,r=this.escapeExpression;return i=t.helperMissing,r='\n        <article class="bonus-item-tile product-tile tile">\n            <div class="tile-body">\n                <img src="'+r("function"==typeof(n=t.thumbnail||e&&e.thumbnail)?n.call(e,{name:"thumbnail",hash:{},data:a}):n)+'" class="is-square">\n            </div>\n            <div class="product-info">\n                <div class="product-name">'+r("function"==typeof(s=e&&e.name)?s.apply(e):s)+'</div>\n                <div class="free">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"FREE",{name:"i18n-g",hash:{},data:a}))||0===s)&&(r+=s),r+"</div>\n            </div>\n        </article>\n    "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<div class="redemption-choices">\n    <legend class="system-info-header">\n        ';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_redemption_choice_dialog_package",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+='\n    </legend>\n    <div class="redemption-choices-container">\n    </div>\n</div>\n',((s=t.if.call(e,e&&e.hasBonusItems,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(n+=s),n+='\n<script type="text/template" class="dialog-footer-template">\n    <button class="btn btn-primary redeem-ppc full-width disabled">',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"ppc_redeem_button",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</button>\n<\/script>\n"},useData:!0})}(),b=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<div class="celled-list-placeholder"></div>'},useData:!0})}(),y=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(){return" disabled "},3:function(){return" ignore-click "},5:function(){return'\n        <div class="tooltip-target icon icon-tooltip-icon"></div>\n        <div class="tooltip-content">\n            <div class="tooltip-header"></div>\n            <div class="tooltip-body"></div>\n        </div>\n    '},7:function(){return'\n        <span class="icon icon-action-more"></span>\n    '},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s,n;i=this.escapeExpression;var r='<div class="wrapper ';return((s=t.if.call(e,e&&e.isDisabled,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+=" ",((s=t.if.call(e,e&&e.ignoreClick,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+='">\n    <div class="thumbnail">\n        <img src="'+i("function"==typeof(n=t.thumbnail||e&&e.thumbnail)?n.call(e,{name:"thumbnail",hash:{},data:a}):n)+'">\n    </div>\n    <div class="description">\n        <div class="celled-item-title">'+i("function"==typeof(n=t.title||e&&e.title)?n.call(e,{name:"title",hash:{},data:a}):n)+'</div>\n        <div class="celled-item-description">'+i("function"==typeof(n=t.description||e&&e.description)?n.call(e,{name:"description",hash:{},data:a}):n)+'</div>\n        <div class="celled-item-info">'+i("function"==typeof(n=t.info||e&&e.info)?n.call(e,{name:"info",hash:{},data:a}):n)+'</div>\n    </div>\n    <div class="extra">\n    ',((s=t.if.call(e,e&&e.tooltip,{name:"if",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+="\n    ",((s=t.if.call(e,e&&e.actionMore,{name:"if",hash:{},fn:this.program(7,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+"\n    </div>\n</div>"},useData:!0})}(),y=function(e){var t=e.UiCore.UiContext;return t.extend("CelledListItem",{className:"celled-list-item",uiContextName:"celled_list_item",dependencies:["model"],trackedEvents:function(){return[{type:"click",selector:"",name:"celledlistitem_click",handler:this.__onClick.bind(this)},{type:"click",selector:"extra.action-more",name:"click_more_info",handler:this.__onClickMore.bind(this)}]},initialize:function(e){t.prototype.initialize.call(this,e),this.addToDOM()},render:function(){var t=!1,i="",a="",s=this.__model.get("extra"),n=s&&"action_more"===s.type;s&&"tooltip"===s.type&&(t=!0,i=s.tooltip_header,a=s.tooltip_body),this.__ignoreClick=this.__model.get("isDisabled")||this.__model.get("ignoreItemClick"),this.$el.html(e.template({thumbnail:this.__model.get("thumbnail"),title:this.__model.get("title"),description:this.__model.get("description"),info:this.__model.get("info"),tooltip:t,isDisabled:!!this.__model.get("isDisabled"),actionMore:n,ignoreClick:this.__ignoreClick})),t&&(this.$(".tooltip-header").html(i),this.$(".tooltip-body").html(a),this.createChildContext(e.Tooltip,{$replaceElement:this.$(".tooltip-content"),$tooltipTarget:this.$(".tooltip-target")}))},__onClick:function(t){this.__ignoreClick||(e.NextUtil.DomHelper.radioClass(this.$el,"is-selected"),this.trigger("select",this.__model))},__onClickMore:function(){this.trigger("action_more",this.__model)}})}({UiCore:e["@UiCore"],NextUtil:e["@NextUtil"],template:y,Tooltip:r}),y=function(e){return e.UiCore.ListPresenter.extend("CelledList",{className:"celled-list",uiContextName:"celled_list",itemFactory:e.CelledListItem})}({UiCore:e["@UiCore"],CelledListItem:y}),b=function(e){var t=e.UiCore.UiContext;return t.extend("CelledListPresenter",{className:"celled-list-presenter",uiContextName:"celled_list_presenter",dependencies:["collection"],initialize:function(e){t.prototype.initialize.call(this,e),this.addToDOM()},render:function(t){this.$el.html(e.template()),this.celledList=this.createChildContext(e.CelledList,{$replaceElement:this.$(".celled-list-placeholder"),collection:this.collection}),this.celledList.on("select",function(e){this.__selectedItem=e,this.trigger("select")}.bind(this))},getSelectedItem:function(){return this.__selectedItem}})}({UiCore:e["@UiCore"],template:b,CelledList:y}),v=function(e){var t=e.Dialogs.AlloyModalDialog;return t.extend("PPCRedemptionChoiceDialog",{uiContextName:"redemption_choice_dialog",className:"redemption-choice-dialog dialog-type-B",dependencies:"dialogManager globalStringManager globalStartupModel rest ppcPin redemptionChoices bonusItems".split(" "),trackedEvents:function(){return[{type:"click",selector:"button.redeem-ppc",name:"redeem_ppc",handler:"__redeem"}]},initialize:function(e){t.prototype.initialize.call(this,e),this.title=this.__globalStringManager.get("ppc_redemption_choice_dialog_title"),this.__redeemUrl=this.__globalStartupModel.get("ppcRedeemUrl"),this.addToDOM()},postRender:function(){this.setContent("body",e.template,{hasBonusItems:0<this.__bonusItems.length&&!1,bonusItems:this.__bonusItems}),this.setContent("footer",this.$(".dialog-footer-template").text()),this.__choiceList=this.createChildContext(e.CelledListPresenter,{$replaceElement:this.$(".redemption-choices-container"),collection:this.__redemptionChoices}),this.__choiceList.on("select",this.__enableRedeemButton.bind(this))},__enableRedeemButton:function(){this.$(".redeem-ppc").toggleClass("disabled",!1)},__redeem:function(){if(this.__selectedItem=this.__choiceList.getSelectedItem()){this.__setLoading(!0);var e=this.__selectedItem.get("type");this.__rest.post(this.__redeemUrl+"/prepaid_card-"+this.__ppcPin,{choice:e}).then(function(){var e={};_.each(this.__bonusItems,function(t,i){e["gift_"+i]=t.name});var t=this.__globalStringManager.get("ppc_redemption_success_message_gift_num_0",_.extend({base_item:this.__selectedItem.get("title")},e));this.__dialogManager.alert({title:this.__globalStringManager.get("ppc_redemption_success_title"),text:t,ok:this.__globalStringManager.get("ppc_redemption_success_button")}).finished.then(function(){return this.promiseResolver.accept()}.bind(this))}.bind(this)).catch(function(e){var t=this.__globalStringManager.get("ppc_redeem_error_invalid_code");switch(e.error.code){case"PPC-001":t=this.__globalStringManager.get("ppc_redeem_error_invalid_code");break;case"PPC-002":t=this.__globalStringManager.get("ppc_redeem_error_inactive_card");break;case"PPC-003":t=this.__globalStringManager.get("ppc_redeem_error_already_redeemed")}this.__dialogManager.alert({title:this.__globalStringManager.get("ppc_redemption_failed_title"),text:t,ok:this.__globalStringManager.get("ppc_redemption_failed_button")}).finished.then(function(){return this.promiseResolver.reject()}.bind(this))}.bind(this))}},__setLoading:function(e){this.$("button.redeem-ppc").prop("disabled",e)}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],template:v,CelledListPresenter:b}),b={VK_BACKSPACE:8,VK_TAB:9,VK_ENTER:13,VK_CONTROL:17,VK_ESC:27,VK_SPACE:32,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_COMMA:188,wasPressed:function(e,t){return _.contains(t,e.keyCode)},is:function(e,t){if(!(t in this))throw Error("invalid key code: "+t);return e.keyCode===this[t]},getAlphaNumericChar:function(e){return(47<(e=e.keyCode)&&58>e||64<e||91>e)&&!(95<e&&106>e)&&(47<e&&58>e?e-48+"":64<e||91>e?String.fromCharCode(e).toLowerCase():95<e&&106>e?e-96+"":void 0)}},f=function(e){var t=e.UiCore.UiContext;return t.extend("PPCRedeem",{className:"ppc-redeem",uiContextName:"ppc_redeem",dependencies:"dialogManager globalStartupModel globalStringManager googleAnalytics leanplum loginManager modelCache platform Promise restModelFactory".split(" "),trackedEvents:function(){return[{type:"keyup",selector:"input.ppc-code",name:"ppcredeem_keyup",handler:this.__onKeyup.bind(this)},{type:"click",selector:"button.ppc-redeem-btn",name:"ppcredeem_click",handler:this.__inquiryPin.bind(this)}]},initialize:function(i){t.prototype.initialize.call(this,i),this.__redeemUrl=this.__globalStartupModel.get("ppcRedeemUrl"),this.__formatNumber=e.FormatNumber,this.__myself=this.track(this.__loginManager.getCurrentUser()),this.__isMobile="mobile"===this.__platform,this.addToDOM(),this.listenTo(this,"clear_input",this.__clearInput),this.listenTo(this,"successfully_redeemed",this.__clearInput)},delete:function(){t.prototype.delete.call(this),this.__tooltip.delete()},render:function(){this.$el.html(e.template()),this.__tooltip=this.__serviceProvider.create(e.Tooltip,{$replaceElement:this.$(".ppc-redeem-tooltip"),$tooltipTarget:this.$(".ppc-redeem-tooltip-target")}),this.__$code=this.$(".ppc-code"),this.__$error=this.$(".input-error"),parseInt(this.__globalStartupModel.get("ppcDisabled"),10)&&(this.$(".ppc-code").prop("disabled",!0),this.$(".ppc-code").attr("placeholder","Temporarily Disabled"))},__validatePin:function(e){return!!this.__$code.val()||(this.__updateError(this.__globalStringManager.get("ppc_redeem_error_empty_code")),!1)},__inquiryPin:function(t){this.__validatePin()?(this.__leanplum.recordEvent("next_ppc_redeem_click_success"),this.__googleAnalytics.recordDollarStore("redeem","ppc"),this.__clearErrors(),t=this.__redeemUrl+"/prepaid_card-"+this.__$code.val(),this.ppc&&this.__modelCache.invalidate(t),this.ppc=this.__restModelFactory.readModel(t,e.UiCore.NodeModel),this.ppc.populated().then(function(e){if(e.get("redeemed")||!e.get("valid"))return new this.__Promise(function(e){e.reject({redeemed:!0})});var t=e.get("base_credits"),i=e.get("vip_months");if(this.__choices=new IMVU.NamedCollection,i){switch(i){case 12:i="1 "+this.__globalStringManager.get("Year")+" "+this.__globalStringManager.get("VIP Subscription");break;case 1:i="1 "+this.__globalStringManager.get("Month")+" "+this.__globalStringManager.get("VIP Subscription");break;default:i=i+" "+this.__globalStringManager.get("Months")+" "+this.__globalStringManager.get("VIP Subscription")}i=new IMVU.NamedModel({type:"vip",thumbnail:this.__getImageUrl("vip.png"),title:i,description:"",info:"",extra:{type:"tooltip",tooltip_header:this.__globalStringManager.get("VIP Club Subscription"),tooltip_body:this.$(".vip-tooltip-body").html()},isDisabled:!!this.__myself.get("is_vip")}),this.__choices.add(i)}if(t){switch(t){case 1e3>=t:i="credits-level-one.png";break;case 1e4>=t:i="credits-level-two.png";break;default:i="credits-level-three.png"}t=new IMVU.NamedModel({type:"credits",thumbnail:this.__getImageUrl(i),title:this.__formatNumber.formatCredits(t)+" "+this.__globalStringManager.get("Credits"),description:"",info:""}),this.__choices.add(t)}return e.getEdgeCollection("bonus_products").populated()}.bind(this)).then(function(t){var i=[];_.each(t.models,function(e){i.push({name:e.node.get("product_name"),thumbnail:e.node.get("preview_image")+"?width=150&height=150"})}.bind(this)),this.__dialogManager.showDialog(e.RedemptionChoiceDialog,{ppcPin:this.__$code.val(),bonusItems:i,redemptionChoices:this.__choices}).finished.then(function(){this.trigger("successfully_redeemed")}.bind(this))}.bind(this)).catch(function(e){e=e.redeemed?this.__globalStringManager.get("ppc_redeem_error_already_redeemed"):this.__globalStringManager.get("ppc_redeem_error_invalid_code"),this.__updateError(e),this.trigger("redeem_failed")}.bind(this))):this.__leanplum.recordEvent("next_ppc_redeem_click_error")},__updateError:function(e){this.__$code.toggleClass("has-error",!0),this.__$error.text(e).toggleClass("error-visible",!0)},__onKeyup:function(t){t.keyCode===e.Keys.VK_ENTER?this.__inquiryPin():(this.$("button.ppc-redeem-btn").toggleClass("disabled",!this.__validatePin()),this.__clearErrors())},__clearErrors:function(){this.__$code.toggleClass("has-error",!1),this.__$error.text("").toggleClass("error-visible",!1)},__getImageUrl:function(e){return"/common/withme/img/store/"+e},__clearInput:function(){this.__$code.val(""),this.__clearErrors()}})}({UiCore:e["@UiCore"],template:f,Keys:b,Tooltip:r,RedemptionChoiceDialog:v,FormatNumber:c}),v=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;i=t.helperMissing;var n='<legend class="system-info-header">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Credits",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+"</legend>\n"},useData:!0})}(),b=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s;return'\n        <div class="promo-banner sale">'+(0,this.escapeExpression)("function"==typeof(s=t.sale_copy||e&&e.sale_copy)?s.call(e,{name:"sale_copy",hash:{},data:a}):s)+'<div class="triangle"></div></div>\n    '},3:function(e,t,i,a){var s;i=t.helperMissing;var n='\n        <div class="promo-banner most-popular">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"MOST POPULAR",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+'<div class="triangle"></div></div>\n    '},5:function(e,t,i,a){var s;i=t.helperMissing;var n='\n        <div class="promo-banner best-value">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"BEST VALUE",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+'<div class="triangle"></div></div>\n    '},7:function(e,t,i,a){var s,n;return i='\n    <div class="item-info">\n        <div class="image-container"><span class="helper"></span><img></div>\n    </div>\n    <div class="item-price">\n        <div class="title">'+(i=this.escapeExpression)("function"==typeof(n=t.title||e&&e.title)?n.call(e,{name:"title",hash:{},data:a}):n)+"</div>\n        ",((s=t.if.call(e,e&&e.has_discount,{name:"if",hash:{},fn:this.program(8,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n\n        ",((s=t.unless.call(e,e&&e.has_discount,{name:"unless",hash:{},fn:this.program(10,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+"\n    </div>\n    "},8:function(e,t,i,a){var s;return'\n        <div class="prices has-discount">\n            <span class="original-price">$'+(i=this.escapeExpression)("function"==typeof(s=t.original_price||e&&e.original_price)?s.call(e,{name:"original_price",hash:{},data:a}):s)+'</span> \n            <span class="sale-price">$'+i("function"==typeof(s=t.price||e&&e.price)?s.call(e,{name:"price",hash:{},data:a}):s)+"</span> \n        </div>\n        "},10:function(e,t,i,a){var s;return'\n        <div class="prices">\n            $'+(0,this.escapeExpression)("function"==typeof(s=t.price||e&&e.price)?s.call(e,{name:"price",hash:{},data:a}):s)+"\n        </div>\n        "},12:function(e,t,i,a){var s,n,r='\n    <div class="item-info">\n        <div class="image-container"><span class="helper"></span><img></div>\n        '+(i=this.escapeExpression)("function"==typeof(n=t.title||e&&e.title)?n.call(e,{name:"title",hash:{},data:a}):n)+'\n    </div>\n    <div class="item-price">\n        ';return((s=t.if.call(e,e&&e.has_discount,{name:"if",hash:{},fn:this.program(13,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+'\n        <span class="sale-price">$'+i("function"==typeof(n=t.price||e&&e.price)?n.call(e,{name:"price",hash:{},data:a}):n)+"</span>\n    </div>\n    "},13:function(e,t,i,a){var s;return'\n            <span class="original-price">$'+(0,this.escapeExpression)("function"==typeof(s=t.original_price||e&&e.original_price)?s.call(e,{name:"original_price",hash:{},data:a}):s)+"</span> \n        "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;return i='<div class="wrapper">\n    ',((s=t.if.call(e,e&&e.is_sale,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n\n    ",((s=t.if.call(e,e&&e.is_popular,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n\n    ",((s=t.if.call(e,e&&e.is_best,{name:"if",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n\n    ",((s=t.if.call(e,e&&e.showInDialog,{name:"if",hash:{},fn:this.program(7,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+="\n    ",((s=t.unless.call(e,e&&e.showInDialog,{name:"unless",hash:{},fn:this.program(12,a),inverse:this.noop,data:a}))||0===s)&&(i+=s),i+"\n</div>"},useData:!0})}(),b=function(e){var t=e.UiCore.UiContext;return t.extend("BuyCreditListItem",{uiContextName:"buy_credit_list_item",tagName:"article",className:"buy-credit-list-item",dependencies:"featureAccessManager globalStringManager googleAnalytics imageManager leanplum loginManager model".split(" "),trackedEvents:function(){return[{type:"click",name:"choose_credit_item",handler:"__selectItem"}]},initialize:function(e){this.__selectedCredit=e.selectedCredit,this.__model=e.model,this.__imageManager=e.imageManager,this.__loginManager=e.loginManager,this.__featureAccessManager=e.featureAccessManager,this.__style=IMVU.optionalProperty(e,"style",""),this.__bestOption=IMVU.optionalProperty(e,"bestOption",0),this.__isVip=this.__loginManager.getCurrentUser().get("is_vip"),this.__isInDialog="in-dialog"===this.__style,this.__isInStore=IMVU.optionalProperty(e,"isInStore",!1),this.__context=IMVU.optionalProperty(e,"context",null),this.__useImageAbsolutePath=IMVU.optionalProperty(e,"useImageAbsolutePath",!1),this.__checkedForSelectedItem=!1,this.__percentageOff=IMVU.optionalProperty(e,"percentageOff",void 0),t.prototype.initialize.call(this,e),this.__featureAccessManager.canSeeVIPSale()&&!this.__isVip&&this.__context&&this.listenTo(this.__context,"add_vip_item",this.__updateVIPSalePrice),this.__context&&this.listenTo(this.__context,"refresh_items",this.__refreshProduct),this.addToDOM()},render:function(){t.prototype.render.call(this),this.__model.populated().then(function(){this.__isVipSaleOn=this.__model.get("vip_price")<this.__model.get("independent_purchase_price"),this.__featureAccessManager.canSeeVIPSale()&&this.__isVipSaleOn?this.__price=this.__isVip?this.__model.get("vip_price"):this.__model.get("independent_purchase_price"):this.__price=this.__model.get("independent_purchase_price"),this.__renderTemplate(),!this.__checkedForSelectedItem&&this.__isInDialog&&this.__isBestOption()&&this.__selectItem(),this.__checkedForSelectedItem=!0}.bind(this))},__getImageSrc:function(e,t){return t?e:"/common/withme/img/store/"+e},__selectItem:function(){this.__isInStore?(this.__selectedCredit.set({name:this.__model.get("title"),sale_price:this.__model.get("independent_purchase_price"),price:this.__price,vip_price:this.__model.get("vip_price"),original_price:this.__model.get("original_price"),sku:this.__model.get("sku"),pid:this.__model.get("pid"),type:this.__model.get("type"),image:this.__model.get("image")}),this.__leanplum.recordEvent("select_credit_in_store",{sku:this.__model.get("sku"),pid:this.__model.get("pid"),price:this.__price}),this.__googleAnalytics.recordDollarStore("view",this.__model.get("sku")),this.__selectedCredit.trigger("click")):(this.$el.toggleClass("selected-item"),this.$el.hasClass("selected-item")?(e.NextUtil.DomHelper.radioClass(this.$el,"selected-item"),this.__selectedCredit.set({name:this.__model.get("title"),sale_price:this.__model.get("independent_purchase_price"),price:this.__price,vip_price:this.__model.get("vip_price"),original_price:this.__model.get("original_price"),sku:this.__model.get("sku"),pid:this.__model.get("pid"),type:this.__model.get("type"),image:this.__model.get("image")}),this.__leanplum.recordEvent("select_credit_in_list",{sku:this.__model.get("sku"),pid:this.__model.get("pid"),price:this.__price})):this.__selectedCredit.set({price:0}))},__isBestOption:function(){return parseInt(this.__model.get("sku").replace("imvu.next.credits.",""))===this.__bestOption},__updateVIPSalePrice:function(e){this.__isVipSaleOn&&((e=e?this.__model.get("vip_price"):this.__model.get("independent_purchase_price"))!=this.__price&&(this.__price=e,this.__renderTemplate()))},__refreshProduct:function(){this.__model.invalidate(),this.render()},__renderTemplate:function(){this.__hasDiscount=this.__model.get("original_price")>this.__price,this.$el.html(e.template({has_discount:this.__hasDiscount,original_price:this.__model.get("original_price").toFixed(2),price:this.__price.toFixed(2),title:this.__model.get("title"),is_sale:this.__hasDiscount||this.__percentageOff,sale_copy:this.__percentageOff?this.__percentageOff+"% "+this.__globalStringManager.get("OFF"):this.__globalStringManager.get("SALE"),is_best:!this.__hasDiscount&&this.__model.get("best"),is_popular:!this.__hasDiscount&&!this.__model.get("best")&&this.__model.get("popular"),showInDialog:this.__isInDialog})),(this.__hasDiscount||this.__model.get("best")||this.__model.get("popular"))&&this.$el.addClass("has-promo"),this.__imageManager.load(this.$(".image-container > img"),this.__getImageSrc(this.__model.get("image"),this.__useImageAbsolutePath))}})}({UiCore:e["@UiCore"],NextUtil:e["@NextUtil"],template:b}),v=function(e){var t=e.UiCore.ListPresenter;return t.extend("BuyCreditList",{uiContextName:"buy_credit_list",className:"buy-credit-list",tagName:"section",itemFactory:e.BuyCreditListItem,initialize:function(i){t.prototype.initialize.call(this,i),this.$el.prepend(e.template())}})}({UiCore:e["@UiCore"],BuyCreditListItem:b,template:v}),l=function(e){var t=e.Dialogs.AlloyModalDialog;return t.extend("BuyCreditDialog",{uiContextName:"buycredit_dialog",className:"buycredit-dialog dialog-type-B",dependencies:"restModelFactory Promise loginManager dialogManager globalStringManager globalStartupModel".split(" "),trackedEvents:function(){return[{type:"click",selector:".back-button",name:"back_to_checkout",handler:this.__backToCheckout}]},initialize:function(i){i=_.extend({includeBuyCredits:!0,includeBuyUpgrades:!1,includePromoCredits:!0},i),t.prototype.initialize.call(this,i),this.purchaseComplete=!1,this.serviceProvider=i.serviceProvider,this.dialogManager=i.dialogManager,this.__stringManager=i.globalStringManager,this.restModelFactory=i.restModelFactory,this.__myself=i.loginManager.getCurrentUser(),this.__totalAmount=IMVU.requireProperty(i,"totalAmount",0),this.__showAmount=0<this.__totalAmount,this.__bestOption=IMVU.optionalProperty(i,"bestOption",0),this.__includePromoCredits=i.includePromoCredits,this.includeBuyCredits=i.includeBuyCredits,this.__includeBuyUpgrades=i.includeBuyUpgrades,this.__formatNumber=e.FormatNumber,this.__storeCatalogUrl=i.globalStartupModel.get("storeCatalogUrl"),this.__storeCatalog=this.restModelFactory.readModel(this.__storeCatalogUrl,e.UiCore.NodeModel),this.title=this.__stringManager.get("buycredit_title"),this.__selectedCredit=new IMVU.NamedModel({price:0}),this.__selectedVip=new IMVU.NamedModel({price:0}),this.addToDOM(),this.listenTo(this,"add_vip_item",this.__toggleVIPPriceOnSelectedCredit)},destroy:function(){this.promiseResolver&&this.promiseResolver.resolve(this.purchaseComplete),this.hide(),this.delete()},show:function(){this.ppcRedeem&&this.ppcRedeem.trigger("clear_input"),t.prototype.show.call(this)},postRender:function(){this.__myself.populated().then(function(){return this.__wallet=this.__myself.getSingleEdge("wallet"),this.__wallet.populated()}.bind(this)).then(function(){return this.setContent("body",e.template,{amount:this.__formatNumber.formatCredits(this.__totalAmount),largeAmount:999<this.__totalAmount,showAmount:this.__showAmount}),this.$(".products-container").scrollbar(),this.setContent("auxHeader",e.headerCreditsTemplate,{}),this.createChildContext(e.CheckoutButton,{$parentElement:this.$(".dialog-footer"),selectedCredit:this.__selectedCredit,selectedVip:this.__selectedVip,globalStringManager:this.__stringManager,context:this}),this.ppcRedeem=this.createChildContext(e.PPCRedeem,{$parentElement:this.$(".ppc-redeem-placeholder")}),this.listenTo(this.ppcRedeem,"successfully_redeemed",this.destroy),this.listenTo(this.ppcRedeem,"redeem_failed",this.__onPPCRedeemFail),this.__updateCreditsDisplay(),this.listenTo(this.__wallet,"change",this.__updateCreditsDisplay),this.__storeCatalog.populated()}.bind(this)).then(function(e){return e.getEdgeCollection("items").populated()}.bind(this)).then(function(t){this.__storeCatalogItems=t,this.$(".buy-credit-list").remove(),this.$(".buy-upgrade-list").remove();for(var i=new IMVU.NamedCollection,a=new IMVU.NamedCollection,s=1e5,n=0;n<t.models.length;n++){if("credits"===(r=t.models[n].edge).get("type")){i.add(r);var r,o=(r=parseInt(r.get("sku").replace("imvu.next.credits.","")))-this.__totalAmount;0<o&&o<s&&(s=o,this.__bestOption=r)}else"vip"===r.get("type")&&a.add(r)}this.includeBuyCredits&&this.createChildContext(e.BuyCreditList,{$parentElement:this.$(".products"),collection:i,selectedCredit:this.__selectedCredit,style:"in-dialog",bestOption:this.__bestOption,context:this}),this.__includeBuyUpgrades&&!this.__myself.get("is_vip")&&this.createChildContext(e.BuyUpgradeList,{$parentElement:this.$(".products"),collection:a,selectedVip:this.__selectedVip,style:"in-credit-dialog",globalStringManager:this.__stringManager,context:this})}.bind(this))},__currentWealth:function(){return this.__includePromoCredits?parseInt(this.__wallet.get("credits"))+parseInt(this.__wallet.get("promo_credits")):parseInt(this.__wallet.get("credits"))},__updateCreditsDisplay:function(){this.$(".available-credits").text(this.__formatNumber.formatCredits(this.__currentWealth()))},__backToCheckout:function(){this.destroy()},__toggleVIPPriceOnSelectedCredit:function(e){0<this.__selectedCredit.get("price")&&((e=e?this.__selectedCredit.get("vip_price"):this.__selectedCredit.get("sale_price"))!=this.__selectedCredit.get("price")&&this.__selectedCredit.set({price:e}))},__onPPCRedeemFail:function(){this.$(".products-container").scrollTop(this.$(".products-container").height())}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],Model:e["@Model"],template:u,backButtonTemplate:m,headerCreditsTemplate:d,FormatNumber:c,creditsValueTemplate:h,BuyCreditList:v,CheckoutButton:l,BuyUpgradeList:p,PPCRedeem:f}),p=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<p class="items-purchased"></p>\n'},useData:!0})}(),p=function(e){var t=e.Dialogs.AlloyAlertDialog;return t.extend("SuccessDialog",{uiContextName:"checkout_success_dialog",className:"success-dialog",dependencies:["Promise","globalStringManager"],initialize:function(e){this.__globalStringManager=e.globalStringManager,e.title=e.globalStringManager.get("checkout_success_title"),e.ok=e.ok||e.globalStringManager.get("Continue Shopping"),e.checkbox=e.saveOutfit?e.globalStringManager.get("Save current outfit as Look"):void 0,t.prototype.initialize.call(this,e),this.Promise=e.Promise,this.__window=e.window,this.__itemsPurchased=e.itemsPurchased,this.__isStickerCheckout=IMVU.optionalProperty(e,"isStickerCheckout",!1),this.__stickerPackName=IMVU.optionalProperty(e,"stickerPackName",null),this.dialogManager=e.dialogManager,this.addToDOM()},postRender:function(){t.prototype.postRender.call(this),this.$(".dialog-body p").replaceWith(e.template),this.__isStickerCheckout?(this.$(".dialog-checkbox-container").hide(),this.$(".items-purchased").text(this.__globalStringManager.get("checkout_sticker_success_message",{stickerPackName:this.__stickerPackName}))):this.$(".items-purchased").text(this.__globalStringManager.getPluralized("checkout_success_message",{howMany:this.__itemsPurchased}))}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],template:p}),a=function(e){var t=e.Dialogs.AlloyModalDialog;return t.extend("CheckoutDialog",{uiContextName:"checkout_dialog",className:"checkout-dialog dialog-type-B",dependencies:"cart dialogManager featureAccessManager globalStartupModel globalStringManager googleAnalytics loginManager Promise restModelFactory window".split(" "),trackedEvents:function(){return[{type:"click",selector:".buy-now",name:"buy_now",handler:this.__buyNow},{type:"click",selector:".back-button",name:"back_button",handler:this.__goBack},{type:"click",selector:".vip-upsell.purchase-free",name:"vip_upsell",handler:this.__openVIPDialog}]},initialize:function(i){t.prototype.initialize.call(this,i),this.__cartListFactory=i.cartListFactory||e.CartList,this.__canSeeVipUpsell=this.__featureAccessManager.canSeeVipUpsell(),this.__successOk=IMVU.optionalProperty(i,"successOk",null),this.__myself=i.loginManager.getCurrentUser(),(this.__dressUpAvatarManager=IMVU.optionalProperty(i,"dressUpAvatarManager",null))&&(this.__lookModel=this.__dressUpAvatarManager.getLookModel()),this.__isStickerCheckout=IMVU.optionalProperty(i,"isStickerCheckout",!1),this.__stickerPackName=IMVU.optionalProperty(i,"stickerPackName",null),this.__useBackButton=IMVU.optionalProperty(i,"useBackButton",!1),this.__cart=i.cart,this.__itemsPurchased=this.__itemCount=this.__orderTotal=0,this.__virtualCartUrl=i.globalStartupModel.get("virtualCartUrl"),this.__cartOrderUrl=i.globalStartupModel.get("cartOrderUrl"),this.__googleAnalytics=i.googleAnalytics,this.__formatNumber=e.FormatNumber,this.title=this.__globalStringManager.get("checkout_title"),this.__vipDiscountAmount=0,this.addToDOM()},delete:function(){this.__cart&&this.__cart.each(function(e){e.set("also_tried_on",!1),e.set("is_worn_in_shop",!1)}),this.__tooltip&&this.__tooltip.delete(),t.prototype.delete.call(this)},__destroy:function(){this.hide(),this.delete()},postRender:function(){this.__isStickerCheckout&&this.$el.addClass("sticker-pack-checkout-dialog"),this.$el.toggleClass("is-vip",!!this.__myself.get("is_vip")),this.__myself.populated().then(function(){return this.__wallet=this.__myself.getSingleEdge("wallet"),this.__wallet.populated()}.bind(this)).then(function(){return this.__useBackButton&&(this.$(".dialog-header").prepend(e.backButtonTemplate({})),"mobile"===this.__serviceProvider.get("platform")&&this.$(".dialog-x").remove()),this.__lookModel?this.__lookModel.getChangePromise():this.__Promise.accept()}.bind(this)).then(function(){this.setContent("body",e.template,{isVip:!!this.__myself.get("is_vip"),canSeeVipUpsell:this.__canSeeVipUpsell&&!this.__myself.get("is_vip")}),this.$(".vip-tooltip")&&this.$(".icon-tooltip-icon")&&(this.__tooltip=this.__serviceProvider.create(e.Tooltip,{$replaceElement:this.$(".vip-tooltip"),$tooltipTarget:this.$(".icon-tooltip-icon"),trackedEvents:[{type:"click",selector:".cta",name:"buy_vip_tooltip_click",handler:this.__openVIPDialog.bind(this)}]})),this.setContent("auxHeader",e.headerCreditsTemplate,{}),this.setContent("footer",this.$(".dialog-footer-template").text()),this.__cart.markSelectedProducts(),this.__cart.comparator=function(e){return!e.get("is_selected")},this.__cart.sort();var t=!1;this.__cart.each(function(e){t||e.get("is_selected")||(t=!0,e.set("also_tried_on",!0))}),this.$(".cart-list-container").scrollbar(),this.__addCartList(),this.__updateCreditsDisplay(),this.__updateCartTotals(),this.__cart.each(function(e){this.listenTo(e,"change:is_selected",this.__updateCartTotals)}.bind(this)),this.listenTo(this.__wallet,"change",this.__onWalletChange),this.listenTo(this.__myself,"change:is_vip",this.__onVipStatusChange)}.bind(this))},__addCartList:function(){this.__cartList=this.createChildContext(this.__cartListFactory,{$replaceElement:this.$(".cart-list"),collection:this.__cart})},__currentWealth:function(){return this.__wallet.get("credits")+this.__wallet.get("promo_credits")},__updateCreditsDisplay:function(){this.$(".available-credits").text(this.__formatNumber.formatCredits(Number(this.__currentWealth())))},__onWalletChange:function(){this.__myself.get("is_vip")||this.__myself.invalidate(),this.__updateCreditsDisplay(),this.__updateVIPUpsellDisplay(),this.$("button.buy-now").prop("disabled",0===this.__itemCount)},__updateCartTotals:function(){var t=0;this.__vipDiscountAmount=this.__itemCount=0,this.__cart.models&&this.__Promise.every(this.__cart.models.map(function(i){if(i.get("is_selected"))if(this.__itemCount++,i.get("is_bundle")){t+=i.get("product_price"),this.__vipDiscountAmount+=i.get("product_price")-i.get("discount_price");var a=i.getEdgeCollection("subproducts",e.Model.ProductEdgeCollection);a.populated().then(function(){a.map(function(e){e.node.get("is_owned")&&80!=e.node.get("product_id")&&191!=e.node.get("product_id")&&(t-=e.node.get("product_price"),this.__vipDiscountAmount-=e.node.get("product_price")-e.node.get("discount_price"))}.bind(this)),this.__Promise.accept()}.bind(this))}else t+=i.get("product_price"),this.__vipDiscountAmount+=i.get("product_price")-i.get("discount_price"),this.__Promise.accept()}.bind(this))).then(function(){this.__orderTotal=t,this.__myself.get("is_vip")&&(this.__orderTotal-=this.__vipDiscountAmount),this.$(".order-subtotal .credits-value").text(this.__formatNumber.formatCredits(Number(t))),this.$(".vip-discount .credits-value").text(this.__formatNumber.formatCredits(Number(this.__vipDiscountAmount))),this.$(".order-total .credits-value").text(this.__formatNumber.formatCredits(Number(this.__orderTotal))),this.$(".item-count").text(this.__itemCount),this.$("button.buy-now").prop("disabled",0===this.__itemCount),this.$(".vip-upsell .price-off-amount").text(this.__formatNumber.formatCredits(Number(this.__vipDiscountAmount))),this.__orderTotal||!this.__isStickerCheckout?(this.$("button.buy-now").text(this.__globalStringManager.getPluralized("checkout_dialog_buy_now_message",{howMany:this.__itemCount,totalCredits:""})),this.$("button.buy-now").append(e.creditsValueTemplate({totalCredits:this.__formatNumber.formatCredits(Number(this.__orderTotal))}))):this.$("button.buy-now").text(this.__globalStringManager.get("GET IT FOR FREE")),this.__updateVIPUpsellDisplay()}.bind(this))},__updateVIPUpsellDisplay:function(){var e=Number(this.__wallet.get("promo_credits"));this.__orderTotal-this.__vipDiscountAmount<=5e3+e&&e<this.__orderTotal?(this.$(".vip-upsell.show-discount").hide(),this.$(".vip-upsell.purchase-free").show()):(this.$(".vip-upsell.show-discount").show(),this.$(".vip-upsell.purchase-free").hide())},__buyNow:function(){this.$(".buy-now").prop("disabled",!0),this.$(".buy-now").addClass("processing"),this.$(".dialog-x").prop("disabled",!0),this.__orderTotal>this.__currentWealth()?(this.$(".buy-now").prop("disabled",!1),this.$(".buy-now").removeClass("processing"),this.$(".dialog-x").removeAttr("disabled"),this.__displayBuyCreditDialog()):(this.__googleAnalytics.recordBuyAnItem("purchased"),this.__purchaseProducts().then(function(){this.__displaySuccessDialog()}.bind(this)).catch(function(e){return this.$(".buy-now").prop("disabled",!1),this.$(".buy-now").removeClass("processing"),this.$(".dialog-x").removeAttr("disabled"),this.__dialogManager.alert({title:this.__globalStringManager.get("checkout_error_title"),text:this.__globalStringManager.get("checkout_error_text"),ok:this.__globalStringManager.get("checkout_error_button")}).finished}.bind(this)))},__buyCreditsClicked:function(){this.__window.open("/store?platform="+this.__serviceProvider.get("storePlatform"))},__purchaseProducts:function(){var t=this.__getSelectedItems();return this.__restModelFactory.createModel(this.__cartOrderUrl,e.UiCore.NodeModel,{platform:"mobile"===this.__serviceProvider.get("platform")?"NEXT_SMALL":"NEXT_BIG",relations:{products:_.pluck(t.models,"id")}}).then(function(){this.__itemsPurchased=t.models.length}.bind(this))},__getSelectedItems:function(){var e=new Backbone.Collection;return this.__cart.each(function(t){t.get("is_selected")&&e.add(t)}.bind(this)),e},__commitCartPurchase:function(e){return e.populated().then(function(){return e.save({status:"COMMITTED",platform:"mobile"===this.__serviceProvider.get("platform")?"NEXT_SMALL":"NEXT_BIG"},{wait:!0})}.bind(this)).then(function(){var t=e.get("status");return"COMMITTED"===t?this.__Promise.resolve():"FAILED"===t?this.__Promise.reject({error:"cart commit failed"}):void 0}.bind(this))},__getPostBodyForCart:function(e,t){var i=[],a=[];return _.each(t,function(e){i.push({ref:e})}),e.each(function(e){a.push({ref:e.id})}),{relations:{recipients:i,products:a}}},__boughtAllWornProducts:function(){if(!this.__dressUpAvatarManager)return!1;var e=!1;return _.each(this.__cart.models,function(t){t.get("is_worn_in_shop")&&(e=!0,!0!==t.get("is_owned")&&(e=!1))}.bind(this)),e},__displaySuccessDialog:function(){return this.__dialogManager.showDialog(e.SuccessDialog,{itemsPurchased:this.__itemsPurchased,saveOutfit:this.__boughtAllWornProducts(),isStickerCheckout:this.__isStickerCheckout,stickerPackName:this.__stickerPackName,ok:this.__successOk}).finished.then(function(t){t&&t.checked&&(this.__dressUpAvatarManager.saveCurrentOutfit(),this.__myself.populated().then(function(){this.__myself.getEdgeCollection("outfits",e.Model.OutfitCollection).invalidate()}.bind(this))),this.promiseResolver.accept(),this.__destroy()}.bind(this)).catch(function(e){this.promiseResolver.accept(),this.__destroy()}.bind(this))},__displayBuyCreditDialog:function(){var t=this.__orderTotal-this.__currentWealth();this.__dialogManager.showDialog(e.BuyCreditDialog,{totalAmount:0<t?t:0})},__goBack:function(){this.promiseResolver.resolve(!0)},__openVIPDialog:function(){this.$(".available-credits").text(this.__globalStringManager.get("UPDATING")),this.$("button.buy-now").prop("disabled",!0),this.__dialogManager.showDialog(e.BuyUpgradeDialog,{}).finished.then(function(){}.bind(this)).catch(function(e){this.__updateCreditsDisplay(),this.$("button.buy-now").prop("disabled",0===this.__itemCount)}.bind(this))},__onVipStatusChange:function(){this.$(".checkout-container").remove(),this.setContent("body",e.template,{isVip:!!this.__myself.get("is_vip"),canSeeVipUpsell:this.__canSeeVipUpsell&&!this.__myself.get("is_vip")}),this.$el.toggleClass("is-vip",!!this.__myself.get("is_vip")),this.$(".cart-list-container").scrollbar(),this.__addCartList(),this.__updateCartTotals()}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],Model:e["@Model"],template:a,headerCreditsTemplate:d,CartList:g,VirtualCartNode:n,FormatNumber:c,SuccessDialog:p,creditsValueTemplate:h,BuyCreditDialog:l,BuyUpgradeDialog:o,backButtonTemplate:s,Tooltip:r}),s=IMVU.NamedCollection.extend("CartCollection",{markSelectedProducts:function(){this.each(function(e){e.set("is_selected",!0)}.bind(this))}}),n=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(e,t,i,a){var s;i=t.helperMissing;var n='\n    \t    <div class="order-row order-subtotal">';return((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Subtotal",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+=' <div class="order-row-credits credits-value"></div></div>\n    \t    <div class="order-row vip-discount">5% ',((s=(t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"VIP Discount",{name:"i18n-g",hash:{},data:a}))||0===s)&&(n+=s),n+' <div class="order-row-credits">-<span class="credits-value"></span></div></div>\n    \t'},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s,n;i=t.helperMissing;var r=this.escapeExpression,o='<div class="inner-dialog-body">\n    <div class="product gifting-section"></div>\n    <div class="failed-recipients gifting-section hidden">\n        <div class="gifting-title"></div>\n\n        <div class="recipient-info">\n    \t<div class="recipients-message"></div>\n    \t<div class="recipients-removed-message">';return((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"gifting_recipient_removed",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='</div>\n        </div>\n    </div>\n    <div class="recipient gifting-section">\n        <div class="gifting-title">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"gifting_dialog_title_recipient",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='</div>\n\n        <div class="recipient-info hidden">\n    \t<div class="recipients-count"></div>\n    \t<div class="recipients-message"></div>\n        </div>\n    </div>\n    <div class="add-message gifting-section">\n        <div class="gifting-title">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"gifting_dialog_title_add_message",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+='</div>\n        <textarea id="message" class="message" type="text" placeholder="Type something"></textarea>\n    </div>\n    <div class="order-totals gifting-section">\n    \t',((s=t.if.call(e,e&&e.isVip,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(o+=s),o+='\n    \t<div class="order-row order-total">',((s=(n=t["i18n-g"]||e&&e["i18n-g"]||i).call(e,"Total",{name:"i18n-g",hash:{},data:a}))||0===s)&&(o+=s),o+' (<span class=\'item-count\'></span>) <div class="order-row-credits credits-value"></div></div>\n    </div>\n    <div class="spacer'+r("function"==typeof(n=t.spaceHackClass||e&&e.spaceHackClass)?n.call(e,{name:"spaceHackClass",hash:{},data:a}):n)+'"></div>\n</div>\n\n<script type="text/template" class="dialog-footer-template">\n    <button class="btn btn-primary send-gift"></button>\n<\/script>'},useData:!0})}(),r=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<div class="back-button"></div>\n'},useData:!0})}(),o=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({1:function(){return'<button class="btn ap ap-badge"></button>'},3:function(e,t,i,a){var s;return"\n        <div class='name is-truncated'>"+(0,this.escapeExpression)("function"==typeof(s=t.name||e&&e.name)?s.call(e,{name:"name",hash:{},data:a}):s)+"</div>\n    "},5:function(){return"\n        <div class='creator'></div>\n    "},compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s,n,r="<div class='product-image' data-product-id="+(i=this.escapeExpression)("function"==typeof(n=t.product_id||e&&e.product_id)?n.call(e,{name:"product_id",hash:{},data:a}):n)+">\n    <img>\n    ";return((s=t.if.call(e,e&&e.isAp,{name:"if",hash:{},fn:this.program(1,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+="\n</div>\n\n<div class='product-details'>\n    ",((s=t.if.call(e,e&&e.name,{name:"if",hash:{},fn:this.program(3,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+="\n    ",((s=t.if.call(e,e&&e.creator,{name:"if",hash:{},fn:this.program(5,a),inverse:this.noop,data:a}))||0===s)&&(r+=s),r+"\n    <div class='price-credits'>"+i("function"==typeof(n=t.price||e&&e.price)?n.call(e,{name:"price",hash:{},data:a}):n)+"</div>\n</div>\n\n"},useData:!0})}(),o=function(e){var t=e.UiCore.UiContext;return t.extend("GiftingProduct",{tagName:"div",className:"gifting-product",uiContextName:"item",dependencies:["globalStringManager","loginManager","model"],initialize:function(i){t.prototype.initialize.call(this,i),this.model=i.model,this.loginManager=i.loginManager,this.myself=i.loginManager.getCurrentUser(),this.imageHeight=i.imageHeight?i.imageHeight:null,this.imageWidth=i.imageWidth?i.imageWidth:null,this.__formatNumber=e.FormatNumber,this.model.populated().then(function(){this.__creatorModel=this.model.getSingleEdge("creator"),this.__creatorModel.populated().then(function(){this.addToDOM()}.bind(this))}.bind(this))},render:function(){this.__getDetails(),this.$el.html(e.template(this.__getDetails())),this.$(".product-select").prop("checked",this.model.get("is_selected"));var t=this.model.get("preview_image");this.imageHeight&&this.imageWidth&&(t=IMVU.URI.build(t,{width:this.imageWidth,height:this.imageHeight})),this.$("img").attr({src:t}),void 0!==this.__creatorModel&&(this._displayName=this.createChildContext(e.Widgets.DisplayName,{$replaceElement:this.$(".creator"),user:this.__creatorModel,size:"tiny",color:"dark",showVipBadge:!1,prefix:this.__globalStringManager.get("created_by")}))},__getDetails:function(){return{name:this.model.get("product_name"),price:this.__formatNumber.formatCredits(Number(this.model.get("product_price"))),product_id:this.model.get("product_id"),creator:!0,isAp:"AP"===this.model.get("rating")}}})}({UiCore:e["@UiCore"],Widgets:e["@Widgets"],FormatNumber:c,template:o}),d=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<span class="by-line-text">\n    <span class="username"></span>\n</span>\n'},useData:!0})}(),d=function(e){var t=e.UiCore.UiContext;return t.extend("ByLineWidget",{className:"by-line-widget",uiContextName:"bylinewidget",tagName:"div",dependencies:["verbBy","model"],initialize:function(e){t.prototype.initialize.call(this,e),this.__hideOnlineStatus=!!e.hideOnlineStatus,this.__ignoreClicks=!!e.ignoreClicks,this.__hideUsername=!e.hasOwnProperty("hideUsername")||e.hideUsername,this.__useLargeProfile=!!e.useLargeProfile,this.__verbBy=IMVU.optionalProperty(e,"verbBy",null),this.addToDOM()},render:function(){this.$el.html(e.template()),this.__dualName=this.createChildContext(e.Widgets.DualName,{$replaceElement:this.$(".username"),user:this.model,hideIcon:!1,size:"medium",hideDisplay:!1,displayArgs:{size:"small",color:"dark",prefix:this.__verbBy},hideAtAvatar:this.__hideUsername,atAvatarArgs:{size:"small",color:"medium"}})}})}({UiCore:e["@UiCore"],Widgets:e["@Widgets"],template:d}),h=function(e){function t(e,t){var i=e.get("bootstrapParams").is_app;e.get("window").open(t,i?"_system":"_blank")}function i(e){return-1!==e.indexOf("iPad")||-1!==e.indexOf("iPhone")||-1!==e.indexOf("iPod")}return{openExternal:t,externalizeA:function(e,i){var a=$(i),s=a.attr("href");a.attr("href",""),a.click(function(){return t(e,s),!1})},isAndroid:function(e){return-1!==e.get("window").navigator.userAgent.indexOf("Android")},isAndroidChrome:function(e){return-1!==(e=e.get("window").navigator.userAgent).indexOf("Android")&&-1!==e.indexOf("Chrome/")&&-1===e.indexOf("Version/")},isAndroidWebApp:function(e){return!(-1===(e=e.get("window")).navigator.userAgent.indexOf("Android")||!e.navigator.standalone)},isIOS:function(e){return i(e=e.get("window").navigator.userAgent)},isIOSSafari:function(e){return!(!i(e=e.get("window").navigator.userAgent)||-1!==e.indexOf("CriOS/"))&&(-1!==e.indexOf("Safari/")||-1!==e.indexOf("AppleWebKit/")&&-1===e.indexOf("Chrome/"))},getVersionIOS:function(e){return i(e=e.get("window").navigator.userAgent)?null===(e=/(iphone|ipad)(; CPU)? OS ((\d+)_(\d+)(_(\d+))?)/i.exec(e))?null:{raw:e[3],major:parseInt(e[4],10),minor:parseInt(e[5],10),revision:e[7]?parseInt(e[7],10):null}:null}}}(),p=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(){return'<div class="available-credits credits-value"></div>\n'},useData:!0})}(),g=function(){var e=Handlebars.template;return Handlebars.templates=Handlebars.templates||{},e({compiler:[5,">= 2.0.0"],main:function(e,t,i,a){var s;return'<span class="credits-value">'+(0,this.escapeExpression)("function"==typeof(s=t.totalCredits||e&&e.totalCredits)?s.call(e,{name:"totalCredits",hash:{},data:a}):s)+"</span>"},useData:!0})}();return{CheckoutDialog:a,GiftingDialog:e=function(e){var t=e.Dialogs.AlloyModalDialog;return t.extend("GiftingDialog",{uiContextName:"gifting_dialog",className:"gifting-dialog dialog-type-B userpicker-dialog",dependencies:"Promise product dialogManager globalStartupModel globalStringManager googleAnalytics loginManager restModelFactory window featureAccessManager".split(" "),trackedEvents:function(){return[{type:"click",selector:".send-gift",name:"send_gift",handler:this.__sendGift},{type:"click",selector:".back-button",name:"back_button",handler:this.__goBack}]},initialize:function(i){if(t.prototype.initialize.call(this,i),this.Promise=i.Promise,this.__serviceProvider=i.serviceProvider,this.__window=i.window,this.__googleAnalytics=i.googleAnalytics,this.__dialogManager=i.dialogManager,this.__stringManager=i.globalStringManager,this.__restModelFactory=i.restModelFactory,this.__featureAccessManager=i.featureAccessManager,this.__product=i.product,i.hasOwnProperty("recipient"))this.__recipient=i.recipient;else{if(!i.hasOwnProperty("userPicker"))throw Error("Either recipient or userPicker is required");this.__userPicker=i.userPicker}this.__giftUrl=i.globalStartupModel.get("giftUrl"),this.__myself=i.loginManager.getCurrentUser(),this.__isVip=!!this.__myself.get("is_vip"),this.__formatNumber=e.FormatNumber,this.__itemsPurchased=this.__orderTotal=0,this.title=this.__stringManager.get("checkout_title"),this.addToDOM()},__destroy:function(){this.hide(),this.delete()},postRender:function(){this.__myself.populated().then(function(){return this.__wallet=this.__myself.getSingleEdge("wallet"),this.__wallet.populated()}.bind(this)).then(function(){this.setContent("body",e.template,{isVip:this.__isVip,spaceHackClass:e.MobileBrowser.isAndroid(this.__serviceProvider)?" is-android":""}),this.$(".dialog-header").prepend(e.backButtonTemplate({})),this.setContent("auxHeader",e.headerCreditsTemplate,{}),this.setContent("footer",this.$(".dialog-footer-template").text()),e.NextUtil.DomHelper.enhanceTextarea(this.$("#message"),500,44),this.__productDisplay=this.createChildContext(e.GiftingProduct,{$parentElement:this.$(".product"),imageWidth:80,imageHeight:80,model:this.__product}),this.__recipient?this.__recipientDisplay=this.createChildContext(e.ByLineWidget,{$parentElement:this.$(".recipient"),model:this.__recipient,verbBy:"",hideUsername:!0,ignoreClicks:!0}):(this.__failedRecipients=new Backbone.Collection,this.$(".failed-recipients").addClass("hidden"),this.__checkRecipients()),this.__updateCreditsDisplay(),this.__updateCartTotals(),this.listenTo(this.__wallet,"change",this.__updateCreditsDisplay),this.$(".inner-dialog-body").scrollbar()}.bind(this))},__updateRecipientsInfo:function(){var t=this.__userPicker.userCollection.models.length;if(this.$(".recipient .recipient-info .recipients-count").text(t),this.$(".recipient .recipient-info").toggleClass("hidden",1===t),this.__recipientDisplay&&this.__recipientDisplay.$el.toggleClass("hidden",1!==t),1<t){t=t-1;var i=this.__userPicker.userCollection.at(0);this.$(".recipient .recipient-info .recipients-message").text(this.__stringManager.getPluralized("gifting_recipient",{howMany:t,name:i.get("display_name")}))}else 1===t?(t=this.__userPicker.userCollection.at(0),this.__recipientDisplay=this.createChildContext(e.ByLineWidget,{$parentElement:this.$(".recipient"),model:t,verbBy:"",hideUsername:!0,ignoreClicks:!0}),this.__recipientDisplay.$el.removeClass("hidden")):this.$(".recipient .recipient-info .recipients-message").text(this.__stringManager.get("gifting_recipient_no_recipients"));this.__updateCreditsDisplay(),this.__updateCartTotals()},__checkRecipients:function(){return new this.Promise(function(e){this.__checkPurchase().then(function(){this.__updateRecipientsInfo(),e.resolve()}.bind(this)).catch(function(t){if("GIFT-003"===t.data.error_id)this.__updateRecipientsInfo(),this.__showTooFewCreditsDialog(),e.reject();else{var i=[];if(_.each(t.data.failed_recipients,function(e){var t=this.__userPicker.userCollection.find(function(t){return t.get("legacy_cid")===e.recipient_id});i.push(t),this.__userPicker.toggleUserInCollection(t),this.__failedRecipients.add({name:t.get("display_name")})}.bind(this)),0<i.length){t=i.length-1;var a=i[0];this.$(".failed-recipients .recipient-info .recipients-message").text(this.__stringManager.getPluralized("gifting_recipient_already_owns",{howMany:t,name:a.get("display_name")}))}this.$(".failed-recipients").toggleClass("hidden",0===this.__failedRecipients.models.length),this.__updateRecipientsInfo(),e.resolve()}}.bind(this))}.bind(this))},__currentWealth:function(){return parseInt(this.__wallet.get("credits"),10)},__updateCreditsDisplay:function(){this.$(".available-credits").text(this.__formatNumber.formatCredits(this.__currentWealth()))},__updateCartTotals:function(){var t=this.__userPicker?this.__userPicker.userCollection.models.length:1,i=this.__product.get("product_price")*t,a=this.__isVip?(this.__product.get("product_price")-this.__product.get("discount_price"))*t:0;this.__orderTotal=i-a,this.$(".order-subtotal .credits-value").text(this.__formatNumber.formatCredits(i)),this.$(".vip-discount .credits-value").text(this.__formatNumber.formatCredits(a)),this.$(".order-total .credits-value").text(this.__formatNumber.formatCredits(this.__orderTotal)),this.$(".item-count").text(t),this.$("button.send-gift").prop("disabled",0===t),this.$("button.send-gift").text(this.__stringManager.getPluralized("gifting_dialog_send_gift",{howMany:t,totalCredits:""})),this.$("button.send-gift").append(e.creditsValueTemplate({totalCredits:this.__formatNumber.formatCredits(this.__orderTotal)}))},__showTooFewCreditsDialog:function(){this.$(".send-gift").removeAttr("disabled"),this.$(".send-gift").removeClass("processing"),this.$(".dialog-x").removeAttr("disabled"),this.__displayBuyCreditDialog()},__displayBuyCreditDialog:function(){var t=this.__orderTotal-this.__currentWealth();return this.dialogManager.showDialog(e.BuyCreditDialog,{totalAmount:0<t?t:0}).finished.then(function(){}.bind(this)).catch(function(){}.bind(this))},__sendGift:function(){this.$(".send-gift").prop("disabled",!0),this.$(".send-gift").addClass("processing"),this.$(".dialog-x").prop("disabled",!0),this.__orderTotal>this.__currentWealth()?this.__showTooFewCreditsDialog():this.__checkPurchase().then(function(){return this.__purchaseProducts().then(function(){this.__googleAnalytics.recordBuyAnItem("purchased");var e=this.__userPicker?this.__userPicker.userCollection.models:[this.__recipient];return this.__dialogManager.alert({title:this.__stringManager.get("gifting_dialog_success_title"),text:this.__stringManager.getPluralized("gifting_dialog_success_text",{howMany:e.length-1,name:e[0].get("display_name")}),ok:this.__stringManager.get("gifting_dialog_success_ok")}).finished.catch(function(){return this.Promise.resolve()}.bind(this))}.bind(this)).then(function(){this.promiseResolver.resolve()}.bind(this)).catch(function(e){return this.$(".send-gift").removeAttr("disabled"),this.$(".send-gift").removeClass("processing"),this.$(".dialog-x").removeAttr("disabled"),this.__dialogManager.alert({title:this.__stringManager.get("checkout_error_title"),text:this.__stringManager.get("checkout_error_text"),ok:this.__stringManager.get("checkout_error_button")}).finished.then(function(){this.promiseResolver.reject()}.bind(this))}.bind(this))}.bind(this)).catch(function(e){return this.$(".send-gift").removeAttr("disabled"),this.$(".send-gift").removeClass("processing"),this.$(".dialog-x").removeAttr("disabled"),e=this.__recipient?this.__getErrorText(e.data.failed_recipients[0],this.__recipient):this.__stringManager.getPluralized("gifting_dialog_failed_recipients",{howMany:0}),this.__dialogManager.alert({title:this.__stringManager.get("checkout_error_title"),text:e,ok:this.__stringManager.get("checkout_error_button")}).finished.then(this.__failedPurchaseContinue.bind(this),this.__failedPurchaseContinue.bind(this)),this.Promise.reject()}.bind(this))},__failedPurchaseContinue:function(){this.__recipient?this.promiseResolver.resolve(!0):this.__checkRecipients()},__buyCreditsClicked:function(){this.__recordEvent("buy_credits",{record:!0},"not_enough_credits_dialog"),this.__window.open("/store?platform="+this.__serviceProvider.get("storePlatform"))},__checkPurchase:function(){var e;return e=this.__recipient?[this.__recipient.get("legacy_cid")]:this.__userPicker.userCollection.map(function(e){return e.get("legacy_cid")}.bind(this)),this.__myself.populated().then(function(){return this.__restModelFactory.simplePOST(this.__giftUrl+"?check",{sender_id:this.__myself.get("legacy_cid"),type_id:"product",item_id:this.__product.get("product_id"),giftwrap_id:0,recipients:e})}.bind(this)).then(function(e){return"failure"===e.data.result?this.Promise.reject(e):this.Promise.accept()}.bind(this))},__purchaseProducts:function(){var t;return this.__myself.populated().then(function(){return(t=this.__myself.searchEdgeCollection("conversations",{limit:0},e.Model.ConversationCollection)).populated()}.bind(this)).then(function(){var e={participants:this.__recipient?[this.__recipient.id]:this.__userPicker.userCollection.map(function(e){return e.id}.bind(this)),payloads:[{type:"gift",giftwrap:0,giftType:"product",giftId:this.__product.id}]},i=this.$(".add-message .message")[0].value;return i&&0<i.length&&e.payloads.push({type:"text",content:i}),t.create(e)}.bind(this))},__goBack:function(){this.promiseResolver.resolve(!0)},__getErrorText:function(e,t){var i={"GIFT-005":"gifting_recipient_no_ap","GIFT-006":"gifting_recipient_already_owns_none"}[e.reason_code];return i?this.__stringManager.get(i,{name:t.get("display_name")}):e.reason}})}({UiCore:e["@UiCore"],Dialogs:e["@Dialogs"],Model:e["@Model"],NextUtil:e["@NextUtil"],FormatNumber:c,ByLineWidget:d,GiftingProduct:o,template:n,creditsValueTemplate:g,backButtonTemplate:r,headerCreditsTemplate:p,MobileBrowser:h,BuyCreditDialog:l}),CartCollection:s}});